import{r as a,u as Qe,f as et,s as m,q as Ue,j as e,L as vt,F as Je,X as kt,t as wt,a as L,v as St,c as _t,d as jt,g as Nt,w as Vt,i as It,P as Ft,k as Pt,S as Ct,x as Dt,m as Mt,n as At,o as Lt,p as $t}from"./index-_JQw1_U5.js";import{u as Ut,U as Bt,o as Rt,c as zt,f as Ot,a as A,b as Et,P as qt,T as Ye,D as $e,M as Tt,F as Wt,C as Ht,e as Xt,d as Jt}from"./CommentSection-D5mhR6Je.js";import{C as Yt,D as Zt,a as Ze,M as Gt}from"./Modal-FRdsvUOx.js";import{a as Kt,f as Ge}from"./dateUtils-C4q4Gbs_.js";import{F as Qt}from"./FilterTabs-DREiyuTA.js";import{E as es}from"./ErrorState-BarOB6pw.js";import{F as ts}from"./fuse-Ch1WBRTM.js";const Ke=()=>{const s=new Date,x=s.getFullYear(),g=String(s.getMonth()+1).padStart(2,"0"),I=String(s.getDate()).padStart(2,"0");return`${x}-${g}-${I}`},K="CREATE_NEW_VERSION_SENTINEL_VALUE",ss=zt().shape({selectedSoftwareId:A().required("Software Product must be selected."),selectedVersionId:A().required("Version selection is required."),typedVersionString:A().when("selectedVersionId",{is:K,then:s=>s.required("New Version String is required when 'Enter New Version' is selected.").min(1),otherwise:s=>s.transform(x=>x===""?void 0:x).optional().nullable()}),patchName:A().required("Patch Name is required.").max(255,"Patch Name cannot exceed 255 characters."),releaseDate:A().transform(s=>s===""?void 0:s).optional().nullable(),inputMode:A().oneOf(["url","upload"]).required("Input mode must be selected."),externalUrl:A().when("inputMode",{is:"url",then:s=>s.required("External Download URL is required.").url("Please enter a valid URL."),otherwise:s=>s.optional().nullable()}),selectedFile:Et().when(["inputMode","$isEditMode","$patchToEditIsExternal"],{is:(s,x,g)=>s!=="upload"?!1:!!(!x||x&&g),then:s=>s.required("Please select a file to upload.").test("filePresent","File is required for upload.",x=>!!x),otherwise:s=>s.nullable()}),description:A().transform(s=>s===""?void 0:s).optional().max(2e3,"Description cannot exceed 2000 characters.").nullable(),patch_by_developer:A().transform(s=>s===""?void 0:s).optional().max(255,"Patch developer name cannot exceed 255 characters.").nullable(),compatibleVmsVersionIds:Ot().of(A().required()).optional()}),rs=({patchToEdit:s,onPatchAdded:x,onPatchUpdated:g,onCancelEdit:I})=>{const i=!!s,{register:u,handleSubmit:ce,control:Q,formState:{errors:d},watch:j,setValue:y,reset:$}=Ut({resolver:Rt(ss),context:{isEditMode:i,patchToEditIsExternal:(s==null?void 0:s.is_external_link)||!1},defaultValues:{selectedSoftwareId:"",selectedVersionId:"",typedVersionString:"",patchName:"",releaseDate:Ke(),description:"",inputMode:"url",externalUrl:"",selectedFile:null,patch_by_developer:"",compatibleVmsVersionIds:[]}}),[S,Y]=a.useState([]),[U,B]=a.useState([]),[ee,R]=a.useState([]),[me,z]=a.useState(!1),[te,F]=a.useState(null),[h,Z]=a.useState(!1),[G,q]=a.useState(!1),[Fe,ye]=a.useState(!1),[se,ve]=a.useState(0),[ue,P]=a.useState(!1),O=a.useRef(null),{isAuthenticated:E,user:fe}=Qe(),C=fe==null?void 0:fe.role,_=j("selectedSoftwareId"),ge=j("selectedVersionId"),re=j("inputMode"),V=j("selectedFile"),T=ge===K;a.useEffect(()=>{const r=f=>{ue&&(f.preventDefault(),f.returnValue="")};return window.addEventListener("beforeunload",r),()=>{window.removeEventListener("beforeunload",r)}},[ue]),a.useEffect(()=>{E&&(C==="admin"||C==="super_admin")&&(q(!0),et().then(Y).catch(()=>m("Failed to load software list.")).finally(()=>q(!1)))},[E,C]),a.useEffect(()=>{if(_&&S.length>0){q(!0),B([]),y("selectedVersionId",""),y("typedVersionString","");const r=S.find(f=>f.id.toString()===_);if(r&&(r.name==="VMS"||r.name==="VA")){z(!0);const f=S.find(p=>p.name==="VMS");f?(ye(!0),Ue(f.id).then(R).catch(()=>m("Failed to load VMS versions for compatibility.")).finally(()=>ye(!1))):R([])}else z(!1),R([]);Ue(parseInt(_)).then(B).catch(()=>m("Failed to load versions.")).finally(()=>q(!1))}else B([]),z(!1),R([]),y("selectedVersionId",""),y("typedVersionString","")},[_,y,S]),a.useEffect(()=>{if(i&&s&&S.length>0){const r=S.find(N=>N.id===s.software_id),f=!!r&&(r.name==="VMS"||r.name==="VA");z(f);const p={selectedSoftwareId:s.software_id.toString(),patchName:s.patch_name,releaseDate:s.release_date?s.release_date.split("T")[0]:"",description:s.description||"",inputMode:s.is_external_link?"url":"upload",externalUrl:s.is_external_link?s.download_link:"",patch_by_developer:s.patch_by_developer||"",compatibleVmsVersionIds:f&&s.compatible_vms_versions?s.compatible_vms_versions.map(String):[]};s.version_id&&s.software_id.toString()===_&&U.length>0?U.find(D=>D.id===s.version_id)?(p.selectedVersionId=s.version_id.toString(),p.typedVersionString=s.version_number):(p.selectedVersionId=K,p.typedVersionString=s.version_number):s.version_number&&(p.selectedVersionId=K,p.typedVersionString=s.version_number),$(p),s.is_external_link?F(null):F(s.original_filename_ref||s.download_link.split("/").pop()||"unknown_file"),y("selectedFile",null),O.current&&(O.current.value="")}else i||ae(!!_)},[i,s,U,_,$,y,S]);const ae=(r=!1)=>{const f=r?j("selectedSoftwareId"):"";$({selectedSoftwareId:f,selectedVersionId:"",typedVersionString:"",patchName:"",releaseDate:Ke(),description:"",inputMode:"url",externalUrl:"",selectedFile:null,patch_by_developer:"",compatibleVmsVersionIds:[]}),F(null),O.current&&(O.current.value="")},le=r=>{r.target.files&&r.target.files[0]?(y("selectedFile",r.target.files[0],{shouldValidate:!0,shouldDirty:!0}),F(null)):y("selectedFile",null,{shouldValidate:!0,shouldDirty:!0})},ke=()=>{y("selectedFile",null,{shouldValidate:!0,shouldDirty:!0}),O.current&&(O.current.value=""),i&&s&&!s.is_external_link&&F(s.original_filename_ref||s.download_link.split("/").pop()||"unknown_file")},we=async r=>{var D,xe,Se,v,H,he;Z(!0),r.inputMode==="upload"&&r.selectedFile&&P(!0),ve(0);let f,p;r.selectedVersionId===K&&r.typedVersionString?p=r.typedVersionString.trim():r.selectedVersionId&&r.selectedVersionId!==K&&(f=parseInt(r.selectedVersionId));const N={software_id:parseInt(r.selectedSoftwareId),patch_name:r.patchName.trim(),description:((D=r.description)==null?void 0:D.trim())||void 0,release_date:r.releaseDate||void 0,patch_by_developer:((xe=r.patch_by_developer)==null?void 0:xe.trim())||void 0};f&&(N.version_id=f),p&&(N.typed_version_string=p),me&&r.compatibleVmsVersionIds&&r.compatibleVmsVersionIds.length>0&&(N.compatible_vms_version_ids=r.compatibleVmsVersionIds);try{let k;if(r.inputMode==="url"){const X={...N,download_link:r.externalUrl.trim(),is_external_link:!0};i&&s?(k=await wt(s.id,X),L(`Patch "${k.patch_name}" updated successfully!`),g&&g(k)):(k=await St(X),L(`Patch "${k.patch_name}" added successfully!`),x&&x(k),i||(ae(!0),y("selectedVersionId",""),y("typedVersionString","")))}else{if(!r.selectedFile){if(i&&s&&!s.is_external_link&&!r.selectedFile){m("To update metadata of an existing uploaded patch without re-uploading, use a different form/feature. To replace the file, select a new file."),Z(!1);return}if(!r.selectedFile&&!i){m("No file selected for upload."),Z(!1);return}}const X={software_id:r.selectedSoftwareId,...f&&{version_id:f.toString()},...p&&{typed_version_string:p},patch_name:r.patchName.trim(),...r.releaseDate&&{release_date:r.releaseDate},description:((Se=r.description)==null?void 0:Se.trim())||"",patch_by_developer:((v=r.patch_by_developer)==null?void 0:v.trim())||"",...me&&r.compatibleVmsVersionIds&&r.compatibleVmsVersionIds.length>0&&{compatible_vms_version_ids_json:JSON.stringify(r.compatibleVmsVersionIds)}};k=await _t(r.selectedFile,"patch",X,_e=>ve(_e)),L(`Patch "${k.patch_name}" added successfully via chunked upload!`),x&&x(k),ae(!0),y("selectedVersionId",""),y("typedVersionString","")}}catch(k){const X=((he=(H=k.response)==null?void 0:H.data)==null?void 0:he.msg)||k.message||`Failed to ${i&&r.inputMode==="url"?"update":"add"} patch.`;m(X),r.inputMode==="upload"&&P(!1)}finally{Z(!1),r.inputMode==="upload"&&P(!1)}},W=r=>{console.error("Form validation errors:",r),m("Please correct the errors highlighted in the form.")};return!E||!C||!["admin","super_admin"].includes(C)?null:e.jsxs("form",{onSubmit:ce(we,W),className:"space-y-6 bg-white dark:bg-gray-800 dark:border-gray-700 p-6 rounded-lg shadow-md border border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-800 dark:text-gray-100",children:i?"Edit Patch":"Add New Patch"}),i&&I&&e.jsx("button",{type:"button",onClick:I,className:"text-sm text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200",children:"Cancel"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedSoftwareId",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Software Product*"}),G&&!S.length?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading software..."}):e.jsxs("select",{id:"selectedSoftwareId",...u("selectedSoftwareId"),disabled:h||G&&!S.length,className:`mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${d.selectedSoftwareId?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",disabled:!0,children:"Select Software Product"}),S.map(r=>e.jsx("option",{value:r.id.toString(),children:r.name},r.id))]}),d.selectedSoftwareId&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:d.selectedSoftwareId.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedVersionId",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Version*"}),e.jsx("div",{className:"mt-1",children:e.jsxs("select",{id:"selectedVersionId",...u("selectedVersionId"),disabled:h||G||!_,className:`block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${d.selectedVersionId?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",disabled:U.length>0&&!!_,children:G&&_?"Loading versions...":"Select Existing Version"}),U.map(r=>e.jsx("option",{value:r.id.toString(),children:r.version_number},r.id)),e.jsx("option",{value:K,children:"Enter New Version String..."})]})}),T&&e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{htmlFor:"typedVersionString",className:"block text-xs font-medium text-gray-600 dark:text-gray-400",children:"New Version String*:"}),e.jsx("input",{type:"text",id:"typedVersionString",...u("typedVersionString"),placeholder:"e.g., 2.5.1-hotfix",className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.typedVersionString?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"This version will be created for the selected software if it doesn't exist."})]}),d.selectedVersionId&&!T&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.selectedVersionId.message}),d.typedVersionString&&T&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.typedVersionString.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"patchName",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Patch Name*"}),e.jsx("input",{type:"text",id:"patchName",...u("patchName"),disabled:h,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.patchName?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),d.patchName&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.patchName.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"releaseDate",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Release Date"}),e.jsx("input",{type:"date",id:"releaseDate",...u("releaseDate"),disabled:h,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.releaseDate?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`}),d.releaseDate&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.releaseDate.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"patch_by_developer",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Patch By Developer"}),e.jsx("input",{type:"text",id:"patch_by_developer",...u("patch_by_developer"),disabled:h,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.patch_by_developer?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),d.patch_by_developer&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.patch_by_developer.message})]}),me&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"compatibleVmsVersionIds",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Compatible VMS Versions (for VMS/VA Patches)"}),Fe?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading VMS versions..."}):e.jsx("select",{multiple:!0,id:"compatibleVmsVersionIds",...u("compatibleVmsVersionIds"),className:"mt-1 block w-full h-32 pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600",disabled:h||!ee.length,children:ee.map(r=>e.jsx("option",{value:r.id.toString(),children:r.version_number},r.id))}),d.compatibleVmsVersionIds&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.compatibleVmsVersionIds.message}),e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"Select VMS versions this patch is compatible with. Only applicable if the patch is for 'VMS' or 'VA' software."})]}),e.jsxs("div",{className:"my-4",children:[e.jsx("span",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Patch Source:"}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",...u("inputMode"),value:"url",className:"form-radio h-4 w-4 text-blue-600",disabled:h}),e.jsxs("span",{className:"flex items-center dark:text-gray-300",children:[e.jsx(vt,{size:16,className:"mr-1 text-gray-600 dark:text-gray-400"}),"Provide External Link"]})]}),e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",...u("inputMode"),value:"upload",className:"form-radio h-4 w-4 text-blue-600",disabled:h}),e.jsxs("span",{className:"flex items-center dark:text-gray-300",children:[e.jsx(Bt,{size:16,className:"mr-1 text-gray-600 dark:text-gray-400"}),"Upload File"]})]})]}),d.inputMode&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.inputMode.message})]}),re==="url"&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"externalUrl",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"External Download URL*"}),e.jsx("input",{type:"url",id:"externalUrl",...u("externalUrl"),placeholder:"https://example.com/patch.exe",disabled:h,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.externalUrl?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),d.externalUrl&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.externalUrl.message})]}),re==="upload"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:i&&te&&!V?"Replace File (Optional)":"Select File to Upload*"}),e.jsx("div",{className:"mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-blue-500 dark:border-gray-600 dark:hover:border-blue-400 transition-colors",children:e.jsxs("div",{className:"space-y-1 text-center",children:[e.jsx(Je,{className:"mx-auto h-12 w-12 text-gray-400 dark:text-gray-500"}),e.jsxs("div",{className:"flex text-sm text-gray-600 dark:text-gray-400",children:[e.jsxs("label",{htmlFor:"patch-file-upload-input",className:"relative cursor-pointer bg-white dark:bg-gray-800 rounded-md font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500",children:[e.jsx("span",{children:V?"Change file":"Upload a file"}),e.jsx("input",{id:"patch-file-upload-input",name:"patch-file-input",type:"file",className:"sr-only",onChange:le,ref:O,disabled:h})]}),e.jsx("p",{className:"pl-1",children:"or drag and drop"})]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"EXE, MSI, ZIP, etc."})]})}),(V||i&&te)&&e.jsxs("div",{className:"mt-3 flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md",children:[e.jsxs("div",{className:"flex items-center space-x-2 overflow-hidden",children:[e.jsx(Je,{size:18,className:"text-gray-500 dark:text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:V?V.name:te}),i&&te&&!V&&e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 ml-2",children:"(current)"})]}),V&&e.jsx("button",{type:"button",onClick:ke,disabled:h,className:"p-1 rounded-full text-gray-400 hover:text-gray-600 hover:bg-gray-200 dark:text-gray-500 dark:hover:text-gray-300 dark:hover:bg-gray-600",children:e.jsx(kt,{size:16})})]}),d.selectedFile&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.selectedFile.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Description"}),e.jsx("textarea",{id:"description",rows:3,...u("description"),disabled:h,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.description?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),d.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.description.message})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{type:"submit",disabled:h||G,className:"flex-1 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",children:h?i?"Updating...":"Adding...":i?"Update Patch":"Add Patch"}),i&&I&&e.jsx("button",{type:"button",onClick:I,disabled:h,className:"flex-1 inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 dark:border-gray-500 dark:text-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600",children:"Cancel"})]}),h&&re==="upload"&&se>0&&e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 my-3 relative",children:[e.jsx("div",{className:"bg-blue-600 h-4 rounded-full transition-all duration-150 ease-out",style:{width:`${se}%`}}),e.jsxs("p",{className:"absolute inset-0 text-center text-xs font-medium leading-4 text-white dark:text-gray-100",children:[Math.round(se),"%"]})]})]})},ms=()=>{const{searchTerm:s,setSearchTerm:x}=jt(),{isAuthenticated:g,user:I}=Qe(),i=I==null?void 0:I.role,[u,ce]=a.useState([]),[Q,d]=a.useState([]),[j,y]=a.useState(null),[$,S]=a.useState(""),[Y,U]=a.useState(""),[B,ee]=a.useState(""),[R,me]=a.useState(""),[z,te]=a.useState(""),[F,h]=a.useState(""),[Z,G]=a.useState(1),[q,Fe]=a.useState(15),[ye,se]=a.useState(0),[ve,ue]=a.useState(0),[P,O]=a.useState("patch_name"),[E,fe]=a.useState("asc"),[C,_]=a.useState(!0),[ge,re]=a.useState(null),[V,T]=a.useState(!1),[ae,le]=a.useState(null),[ke,we]=a.useState(!1),[W,r]=a.useState(null),[f,p]=a.useState(!1),[N,D]=a.useState(new Map),[xe,Se]=a.useState(!1),[v,H]=a.useState(new Set),[he,k]=a.useState(!1),[X,_e]=a.useState(!1),[oe,Be]=a.useState(!1),[Re,je]=a.useState(!1),[ne,Pe]=a.useState(null),[Ce,ze]=a.useState([]),[Ne,Ve]=a.useState(null),[Oe,De]=a.useState(!1),[Me,Ee]=a.useState(!1),[w,pe]=a.useState(null),Ie=a.useRef(null),qe=Nt(),Ae=a.useMemo(()=>j!==null||$!==""||Y!==""||B!==""||s!=="",[j,$,Y,B,s]),tt=a.useCallback(()=>{y(null),S(""),U(""),ee(""),x&&x("")},[x]),st=()=>{M(1,!0)},rt=()=>{S(""),U(""),ee("")},M=a.useCallback(async(t,o=!1)=>{var l,c;o&&_(!0),re(null);try{const n=await Vt(j??void 0,t,q,P,E,R||void 0,z||void 0,F||void 0,s);ce(n.patches),se(n.total_pages),ue(n.total_patches),G(n.page),Fe(n.per_page);const b=new Map;if(g&&n.patches)for(const be of n.patches)b.set(be.id,{favoriteId:be.favorite_id});D(b)}catch(n){const b=((c=(l=n.response)==null?void 0:l.data)==null?void 0:c.msg)||n.message||"Failed to fetch patches.";o?(re(b),ce([]),se(0),ue(0)):m(b)}finally{o&&_(!1)}},[j,q,P,E,R,z,F,g,s]);a.useEffect(()=>{const t=setTimeout(()=>me($),500);return()=>clearTimeout(t)},[$]),a.useEffect(()=>{const t=setTimeout(()=>te(Y),500);return()=>clearTimeout(t)},[Y]),a.useEffect(()=>{const t=setTimeout(()=>h(B),500);return()=>clearTimeout(t)},[B]),a.useEffect(()=>{g?M(1,!0):(ce([]),_(!1))},[g,j,P,E,R,z,F,s,M]),a.useEffect(()=>{const t=new URLSearchParams(qe.search),o=t.get("item_id"),l=t.get("comment_id");if(o&&l&&u.length>0){const c=parseInt(o,10);if(!isNaN(c)){const n=u.find(b=>b.id===c);n?((!w||w.id!==n.id)&&pe(n),setTimeout(()=>{var b;(b=Ie.current)==null||b.scrollIntoView({behavior:"smooth",block:"center"})},100)):console.warn(`PatchesView: Patch with item_id ${c} not found in the current list.`)}}},[qe.search,u,w]),a.useEffect(()=>{H(new Set)},[j,P,E,R,z,F,s,Z]),a.useEffect(()=>{g&&et().then(d).catch(t=>m("Failed to load software list."))},[g]),a.useEffect(()=>{ne?(Ee(!0),Ue(ne).then(ze).catch(()=>m("Failed to load versions for move target.")).finally(()=>Ee(!1))):ze([])},[ne]);const at=t=>y(t),lt=t=>{O(t),fe(o=>P===t&&o==="asc"?"desc":"asc")},ot=t=>M(t,!0),Te=t=>{T(!1),le(null),M(1,!0)},nt=()=>{le(null),T(!0)},dt=t=>{le(t),T(!0),window.scrollTo({top:0,behavior:"smooth"})},We=()=>{le(null),T(!1)},it=t=>{r(t),we(!0)},Le=()=>{r(null),we(!1)},ct=async()=>{if(W){p(!0),w&&w.id===W.id&&pe(null);try{await Dt(W.id),L(`Patch "${W.patch_name}" deleted.`),Le(),M(1,!0)}catch(t){m(t.message||"Delete failed."),Le()}finally{p(!1)}}},He=a.useMemo(()=>s?new ts(u,{keys:["patch_name","description","software_name","version_number","uploaded_by_username","updated_by_username"],includeScore:!0,threshold:.4}).search(s).map(o=>o.item):u,[u,s]),mt=(t,o)=>H(l=>{const c=new Set(l);return o?c.add(t):c.delete(t),c}),ut=t=>{const o=new Set;t&&He.forEach(l=>o.add(l.id)),H(o)},ft=()=>{if(v.size===0){m("No items selected.");return}De(!0)},gt=async()=>{De(!1),k(!0),w&&v.has(w.id)&&pe(null);try{const t=await Mt(Array.from(v),"patch");L(t.msg||`${t.deleted_count} patch(es) deleted.`),H(new Set),M(1,!0)}catch(t){m(t.message||"Bulk delete failed.")}finally{k(!1)}},xt=async()=>{if(v.size===0){m("No items selected.");return}const t=u.filter(l=>v.has(l.id)&&!l.is_external_link&&l.is_downloadable!==!1);if(t.length===0){m("No downloadable patch files selected. External links or non-downloadable items cannot be bulk downloaded.");return}const o=t.map(l=>l.id);_e(!0);try{const l=await Pt(o,"patch"),c=URL.createObjectURL(l),n=document.createElement("a");n.href=c;const b=new Date().toISOString().replace(/:/g,"-");n.download=`bulk_download_patches_${b}.zip`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(c),o.length===v.size?L("Download started for all selected downloadable patches."):L(`Starting download for ${o.length} patch file(s). External links or non-downloadable items were excluded.`)}catch(l){m(l.message||"Bulk download failed.")}finally{_e(!1)}},ht=()=>{if(v.size===0){m("No items selected.");return}if(Q.length===0){m("Software list unavailable.");return}Pe(null),Ve(null),je(!0)},pt=async()=>{if(!Ne){m("Select target version.");return}je(!1),Be(!0);try{const t=await At(Array.from(v),"patch",{target_version_id:Ne});L(t.msg||`${t.moved_count} patch(es) moved.`),H(new Set),M(1,!0)}catch(t){if(t.response&&t.response.data&&t.response.data.conflicted_items&&Array.isArray(t.response.data.conflicted_items)&&t.response.data.conflicted_items.length>0&&(t.response.status===400||t.response.status===207)){let o="Bulk move could not be completed for some patches due to naming conflicts. ";const l=t.response.data.conflicted_items,c=l.slice(0,3).map(n=>`"${n.name}" (ID ${n.id})`).join(", ");o+=`Conflicting items: ${c}`,l.length>3&&(o+=` and ${l.length-3} more.`),o+=" Please rename the patches or check the target version.",m(o),t.response.data.msg}else t.message?m(t.message):m("Bulk move failed due to an unexpected error.")}finally{Be(!1),Pe(null),Ve(null)}},bt=[{key:"patch_name",header:"Patch Name",sortable:!0},{key:"software_name",header:"Software",sortable:!0},{key:"version_number",header:"Version",sortable:!0},{key:"patch_by_developer",header:"Developer",sortable:!0,render:t=>t.patch_by_developer||"-"},{key:"compatible_vms_versions",header:"VMS Compatibility",sortable:!0,render:t=>t.software_name==="VMS"||t.software_name==="VA"?t.compatible_vms_versions&&t.compatible_vms_versions.length>0?Array.isArray(t.compatible_vms_versions)?t.compatible_vms_versions.join(", "):typeof t.compatible_vms_versions=="string"?t.compatible_vms_versions:"N/A":"N/A":"-"},{key:"description",header:"Description",render:t=>e.jsx("span",{className:"text-sm text-gray-600 block max-w-xs truncate",title:t.description||"",children:t.description||"-"})},{key:"release_date",header:"Release Date",sortable:!0,render:t=>Kt(t.release_date)},{key:"download_link",header:"Link",render:t=>{var l;const o=t.is_external_link||t.is_downloadable!==!1;return!o&&!t.is_external_link?e.jsxs("span",{className:"flex items-center text-gray-400 cursor-not-allowed",title:"Download not permitted",children:[e.jsx($e,{size:14,className:"mr-1"}),"Link"]}):e.jsxs("a",{href:t.download_link,target:t.is_external_link||!((l=t.download_link)!=null&&l.startsWith("/"))?"_blank":"_self",rel:"noopener noreferrer",className:`flex items-center ${o?"text-blue-600 hover:text-blue-800":"text-gray-400 cursor-not-allowed"}`,onClick:c=>{o||c.preventDefault(),c.stopPropagation()},title:o?t.is_external_link?"Open external link":"Download patch":"Download not permitted",children:[e.jsx($e,{size:14,className:"mr-1"}),"Link"]})}},{key:"uploaded_by_username",header:"Uploaded By",sortable:!0,render:t=>t.uploaded_by_username||"N/A"},{key:"updated_by_username",header:"Updated By",sortable:!1,render:t=>t.updated_by_username||"N/A"},{key:"created_at",header:"Created At",sortable:!0,render:t=>Ge(t.created_at??"")},{key:"updated_at",header:"Updated At",sortable:!0,render:t=>Ge(t.updated_at??"")},{key:"actions",header:"Actions",render:t=>{var o,l,c;return e.jsxs("div",{className:"flex space-x-1 items-center",children:[g&&e.jsx("button",{onClick:n=>{n.stopPropagation(),yt(t,"patch")},className:`p-1 rounded-md ${(o=N.get(t.id))!=null&&o.favoriteId?"text-yellow-500 hover:text-yellow-600":"text-gray-400 hover:text-yellow-500"}`,title:(l=N.get(t.id))!=null&&l.favoriteId?"Remove Favorite":"Add Favorite",children:e.jsx(Ct,{size:16,className:(c=N.get(t.id))!=null&&c.favoriteId?"fill-current":""})}),g&&e.jsxs("button",{onClick:n=>{n.stopPropagation(),w&&w.id===t.id?pe(null):(pe(t),setTimeout(()=>{var b;return(b=Ie.current)==null?void 0:b.scrollIntoView({behavior:"smooth"})},0))},className:"p-1 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 rounded-md",title:w&&w.id===t.id?"Hide Comments":"View Comments",children:[e.jsx(Xt,{size:16}),e.jsxs("span",{className:"ml-1 text-xs",children:["(",t.comment_count??0,")"]})]}),(i==="admin"||i==="super_admin")&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:n=>{n.stopPropagation(),dt(t)},className:"p-1 text-blue-600 hover:text-blue-800 rounded-md",title:"Edit",children:e.jsx(Jt,{size:16})}),e.jsx("button",{onClick:n=>{n.stopPropagation(),it(t)},className:"p-1 text-red-600 hover:text-red-800 rounded-md",title:"Delete",children:e.jsx(Ye,{size:16})})]})]})}}],Xe=a.useCallback(()=>{M(1,!0)},[M]),yt=async(t,o)=>{var b,be;if(!g){m("Please log in to manage favorites.");return}const l=N.get(t.id),c=!!(l!=null&&l.favoriteId),n=new Map(N);c?n.set(t.id,{favoriteId:void 0}):n.set(t.id,{favoriteId:-1}),D(n);try{if(c&&typeof(l==null?void 0:l.favoriteId)=="number")await Lt(t.id,o),L(`"${t.patch_name}" removed from favorites.`),D(J=>{const de=new Map(J);return de.set(t.id,{favoriteId:void 0}),de});else{const J=await $t(t.id,o);D(de=>{const ie=new Map(de);return ie.set(t.id,{favoriteId:J.id}),ie}),L(`"${t.patch_name}" added to favorites.`)}}catch(J){m(((be=(b=J==null?void 0:J.response)==null?void 0:b.data)==null?void 0:be.msg)||J.message||"Failed to update favorite."),D(de=>{const ie=new Map(de);return c?ie.set(t.id,{favoriteId:l==null?void 0:l.favoriteId}):ie.set(t.id,{favoriteId:void 0}),ie})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-start sm:items-center mb-6 flex-col sm:flex-row",children:[e.jsxs("div",{children:[" ",e.jsx("h2",{className:"text-2xl font-bold text-gray-800 dark:text-white",children:"Patches"})," ",e.jsx("p",{className:"text-gray-600 mt-1 dark:text-gray-300",children:"Browse and manage software patches."})," "]}),g&&(i==="admin"||i==="super_admin")&&!ae&&e.jsxs("button",{onClick:V?We:nt,className:"mt-4 sm:mt-0 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx(qt,{size:18,className:"mr-2"})," ",V?"Cancel":"Add New Patch"]})]}),V&&e.jsxs("div",{className:"my-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow",children:[" ",e.jsx(rs,{patchToEdit:ae,onPatchAdded:()=>Te(),onPatchUpdated:()=>Te(),onCancelEdit:We})," "]}),v.size>0&&e.jsx("div",{className:"my-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:[v.size," item(s) selected"]}),(i==="admin"||i==="super_admin")&&e.jsxs("button",{onClick:ft,disabled:he,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-800 focus:ring-red-500 disabled:opacity-50",children:[e.jsx(Ye,{size:14,className:"mr-1.5"}),"Delete"]}),g&&e.jsxs("button",{onClick:xt,disabled:X,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-green-500 hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 focus:ring-green-500 disabled:opacity-50",children:[e.jsx($e,{size:14,className:"mr-1.5"}),"Download"]}),(i==="admin"||i==="super_admin")&&e.jsxs("button",{onClick:ht,disabled:oe,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 focus:ring-blue-500 disabled:opacity-50",children:[e.jsx(Tt,{size:14,className:"mr-1.5"}),"Move"]})]})}),Q.length>0&&e.jsx(Qt,{software:Q,selectedSoftwareId:j,onSelectFilter:at}),e.jsx("div",{className:"my-4",children:e.jsxs("button",{onClick:()=>Se(t=>!t),className:"flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-md text-sm font-medium",children:[xe?e.jsxs(e.Fragment,{children:[e.jsx(Yt,{size:18,className:"mr-2"}),"Hide"]}):e.jsxs(e.Fragment,{children:[e.jsx(Wt,{size:18,className:"mr-2"}),"Show"]})," Advanced Filters"]})}),xe&&e.jsxs("div",{className:"my-4 p-4 border dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 space-y-4 md:space-y-0 md:flex md:flex-wrap md:items-end md:gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"patchedByDevFilter",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Developer"}),e.jsx("input",{id:"patchedByDevFilter",type:"text",value:B,onChange:t=>ee(t.target.value),placeholder:"e.g., Main Dev",className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Released"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"date",value:$,onChange:t=>S(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"to"}),e.jsx("input",{type:"date",value:Y,onChange:t=>U(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"})]})]}),e.jsxs("div",{className:"flex items-end gap-2 pt-5",children:[e.jsx("button",{onClick:st,className:"text-sm px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"Apply"}),e.jsx("button",{onClick:rt,className:"text-sm px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500",children:"Clear"})]})]}),C?e.jsx("div",{className:"py-10",children:e.jsx(It,{message:"Loading patches..."})}):ge&&u.length===0&&!C?e.jsx(es,{message:ge,onRetry:Xe}):!C&&!ge&&u.length===0?e.jsxs("div",{className:"text-center py-10 bg-white dark:bg-gray-800 rounded-lg shadow-sm my-6",children:[e.jsx(Ft,{size:48,className:"mx-auto text-yellow-500 dark:text-yellow-400 mb-4"}),e.jsx("p",{className:"text-xl font-semibold text-gray-700 dark:text-gray-200 mb-3",children:Ae?"No Patches Found Matching Criteria":"No Patches Available"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 px-4",children:Ae?"Try adjusting or clearing your search/filter settings.":i==="admin"||i==="super_admin"?"Add new patches to get started.":"Please check back later."}),Ae&&e.jsx("button",{onClick:tt,className:"mt-6 btn-primary text-sm",children:"Clear All Filters & Search"})]}):e.jsx(Zt,{columns:bt,data:He,rowClassName:"group",isLoading:C||f,currentPage:Z,totalPages:ye,onPageChange:ot,itemsPerPage:q,totalItems:ve,sortColumn:P,sortOrder:E,onSort:lt,isSelectionEnabled:!0,selectedItemIds:v,onSelectItem:mt,onSelectAllItems:ut}),ke&&W&&e.jsx(Ze,{isOpen:ke,title:"Delete Patch",message:`Delete "${W.patch_name}"?`,onConfirm:ct,onCancel:Le,isConfirming:f,confirmButtonText:"Delete",confirmButtonVariant:"danger"}),Oe&&e.jsx(Ze,{isOpen:Oe,title:`Delete ${v.size} Patch(es)`,message:`Delete ${v.size} selected items?`,onConfirm:gt,onCancel:()=>De(!1),isConfirming:he,confirmButtonText:"Delete Selected",confirmButtonVariant:"danger"}),Re&&e.jsx(Gt,{isOpen:Re,onClose:()=>je(!1),title:`Move ${v.size} Patch(es)`,children:e.jsxs("div",{className:"p-4",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mb-2",children:"Select target Software and Version:"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"modalSoftwareMove",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Target Software"}),e.jsxs("select",{id:"modalSoftwareMove",value:ne??"",onChange:t=>{Pe(t.target.value?parseInt(t.target.value):null),Ve(null)},className:"input-class w-full dark:bg-gray-700 dark:text-white dark:border-gray-600",disabled:oe||Q.length===0,children:[e.jsx("option",{value:"",children:"Select Software..."}),Q.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),ne&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"modalVersionMove",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Target Version"}),e.jsxs("select",{id:"modalVersionMove",value:Ne??"",onChange:t=>Ve(t.target.value?parseInt(t.target.value):null),className:"input-class w-full dark:bg-gray-700 dark:text-white dark:border-gray-600",disabled:oe||Me||Ce.length===0,children:[e.jsx("option",{value:"",children:Me?"Loading...":"Select Version..."}),Ce.map(t=>e.jsx("option",{value:t.id,children:t.version_number},t.id))]}),Ce.length===0&&!Me&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:"No versions for selected software."})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[e.jsx("button",{type:"button",onClick:()=>je(!1),className:"px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500",disabled:oe,children:"Cancel"}),e.jsx("button",{type:"button",onClick:pt,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",disabled:oe||!ne||!Ne,children:oe?"Moving...":"Confirm Move"})]})]})}),g&&w&&e.jsxs("div",{ref:Ie,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("h3",{className:"text-xl font-semibold text-gray-800 dark:text-white mb-4",children:["Comments for: ",e.jsx("span",{className:"font-bold text-blue-600 dark:text-blue-400",children:w.patch_name})]}),e.jsx(Ht,{itemId:w.id,itemType:"patch",onCommentAction:Xe})]}),!g&&w&&e.jsx("div",{ref:Ie,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 text-center",children:e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Please log in to view and manage comments."})})]})};export{ms as default};
