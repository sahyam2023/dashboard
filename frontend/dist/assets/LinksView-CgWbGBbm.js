import{r as s,u as et,f as tt,s as u,q as je,j as e,L as st,F as Ge,X as St,y as jt,a as C,z as Nt,c as It,d as Lt,g as Ft,A as _t,i as Ct,k as Vt,S as Mt,B as At,m as Dt,n as Ut,o as Pt,p as zt}from"./index-Cx0gNuKI.js";import{u as Et,U as $t,o as Rt,c as Ot,a as G,b as Bt,P as Tt,T as Je,D as Ke,M as qt,F as Wt,C as Ht,e as Xt,d as Yt}from"./CommentSection-obay-nDP.js";import{C as Gt,D as Jt,a as Ze,M as Kt}from"./Modal-DeMS46HP.js";import{f as Qe}from"./dateUtils-C4q4Gbs_.js";import{F as Zt}from"./FilterTabs-CvXtjvqA.js";import{E as Qt}from"./ErrorState-ByXhRj64.js";const J="CREATE_NEW_VERSION_SENTINEL_VALUE",es=Ot().shape({selectedSoftwareId:G().required("Software Product must be selected."),title:G().required("Link Title is required.").max(255,"Title cannot exceed 255 characters."),selectedVersionId:G().required("Version must be selected or a new one entered."),typedVersionString:G().when("selectedVersionId",{is:J,then:a=>a.required('New Version String is required when "Enter New Version" is selected.').min(1,"New Version String cannot be empty."),otherwise:a=>a.transform(y=>y===""?void 0:y).optional().nullable()}),inputMode:G().oneOf(["url","upload"]).required("Input mode must be selected."),externalUrl:G().when("inputMode",{is:"url",then:a=>a.required("External URL is required for URL mode.").url("Please enter a valid URL (e.g., http://example.com)."),otherwise:a=>a.optional().nullable()}),selectedFile:Bt().when(["inputMode","isEditMode","existingFileName"],{is:(a,y,x)=>a==="upload"&&(!y||!x),then:a=>a.required("A file is required for new link uploads.").test("filePresent","A file is required for new link uploads.",y=>!!y),otherwise:a=>a.nullable()}),description:G().optional().max(1e3,"Description cannot exceed 1000 characters.")}),ts=({linkToEdit:a,onLinkAdded:y,onLinkUpdated:x,onCancelEdit:R})=>{const o=!!a,{register:f,handleSubmit:ne,control:K,formState:{errors:d},watch:O,setValue:g,reset:h}=Et({resolver:Rt(es),context:{isEditMode:o,existingFileName:(a==null?void 0:a.original_filename_ref)||(a&&!a.is_external_link?a.url.split("/").pop():null)},defaultValues:{selectedSoftwareId:"",title:"",selectedVersionId:"",typedVersionString:"",inputMode:"url",externalUrl:"",selectedFile:null,description:""}}),[Z,V]=s.useState([]),[M,I]=s.useState([]),[q,A]=s.useState(null),[b,F]=s.useState(!1),[B,D]=s.useState(!1),[ie,W]=s.useState(0),[be,Q]=s.useState(!1),{isAuthenticated:L,user:H}=et(),X=H==null?void 0:H.role,U=s.useRef(null),j=O("selectedSoftwareId"),Ne=O("selectedVersionId"),ee=O("inputMode"),S=O("selectedFile"),oe=Ne===J;s.useEffect(()=>{const r=k=>{be&&(k.preventDefault(),k.returnValue="")};return window.addEventListener("beforeunload",r),()=>{window.removeEventListener("beforeunload",r)}},[be]),s.useEffect(()=>{L&&(X==="admin"||X==="super_admin")&&(D(!0),tt().then(V).catch(()=>u("Failed to load software list.")).finally(()=>D(!1)))},[L,X]),s.useEffect(()=>{j?(D(!0),I([]),g("selectedVersionId",""),g("typedVersionString",""),je(parseInt(j)).then(I).catch(()=>u("Failed to load versions for selected software.")).finally(()=>D(!1))):(I([]),g("selectedVersionId",""),g("typedVersionString",""))},[j,g]),s.useEffect(()=>{if(o&&a){const r={selectedSoftwareId:a.software_id.toString(),title:a.title,description:a.description||"",inputMode:a.is_external_link?"url":"upload",externalUrl:a.is_external_link?a.url:""};a.version_id&&a.software_id.toString()===j&&M.length>0?M.find(N=>N.id===a.version_id)?(r.selectedVersionId=a.version_id.toString(),r.typedVersionString=a.version_number):(r.selectedVersionId=J,r.typedVersionString=a.version_number):a.version_number&&(r.selectedVersionId=J,r.typedVersionString=a.version_number),h(r),a.is_external_link?A(null):A(a.original_filename_ref||a.url.split("/").pop()||"unknown_file"),g("selectedFile",null),U.current&&(U.current.value="")}else o||P(!!j)},[o,a,h,g,M,j]);const P=(r=!1)=>{const k=r?O("selectedSoftwareId"):"";h({selectedSoftwareId:k,title:"",selectedVersionId:"",typedVersionString:"",inputMode:"url",externalUrl:"",selectedFile:null,description:""}),A(null),U.current&&(U.current.value="")},Ie=r=>{r.target.files&&r.target.files[0]?g("selectedFile",r.target.files[0],{shouldValidate:!0,shouldDirty:!0}):g("selectedFile",null,{shouldValidate:!0,shouldDirty:!0})},te=()=>{g("selectedFile",null,{shouldValidate:!0,shouldDirty:!0}),U.current&&(U.current.value="")},de=async r=>{var Y,ue,me,z;F(!0),r.inputMode==="upload"&&r.selectedFile&&Q(!0),W(0);let k,N;r.selectedVersionId===J&&r.typedVersionString?N=r.typedVersionString.trim():r.selectedVersionId&&r.selectedVersionId!==J&&(k=parseInt(r.selectedVersionId));const se={software_id:parseInt(r.selectedSoftwareId),title:r.title.trim(),description:((Y=r.description)==null?void 0:Y.trim())||void 0};k&&(se.version_id=k),N&&(se.typed_version_string=N);try{let w;if(r.inputMode==="url"){const E={...se,url:r.externalUrl.trim(),is_external_link:!0};o&&a?(w=await jt(a.id,E),C(`Link "${w.title}" updated successfully!`),x&&x(w)):(w=await Nt(E),C(`Link "${w.title}" added successfully!`),y&&y(w),o||(P(!0),g("selectedVersionId",""),g("typedVersionString","")))}else{if(!r.selectedFile){if(o&&a&&!a.is_external_link&&!r.selectedFile){u("To update metadata of an existing uploaded file link without re-uploading, use a different form/feature. To replace the file, select a new file."),F(!1);return}if(!r.selectedFile&&!o){u("No file selected for upload."),F(!1);return}}const E={software_id:r.selectedSoftwareId,...k&&{version_id:k.toString()},...N&&{typed_version_string:N},link_title:r.title.trim(),description:((ue=r.description)==null?void 0:ue.trim())||""};w=await It(r.selectedFile,"link_file",E,ye=>W(ye)),C(`Link file "${w.title}" added successfully via chunked upload!`),y&&y(w),P(!0),g("selectedVersionId",""),g("typedVersionString","")}}catch(w){const E=((z=(me=w.response)==null?void 0:me.data)==null?void 0:z.msg)||w.message||`Failed to ${o&&r.inputMode==="url"?"update":"add"} link.`;u(E),r.inputMode==="upload"&&Q(!1)}finally{F(!1),r.inputMode==="upload"&&Q(!1)}},ce=r=>{console.error("Form validation errors:",r),u("Please correct the errors highlighted in the form.")};return!L||!X||!["admin","super_admin"].includes(X)?null:e.jsxs("form",{onSubmit:ne(de,ce),className:"space-y-6 bg-white dark:bg-gray-800 dark:border-gray-700 p-6 rounded-lg shadow-md border border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-xl font-semibold text-gray-800 dark:text-gray-100",children:[" ",o?"Edit Link":"Add New Link"," "]}),o&&R&&e.jsx("button",{type:"button",onClick:R,className:"text-sm text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200",children:" Cancel "})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedSoftwareId",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Software Product*"}),B&&!Z.length?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading software..."}):e.jsxs("select",{id:"selectedSoftwareId",...f("selectedSoftwareId"),disabled:b||B&&!Z.length,className:`mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${d.selectedSoftwareId?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",disabled:!0,children:"Select Software Product"}),Z.map(r=>e.jsx("option",{value:r.id.toString(),children:r.name},r.id))]}),d.selectedSoftwareId&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:d.selectedSoftwareId.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedVersionId",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Version*"}),e.jsx("div",{className:"mt-1",children:e.jsxs("select",{id:"selectedVersionId",...f("selectedVersionId"),disabled:b||B||!j,className:`block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${d.selectedVersionId?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",disabled:M.length>0&&!!j,children:B&&j?"Loading versions...":"Select Existing Version"}),M.map(r=>e.jsx("option",{value:r.id.toString(),children:r.version_number},r.id)),e.jsx("option",{value:J,children:"Enter New Version String..."})]})}),oe&&e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{htmlFor:"typedVersionString",className:"block text-xs font-medium text-gray-600 dark:text-gray-400",children:"New Version String*:"}),e.jsx("input",{type:"text",id:"typedVersionString",...f("typedVersionString"),placeholder:"e.g., 1.2.4-final",className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.typedVersionString?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"This version will be created for the selected software if it doesn't exist."})]}),d.selectedVersionId&&!oe&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.selectedVersionId.message}),d.typedVersionString&&oe&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.typedVersionString.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"title",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Link Title*"}),e.jsx("input",{type:"text",id:"title",...f("title"),disabled:b,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.title?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),d.title&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.title.message})]}),e.jsxs("div",{className:"my-4",children:[e.jsx("span",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Link Source:"}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",...f("inputMode"),value:"url",className:"form-radio h-4 w-4 text-blue-600",disabled:b}),e.jsxs("span",{className:"flex items-center dark:text-gray-300",children:[e.jsx(st,{size:16,className:"mr-1 text-gray-600 dark:text-gray-400"}),"Provide External URL"]})]}),e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",...f("inputMode"),value:"upload",className:"form-radio h-4 w-4 text-blue-600",disabled:b}),e.jsxs("span",{className:"flex items-center dark:text-gray-300",children:[e.jsx($t,{size:16,className:"mr-1 text-gray-600 dark:text-gray-400"}),"Upload File for this Link"]})]})]}),d.inputMode&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.inputMode.message})]}),ee==="url"&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"externalUrl",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Link URL*"}),e.jsx("input",{type:"url",id:"externalUrl",...f("externalUrl"),placeholder:"https://example.com/resource",disabled:b,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.externalUrl?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),d.externalUrl&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.externalUrl.message})]}),ee==="upload"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:o&&q&&!S?"Replace File (Optional)":"Select File to Upload*"}),e.jsx("div",{className:"mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-blue-500 dark:border-gray-600 dark:hover:border-blue-400 transition-colors",children:e.jsxs("div",{className:"space-y-1 text-center",children:[e.jsx(Ge,{className:"mx-auto h-12 w-12 text-gray-400 dark:text-gray-500"}),e.jsxs("div",{className:"flex text-sm text-gray-600 dark:text-gray-400",children:[e.jsxs("label",{htmlFor:"link-file-upload-input",className:"relative cursor-pointer bg-white dark:bg-gray-800 rounded-md font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500",children:[e.jsx("span",{children:S?"Change file":"Upload a file"}),e.jsx("input",{id:"link-file-upload-input",name:"file-input-element",type:"file",className:"sr-only",onChange:Ie,ref:U,disabled:b})]}),e.jsx("p",{className:"pl-1",children:"or drag and drop"})]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Any file type relevant for links."})]})}),(S||o&&q)&&e.jsxs("div",{className:"mt-3 flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md",children:[e.jsxs("div",{className:"flex items-center space-x-2 overflow-hidden",children:[e.jsx(Ge,{size:18,className:"text-gray-500 dark:text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:S?S.name:q}),o&&q&&!S&&e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 ml-2",children:"(current)"})]}),S&&e.jsx("button",{type:"button",onClick:te,disabled:b,className:"p-1 rounded-full text-gray-400 hover:text-gray-600 hover:bg-gray-200 dark:text-gray-500 dark:hover:text-gray-300 dark:hover:bg-gray-600",children:e.jsx(St,{size:16})})]}),d.selectedFile&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.selectedFile.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Description"}),e.jsx("textarea",{id:"description",rows:3,...f("description"),disabled:b,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.description?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),d.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.description.message})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{type:"submit",disabled:b||B,className:"flex-1 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",children:b?o?"Updating...":"Adding...":o?"Update Link":"Add Link"}),o&&R&&e.jsx("button",{type:"button",onClick:R,disabled:b,className:"flex-1 inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 dark:border-gray-500 dark:text-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600",children:"Cancel"})]}),b&&ee==="upload"&&ie>0&&e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 my-3 relative",children:[e.jsx("div",{className:"bg-blue-600 h-4 rounded-full transition-all duration-150 ease-out",style:{width:`${ie}%`}}),e.jsxs("p",{className:"absolute inset-0 text-center text-xs font-medium leading-4 text-white dark:text-gray-100",children:[Math.round(ie),"%"]})]})]})},os=()=>{const{searchTerm:a,setSearchTerm:y}=Lt(),{isAuthenticated:x,user:R}=et(),o=R==null?void 0:R.role,[f,ne]=s.useState([]),[K,d]=s.useState([]),[O,g]=s.useState([]),[h,Z]=s.useState(null),[V,M]=s.useState(null),[I,q]=s.useState(""),[A,b]=s.useState(""),[F,B]=s.useState(""),[D,ie]=s.useState(""),[W,be]=s.useState(""),[Q,L]=s.useState(1),[H,X]=s.useState(15),[U,j]=s.useState(0),[Ne,ee]=s.useState(0),[S,oe]=s.useState("title"),[P,Ie]=s.useState("asc"),[te,de]=s.useState(!0),[ce,r]=s.useState(null),[k,N]=s.useState(!1),[se,Y]=s.useState(null),[ue,me]=s.useState(!1),[z,w]=s.useState(null),[E,ye]=s.useState(!1),[fe,ge]=s.useState(new Map),[Me,rt]=s.useState(!1),[p,xe]=s.useState(new Set),[Ae,De]=s.useState(!1),[at,Ue]=s.useState(!1),[re,Pe]=s.useState(!1),[ze,ke]=s.useState(!1),[$,Le]=s.useState(null),[Ee,$e]=s.useState([]),[we,ve]=s.useState(void 0),[Re,Fe]=s.useState(!1),[_e,Oe]=s.useState(!1),[v,he]=s.useState(null),Se=s.useRef(null),Be=Ft(),Ce=s.useMemo(()=>h!==null||V!==null||I!==""||A!==""||F!==""||a!=="",[h,V,I,A,F,a]),Te=s.useCallback(()=>{Z(null),M(null),q(""),b(""),B(""),y&&y(""),L(1)},[y]),_=s.useCallback(async(t,l=!1)=>{var i,c;l&&de(!0),r(null);try{const n=await _t(h||void 0,V||void 0,t,H,S,P,I||void 0,D||void 0,W||void 0);ne(n.links),j(n.total_pages),ee(n.total_links),L(n.page),X(n.per_page);const m=new Map;x&&n.links&&n.links.forEach(pe=>m.set(pe.id,{favoriteId:pe.favorite_id})),ge(m)}catch(n){const m=((c=(i=n.response)==null?void 0:i.data)==null?void 0:c.msg)||n.message||"Failed to fetch links.";l?(r(m),ne([]),j(0),ee(0)):u(m)}finally{l&&de(!1)}},[h,V,H,S,P,I,D,W,x]);s.useEffect(()=>{const t=setTimeout(()=>ie(A),500);return()=>clearTimeout(t)},[A]),s.useEffect(()=>{const t=setTimeout(()=>be(F),500);return()=>clearTimeout(t)},[F]),s.useEffect(()=>{x?tt().then(d).catch(t=>u("Failed to load software list.")):d([])},[x]),s.useEffect(()=>{x?_(1,!0):(ne([]),de(!1))},[x,h,V,S,P,I,D,W,a,_]),s.useEffect(()=>{xe(new Set)},[h,V,S,P,I,D,W,a,Q]),s.useEffect(()=>{h?je(h).then(g).catch(()=>{u("Failed to load versions for filter."),g([])}):g([])},[h]),s.useEffect(()=>{const t=new URLSearchParams(Be.search),l=t.get("item_id"),i=t.get("comment_id");if(l&&i&&f.length>0){const c=parseInt(l,10);if(!isNaN(c)){const n=f.find(m=>m.id===c);n?((!v||v.id!==n.id)&&he(n),setTimeout(()=>{var m;(m=Se.current)==null||m.scrollIntoView({behavior:"smooth",block:"center"})},100)):console.warn(`LinksView: Link with item_id ${c} not found in the current list.`)}}},[Be.search,f,v]),s.useEffect(()=>{$?(Oe(!0),je($).then($e).catch(()=>u("Failed to load versions for move.")).finally(()=>Oe(!1))):$e([])},[$]);const lt=t=>{Z(t),M(null),L(1)},nt=t=>{M(t.target.value?parseInt(t.target.value):null),L(1)},it=t=>{L(t),_(t,!0)},ot=t=>{oe(t),Ie(l=>S===t&&l==="asc"?"desc":"asc"),L(1)},dt=()=>{L(1),_(1,!0)},qe=async t=>{if(N(!1),Y(null),await _(1,!0),h)try{const l=await je(h);g(l)}catch(l){console.error("Error refreshing version list after operation:",l),u("Failed to refresh version list for the current software filter.")}},ct=()=>{Y(null),N(!0)},ut=t=>{Y(t),N(!0),window.scrollTo({top:0,behavior:"smooth"})},We=()=>{Y(null),N(!1)},mt=t=>{w(t),me(!0)},Ve=()=>{w(null),me(!1)},ft=async()=>{if(z){ye(!0),v&&v.id===z.id&&he(null);try{await At(z.id),C(`Link "${z.title}" deleted.`),Ve(),_(1,!0)}catch(t){u(t.message||"Delete failed."),Ve()}finally{ye(!1)}}},He=s.useMemo(()=>{if(!a)return f;const t=a.toLowerCase();return f.filter(l=>l.title.toLowerCase().includes(t)||(l.description||"").toLowerCase().includes(t)||(l.software_name||"").toLowerCase().includes(t)||(l.version_name||"").toLowerCase().includes(t))},[f,a]),gt=(t,l)=>xe(i=>{const c=new Set(i);return l?c.add(t):c.delete(t),c}),xt=t=>{const l=new Set;t&&He.forEach(i=>l.add(i.id)),xe(l)},ht=()=>{if(p.size===0){u("No items selected.");return}Fe(!0)},pt=async()=>{Fe(!1),De(!0),v&&p.has(v.id)&&he(null);try{const t=await Dt(Array.from(p),"link");C(t.msg||`${t.deleted_count} link(s) deleted.`),xe(new Set),_(1,!0)}catch(t){u(t.message||"Bulk delete failed.")}finally{De(!1)}},Xe=s.useMemo(()=>f.filter(t=>p.has(t.id)&&!t.is_external_link&&t.stored_filename).length,[f,p]),bt=async()=>{if(p.size===0){u("No items selected.");return}const t=f.filter(i=>p.has(i.id)&&!i.is_external_link&&i.stored_filename);if(t.length===0){u("No downloadable files among selected links. External links or links without files cannot be bulk downloaded.");return}const l=t.map(i=>i.id);l.length<p.size&&C(`Starting download for ${l.length} file-based links. External links were excluded.`),Ue(!0);try{const i=await Vt(l,"link"),c=URL.createObjectURL(i),n=document.createElement("a");n.href=c;const m=new Date().toISOString().replace(/:/g,"-");n.download=`bulk_download_links_${m}.zip`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(c),l.length===p.size&&C("Download started.")}catch(i){u(i.message||"Bulk download failed.")}finally{Ue(!1)}},yt=()=>{if(p.size===0){u("No items selected.");return}if(K.length===0){u("Software list unavailable.");return}Le(null),ve(void 0),ke(!0)},kt=async()=>{if(!$){u("Select target software.");return}ke(!1),Pe(!0);const t={target_software_id:$};we!==void 0&&(t.target_version_id=we);try{const l=await Ut(Array.from(p),"link",t);C(l.msg||`${l.moved_count} link(s) moved.`),xe(new Set),_(1,!0)}catch(l){u(l.message||"Bulk move failed.")}finally{Pe(!1),Le(null),ve(void 0)}},wt=[{key:"title",header:"Title",sortable:!0},{key:"software_name",header:"Software",sortable:!0},{key:"version_name",header:"Version",sortable:!0,render:t=>t.version_name||"N/A"},{key:"description",header:"Description",render:t=>e.jsx("span",{className:"text-sm text-gray-600 block max-w-xs truncate",title:t.description||"",children:t.description||"-"})},{key:"url",header:"Link",render:t=>{var n;const l=t.is_external_link||t.is_downloadable!==!1,i="Link",c=Ke;return!l&&!t.is_external_link?e.jsxs("span",{className:"flex items-center text-gray-400 cursor-not-allowed",title:"Download not permitted",children:[e.jsx(c,{size:14,className:"mr-1 flex-shrink-0"}),i]}):e.jsxs("a",{href:t.url,target:t.is_external_link||!((n=t.url)!=null&&n.startsWith("/"))?"_blank":"_self",rel:"noopener noreferrer",className:`flex items-center ${l?"text-blue-600 hover:text-blue-800":"text-gray-400 cursor-not-allowed"}`,onClick:m=>{l||m.preventDefault(),m.stopPropagation()},title:l?t.is_external_link?"Open external link":"Download file":"Download not permitted",children:[e.jsx(c,{size:14,className:"mr-1 flex-shrink-0"}),i]})}},{key:"uploaded_by_username",header:"Added By",sortable:!0,render:t=>t.uploaded_by_username||"N/A"},{key:"updated_by_username",header:"Updated By",sortable:!1,render:t=>t.updated_by_username||"N/A"},{key:"created_at",header:"Created",sortable:!0,render:t=>Qe(t.created_at??"")},{key:"updated_at",header:"Updated",sortable:!0,render:t=>Qe(t.updated_at??"")},{key:"actions",header:"Actions",render:t=>{var l,i,c;return e.jsxs("div",{className:"flex space-x-1 items-center",children:[x&&e.jsx("button",{onClick:n=>{n.stopPropagation(),vt(t,"link")},className:`p-1 rounded-md ${(l=fe.get(t.id))!=null&&l.favoriteId?"text-yellow-500 hover:text-yellow-600":"text-gray-400 hover:text-yellow-500"}`,title:(i=fe.get(t.id))!=null&&i.favoriteId?"Remove Favorite":"Add Favorite",children:e.jsx(Mt,{size:16,className:(c=fe.get(t.id))!=null&&c.favoriteId?"fill-current":""})}),x&&e.jsxs("button",{onClick:n=>{n.stopPropagation(),v&&v.id===t.id?he(null):(he(t),setTimeout(()=>{var m;return(m=Se.current)==null?void 0:m.scrollIntoView({behavior:"smooth"})},0))},className:"p-1 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 rounded-md",title:v&&v.id===t.id?"Hide Comments":"View Comments",children:[e.jsx(Xt,{size:16}),e.jsxs("span",{className:"ml-1 text-xs",children:["(",t.comment_count??0,")"]})]}),(o==="admin"||o==="super_admin")&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:n=>{n.stopPropagation(),ut(t)},className:"p-1 text-blue-600 hover:text-blue-800 rounded-md",title:"Edit",children:e.jsx(Yt,{size:16})}),e.jsx("button",{onClick:n=>{n.stopPropagation(),mt(t)},className:"p-1 text-red-600 hover:text-red-800 rounded-md",title:"Delete",children:e.jsx(Je,{size:16})})]})]})}}],Ye=s.useCallback(()=>{_(1,!0)},[_]),vt=async(t,l)=>{var m,pe;if(!x){u("Please log in to manage favorites.");return}const i=fe.get(t.id),c=!!(i!=null&&i.favoriteId),n=new Map(fe);c?n.set(t.id,{favoriteId:void 0}):n.set(t.id,{favoriteId:-1}),ge(n);try{if(c&&typeof(i==null?void 0:i.favoriteId)=="number")await Pt(t.id,l),C(`"${t.title}" removed from favorites.`),ge(T=>{const ae=new Map(T);return ae.set(t.id,{favoriteId:void 0}),ae});else{const T=await zt(t.id,l);ge(ae=>{const le=new Map(ae);return le.set(t.id,{favoriteId:T.id}),le}),C(`"${t.title}" added to favorites.`)}}catch(T){u(((pe=(m=T==null?void 0:T.response)==null?void 0:m.data)==null?void 0:pe.msg)||T.message||"Failed to update favorite."),ge(ae=>{const le=new Map(ae);return c?le.set(t.id,{favoriteId:i==null?void 0:i.favoriteId}):le.set(t.id,{favoriteId:void 0}),le})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-start sm:items-center mb-6 flex-col sm:flex-row",children:[e.jsxs("div",{children:[" ",e.jsx("h2",{className:"text-2xl font-bold text-gray-800 dark:text-white",children:"Links"})," ",e.jsx("p",{className:"text-gray-600 mt-1 dark:text-gray-300",children:"Manage and browse useful links and resources."})," "]}),x&&(o==="admin"||o==="super_admin")&&!se&&e.jsxs("button",{onClick:()=>{k?We():ct()},className:"mt-4 sm:mt-0 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx(Tt,{size:18,className:"mr-2"})," ",k?"Cancel":"Add New Link"]})]}),k&&e.jsx("div",{className:"my-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow",children:e.jsx(ts,{linkToEdit:se,onLinkAdded:()=>qe(),onLinkUpdated:()=>qe(),onCancelEdit:We})}),p.size>0&&e.jsx("div",{className:"my-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:[p.size," item(s) selected"]}),(o==="admin"||o==="super_admin")&&e.jsxs("button",{onClick:ht,disabled:Ae,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-800 focus:ring-red-500 disabled:opacity-50",children:[e.jsx(Je,{size:14,className:"mr-1.5"}),"Delete"]}),x&&e.jsxs("button",{onClick:bt,disabled:at||Xe===0,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-green-500 hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 focus:ring-green-500 disabled:opacity-50",children:[e.jsx(Ke,{size:14,className:"mr-1.5"}),"Download (",Xe,")"]}),(o==="admin"||o==="super_admin")&&e.jsxs("button",{onClick:yt,disabled:re,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 focus:ring-blue-500 disabled:opacity-50",children:[e.jsx(qt,{size:14,className:"mr-1.5"}),"Move"]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:gap-4 -mt-20",children:[K.length>0&&e.jsx("div",{className:"w-fit flex-shrink-0",children:e.jsx(Zt,{software:K,selectedSoftwareId:h,onSelectFilter:lt})}),h&&e.jsxs("div",{className:"flex items-center gap-2 min-w-[200px] mt-4 md:mt-0 flex-shrink-0",children:[e.jsx("label",{htmlFor:"versionFilterLinks",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Version"}),e.jsxs("select",{id:"versionFilterLinks",value:V||"",onChange:nt,className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200",disabled:O.length===0,children:[e.jsx("option",{value:"",children:"All Versions"}),O.map(t=>e.jsx("option",{value:t.id,children:t.version_number},t.id))]})]})]}),e.jsx("div",{className:"mb-4 mt-0",children:e.jsxs("button",{onClick:()=>rt(t=>!t),className:"flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-md text-sm font-medium",children:[Me?e.jsx(Gt,{size:18,className:"mr-1.5"}):e.jsx(Wt,{size:18,className:"mr-1.5"})," Advanced Filters"]})}),Me&&e.jsxs("div",{className:"my-4 p-4 border dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 space-y-4 md:space-y-0 md:flex md:flex-wrap md:items-end md:gap-4",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{htmlFor:"linkTypeFilterSelect",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Link Type"}),e.jsxs("select",{id:"linkTypeFilterSelect",value:I,onChange:t=>q(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200",children:[e.jsx("option",{value:"",children:"All"})," ",e.jsx("option",{value:"external",children:"External URL"})," ",e.jsx("option",{value:"uploaded",children:"Uploaded File"})]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Created Between"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"date",value:A,onChange:t=>b(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"to"}),e.jsx("input",{type:"date",value:F,onChange:t=>B(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"})]})]}),e.jsxs("div",{className:"flex items-end gap-2 pt-5",children:[e.jsx("button",{onClick:dt,className:"text-sm px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"Apply"}),e.jsx("button",{onClick:Te,className:"text-sm px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500",children:"Clear All"})]})]}),te?e.jsx("div",{className:"py-10",children:e.jsx(Ct,{message:"Loading links..."})}):ce&&f.length===0&&!te?e.jsx(Qt,{message:ce,onRetry:Ye}):!te&&!ce&&f.length===0?e.jsxs("div",{className:"text-center py-10 bg-white dark:bg-gray-800 rounded-lg shadow-sm my-6",children:[e.jsx(st,{size:48,className:"mx-auto text-yellow-500 dark:text-yellow-400 mb-4"}),e.jsx("p",{className:"text-xl font-semibold text-gray-700 dark:text-gray-200 mb-3",children:Ce?"No Links Found Matching Criteria":"No Links Available"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 px-4",children:Ce?"Try adjusting or clearing your search/filter settings.":o==="admin"||o==="super_admin"?"Add new links to get started.":"Please check back later."}),Ce&&e.jsx("button",{onClick:Te,className:"mt-6 btn-primary text-sm",children:"Clear All Filters & Search"})]}):e.jsx(Jt,{columns:wt,data:He,rowClassName:"group",isLoading:te||E,currentPage:Q,totalPages:U,onPageChange:it,itemsPerPage:H,totalItems:Ne,sortColumn:S,sortOrder:P,onSort:ot,isSelectionEnabled:!0,selectedItemIds:p,onSelectItem:gt,onSelectAllItems:xt}),ue&&z&&e.jsx(Ze,{isOpen:ue,title:"Delete Link",message:`Delete "${z.title}"?`,onConfirm:ft,onCancel:Ve,isConfirming:E,confirmButtonText:"Delete",confirmButtonVariant:"danger"}),Re&&e.jsx(Ze,{isOpen:Re,title:`Delete ${p.size} Link(s)`,message:`Delete ${p.size} selected items?`,onConfirm:pt,onCancel:()=>Fe(!1),isConfirming:Ae,confirmButtonText:"Delete Selected",confirmButtonVariant:"danger"}),ze&&e.jsx(Kt,{isOpen:ze,onClose:()=>ke(!1),title:`Move ${p.size} Link(s)`,children:e.jsxs("div",{className:"p-4",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mb-2",children:"Select target Software and optionally a Version:"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"modalSoftwareMoveLinks",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Target Software*"}),e.jsxs("select",{id:"modalSoftwareMoveLinks",value:$??"",onChange:t=>{Le(t.target.value?parseInt(t.target.value):null),ve(void 0)},className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white",disabled:re||K.length===0,children:[e.jsx("option",{value:"",children:"Select Software..."}),K.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),$&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"modalVersionMoveLinks",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Target Version (Optional)"}),e.jsxs("select",{id:"modalVersionMoveLinks",value:we===null?"NULL_VERSION":we??"",onChange:t=>ve(t.target.value==="NULL_VERSION"?null:t.target.value?parseInt(t.target.value):void 0),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white",disabled:re||_e,children:[e.jsx("option",{value:"",children:_e?"Loading...":"Select Version (Optional)..."}),e.jsx("option",{value:"NULL_VERSION",children:"No Specific Version (Clear Association)"}),Ee.map(t=>e.jsx("option",{value:t.id,children:t.version_number},t.id))]}),Ee.length===0&&!_e&&$&&e.jsx("p",{className:"text-xs text-yellow-600 mt-1",children:"No versions for selected software. You can still move to the software without a specific version."})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[e.jsx("button",{type:"button",onClick:()=>ke(!1),className:"px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500",disabled:re,children:"Cancel"}),e.jsx("button",{type:"button",onClick:kt,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",disabled:re||!$,children:re?"Moving...":"Confirm Move"})]})]})}),x&&v&&e.jsxs("div",{ref:Se,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("h3",{className:"text-xl font-semibold text-gray-800 dark:text-white mb-4",children:["Comments for: ",e.jsx("span",{className:"font-bold text-blue-600 dark:text-blue-400",children:v.title})]}),e.jsx(Ht,{itemId:v.id,itemType:"link",onCommentAction:Ye})]}),!x&&v&&e.jsx("div",{ref:Se,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 text-center",children:e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Please log in to view and manage comments."})})]})};export{os as default};
