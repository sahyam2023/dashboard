import{r as s,u as et,f as tt,s as u,t as ve,j as e,L as st,F as Ye,X as wt,A as St,a as $,B as jt,c as Nt,d as Vt,g as _t,C as It,D as Ge,i as Lt,k as Ke,l as Ft,S as Ct,M as Mt,E as At,n as Dt,o as Ut,p as Pt,q as Ot}from"./index-DKBLkBnu.js";import{u as $t,d as zt,U as Rt,o as Et,c as Bt,e as qt,a as J,b as Tt,T as Ze,M as Wt,F as Ht,C as Jt,P as Xt}from"./CommentSection-DtqbZklP.js";import{C as Yt,D as Gt,a as Qe}from"./ConfirmationModal-FwNAEkSL.js";import{F as Kt}from"./FilterTabs-Z2o_o2lh.js";import{E as Zt}from"./ErrorState-BPfCgKLQ.js";import{M as Qt}from"./Modal-C-zdTdg1.js";import{P as es}from"./plus-circle-BHP8Kf9E.js";const re="CREATE_NEW_VERSION_SENTINEL_VALUE",ts=Bt().shape({selectedSoftwareId:J().required("Software Product must be selected."),title:J().required("Link Title is required.").max(255,"Title cannot exceed 255 characters."),selectedVersionId:J().required("Version must be selected or a new one entered."),typedVersionString:J().when("selectedVersionId",{is:re,then:a=>a.required('New Version String is required when "Enter New Version" is selected.').min(1,"New Version String cannot be empty."),otherwise:a=>a.transform(w=>w===""?void 0:w).optional().nullable()}),inputMode:J().oneOf(["url","upload"]).required("Input mode must be selected."),externalUrl:J().when("inputMode",{is:"url",then:a=>a.required("External URL is required for URL mode.").url("Please enter a valid URL (e.g., http://example.com)."),otherwise:a=>a.optional().nullable()}),selectedFile:Tt().when(["inputMode","isEditMode","existingFileName"],{is:(a,w,b)=>a==="upload"&&(!w||!b),then:a=>a.required("A file is required for new link uploads.").test("filePresent","A file is required for new link uploads.",w=>!!w),otherwise:a=>a.nullable()}),description:J().optional().max(1e3,"Description cannot exceed 1000 characters."),compatibleVmsVersionIds:qt().of(J().required()).optional()}),ss=({linkToEdit:a,onLinkAdded:w,onLinkUpdated:b,onCancelEdit:q})=>{const d=!!a,{register:h,handleSubmit:ge,control:X,formState:{errors:c},watch:T,setValue:p,reset:y}=$t({resolver:Et(ts),context:{isEditMode:d,existingFileName:(a==null?void 0:a.original_filename_ref)||(a&&!a.is_external_link?a.url.split("/").pop():null)},defaultValues:{selectedSoftwareId:"",title:"",selectedVersionId:"",typedVersionString:"",inputMode:"url",externalUrl:"",selectedFile:null,description:"",compatibleVmsVersionIds:[]}}),[V,z]=s.useState([]),[R,I]=s.useState([]),[xe,C]=s.useState([]),[ae,M]=s.useState(!1),[Y,W]=s.useState(null),[v,E]=s.useState(!1),[G,K]=s.useState(!1),[A,le]=s.useState(!1),[he,we]=s.useState(0),[pe,be]=s.useState(!1),{isAuthenticated:ie,user:D}=et(),Z=D==null?void 0:D.role,_=s.useRef(null),S=T("selectedSoftwareId"),ne=T("selectedVersionId"),Q=T("inputMode"),L=T("selectedFile"),oe=ne===re;s.useEffect(()=>{const r=o=>{pe&&(o.preventDefault(),o.returnValue="")};return window.addEventListener("beforeunload",r),()=>{window.removeEventListener("beforeunload",r)}},[pe]),s.useEffect(()=>{ie&&(Z==="admin"||Z==="super_admin")&&(K(!0),tt().then(z).catch(()=>u("Failed to load software list.")).finally(()=>K(!1)))},[ie,Z]),s.useEffect(()=>{if(S&&V.length>0){K(!0),I([]),p("selectedVersionId",""),p("typedVersionString","");const r=V.find(o=>o.id.toString()===S);if(r&&(r.name==="VMS"||r.name==="VA")){M(!0);const o=V.find(x=>x.name==="VMS");o?(le(!0),ve(o.id).then(C).catch(()=>u("Failed to load VMS versions for compatibility.")).finally(()=>le(!1))):C([])}else M(!1),C([]);ve(parseInt(S)).then(I).catch(()=>u("Failed to load versions for selected software.")).finally(()=>K(!1))}else I([]),M(!1),C([]),p("selectedVersionId",""),p("typedVersionString","")},[S,p,V]),s.useEffect(()=>{if(d&&a&&V.length>0){const r=V.find(k=>k.id===a.software_id),o=!!r&&(r.name==="VMS"||r.name==="VA");M(o);const x={selectedSoftwareId:S&&S!==a.software_id.toString()?S:a.software_id.toString(),title:a.title,description:a.description||"",inputMode:a.is_external_link?"url":"upload",externalUrl:a.is_external_link?a.url:"",compatibleVmsVersionIds:o&&a.compatible_vms_versions?typeof a.compatible_vms_versions=="string"?a.compatible_vms_versions.split(",").map(k=>k.trim()).filter(k=>k):Array.isArray(a.compatible_vms_versions)?a.compatible_vms_versions.map(String):[]:[]};S===a.software_id.toString()&&(a.version_id&&R.length>0?R.find(U=>U.id===a.version_id)?x.selectedVersionId=a.version_id.toString():(x.selectedVersionId=re,x.typedVersionString=a.version_name):a.version_name&&(x.selectedVersionId=re,x.typedVersionString=a.version_name)),y(x),a.is_external_link?W(null):W(a.original_filename_ref||a.url.split("/").pop()||"unknown_file"),p("selectedFile",null),_.current&&(_.current.value="")}else d||ee(!!S)},[d,a,y,p,R,S,V]);const ee=(r=!1)=>{const o=r?T("selectedSoftwareId"):"";y({selectedSoftwareId:o,title:"",selectedVersionId:"",typedVersionString:"",inputMode:"url",externalUrl:"",selectedFile:null,description:"",compatibleVmsVersionIds:[]}),W(null),_.current&&(_.current.value="")},de=r=>{r.target.files&&r.target.files[0]?p("selectedFile",r.target.files[0],{shouldValidate:!0,shouldDirty:!0}):p("selectedFile",null,{shouldValidate:!0,shouldDirty:!0})},Se=()=>{p("selectedFile",null,{shouldValidate:!0,shouldDirty:!0}),_.current&&(_.current.value="")},ce=async r=>{var U,F,P,te;E(!0),r.inputMode==="upload"&&r.selectedFile&&be(!0),we(0);let o,x;r.selectedVersionId===re&&r.typedVersionString?x=r.typedVersionString.trim():r.selectedVersionId&&r.selectedVersionId!==re&&(o=parseInt(r.selectedVersionId));const k={software_id:parseInt(r.selectedSoftwareId),title:r.title.trim(),description:((U=r.description)==null?void 0:U.trim())||void 0};o&&(k.version_id=o),x&&(k.typed_version_string=x),ae&&r.compatibleVmsVersionIds&&r.compatibleVmsVersionIds.length>0&&(k.compatible_vms_version_ids=r.compatibleVmsVersionIds);try{let N;if(r.inputMode==="url"){const m={...k,url:r.externalUrl.trim(),is_external_link:!0};d&&a?(N=await St(a.id,m),$(`Link "${N.title}" updated successfully!`),b&&b(N)):(N=await jt(m),$(`Link "${N.title}" added successfully!`),w&&w(N),d||(ee(!0),p("selectedVersionId",""),p("typedVersionString","")))}else{if(!r.selectedFile){if(d&&a&&!a.is_external_link&&!r.selectedFile){u("To update metadata of an existing uploaded file link without re-uploading, use a different form/feature. To replace the file, select a new file."),E(!1);return}if(!r.selectedFile&&!d){u("No file selected for upload."),E(!1);return}}const m={software_id:r.selectedSoftwareId,...o&&{version_id:o.toString()},...x&&{typed_version_string:x},link_title:r.title.trim(),description:((F=r.description)==null?void 0:F.trim())||"",...ae&&r.compatibleVmsVersionIds&&r.compatibleVmsVersionIds.length>0&&{compatible_vms_version_ids_json:JSON.stringify(r.compatibleVmsVersionIds)}};N=await Nt(r.selectedFile,"link_file",m,se=>we(se)),$(`Link file "${N.title}" added successfully via chunked upload!`),w&&w(N),ee(!0),p("selectedVersionId",""),p("typedVersionString","")}}catch(N){const m=((te=(P=N.response)==null?void 0:P.data)==null?void 0:te.msg)||N.message||`Failed to ${d&&r.inputMode==="url"?"update":"add"} link.`;u(m),r.inputMode==="upload"&&be(!1)}finally{E(!1),r.inputMode==="upload"&&be(!1)}},je=r=>{console.error("Form validation errors:",r),u("Please correct the errors highlighted in the form.")};return!ie||!Z||!["admin","super_admin"].includes(Z)?null:e.jsxs("form",{onSubmit:ge(ce,je),className:"space-y-6 bg-white dark:bg-gray-800 dark:border-gray-700 p-6 rounded-lg shadow-md border border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-xl font-semibold text-gray-800 dark:text-gray-100",children:[" ",d?"Edit Link":"Add New Link"," "]}),d&&q&&e.jsx("button",{type:"button",onClick:q,className:"text-sm text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200",children:" Cancel "})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedSoftwareId",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Software Product*"}),G&&!V.length?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading software..."}):e.jsxs("select",{id:"selectedSoftwareId",...h("selectedSoftwareId"),disabled:v||G&&!V.length,className:`mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${c.selectedSoftwareId?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",disabled:!0,children:"Select Software Product"}),V.map(r=>e.jsx("option",{value:r.id.toString(),children:r.name},r.id))]}),c.selectedSoftwareId&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:c.selectedSoftwareId.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedVersionId",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Version*"}),e.jsx("div",{className:"mt-1",children:e.jsxs("select",{id:"selectedVersionId",...h("selectedVersionId"),disabled:v||G||!S,className:`block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${c.selectedVersionId?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",disabled:R.length>0&&!!S,children:G&&S?"Loading versions...":"Select Existing Version"}),R.map(r=>e.jsx("option",{value:r.id.toString(),children:r.version_number},r.id)),e.jsx("option",{value:re,children:"Enter New Version String..."})]})}),oe&&e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{htmlFor:"typedVersionString",className:"block text-xs font-medium text-gray-600 dark:text-gray-400",children:"New Version String*:"}),e.jsx("input",{type:"text",id:"typedVersionString",...h("typedVersionString"),placeholder:"e.g., 1.2.4-final",className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${c.typedVersionString?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"This version will be created for the selected software if it doesn't exist."})]}),c.selectedVersionId&&!oe&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:c.selectedVersionId.message}),c.typedVersionString&&oe&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:c.typedVersionString.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"title",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Link Title*"}),e.jsx("input",{type:"text",id:"title",...h("title"),disabled:v,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${c.title?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),c.title&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:c.title.message})]}),ae&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"compatibleVmsVersionIds",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Compatible VMS Versions (for VMS/VA Links)"}),A?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading VMS versions..."}):e.jsx(zt,{name:"compatibleVmsVersionIds",control:X,defaultValue:[],render:({field:r})=>e.jsx("div",{className:"mt-1 block w-full max-h-40 overflow-y-auto p-2 border border-gray-300 rounded-md bg-white dark:bg-gray-700 dark:border-gray-600",children:xe.length===0?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"No VMS versions available."}):xe.map(o=>{var x;return e.jsxs("label",{className:"flex items-center space-x-2 p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:[e.jsx("input",{type:"checkbox",className:"form-checkbox h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-900 dark:checked:bg-blue-500",value:o.id.toString(),checked:((x=r.value)==null?void 0:x.includes(o.id.toString()))||!1,onChange:k=>{const U=k.target.value,F=r.value||[],P=k.target.checked?[...F,U]:F.filter(te=>te!==U);r.onChange(P)},disabled:v||A}),e.jsx("span",{className:"text-sm font-medium text-gray-800 dark:text-gray-200",children:o.version_number})]},o.id)})})}),c.compatibleVmsVersionIds&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:c.compatibleVmsVersionIds.message}),e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"Select VMS versions this link is compatible with. Only applicable if the link is for 'VMS' or 'VA' software."})]}),e.jsxs("div",{className:"my-4",children:[e.jsx("span",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Link Source:"}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",...h("inputMode"),value:"url",className:"form-radio h-4 w-4 text-blue-600",disabled:v}),e.jsxs("span",{className:"flex items-center dark:text-gray-300",children:[e.jsx(st,{size:16,className:"mr-1 text-gray-600 dark:text-gray-400"}),"Provide External URL"]})]}),e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",...h("inputMode"),value:"upload",className:"form-radio h-4 w-4 text-blue-600",disabled:v}),e.jsxs("span",{className:"flex items-center dark:text-gray-300",children:[e.jsx(Rt,{size:16,className:"mr-1 text-gray-600 dark:text-gray-400"}),"Upload File for this Link"]})]})]}),c.inputMode&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:c.inputMode.message})]}),Q==="url"&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"externalUrl",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Link URL*"}),e.jsx("input",{type:"url",id:"externalUrl",...h("externalUrl"),placeholder:"https://example.com/resource",disabled:v,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${c.externalUrl?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),c.externalUrl&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:c.externalUrl.message})]}),Q==="upload"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:d&&Y&&!L?"Replace File (Optional)":"Select File to Upload*"}),e.jsx("div",{className:"mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-blue-500 dark:border-gray-600 dark:hover:border-blue-400 transition-colors",children:e.jsxs("div",{className:"space-y-1 text-center",children:[e.jsx(Ye,{className:"mx-auto h-12 w-12 text-gray-400 dark:text-gray-500"}),e.jsxs("div",{className:"flex text-sm text-gray-600 dark:text-gray-400",children:[e.jsxs("label",{htmlFor:"link-file-upload-input",className:"relative cursor-pointer bg-white dark:bg-gray-800 rounded-md font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500",children:[e.jsx("span",{children:L?"Change file":"Upload a file"}),e.jsx("input",{id:"link-file-upload-input",name:"file-input-element",type:"file",className:"sr-only",onChange:de,ref:_,disabled:v})]}),e.jsx("p",{className:"pl-1",children:"or drag and drop"})]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Any file type relevant for links."})]})}),(L||d&&Y)&&e.jsxs("div",{className:"mt-3 flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md",children:[e.jsxs("div",{className:"flex items-center space-x-2 overflow-hidden",children:[e.jsx(Ye,{size:18,className:"text-gray-500 dark:text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:L?L.name:Y}),d&&Y&&!L&&e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 ml-2",children:"(current)"})]}),L&&e.jsx("button",{type:"button",onClick:Se,disabled:v,className:"p-1 rounded-full text-gray-400 hover:text-gray-600 hover:bg-gray-200 dark:text-gray-500 dark:hover:text-gray-300 dark:hover:bg-gray-600",children:e.jsx(wt,{size:16})})]}),c.selectedFile&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:c.selectedFile.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Description"}),e.jsx("textarea",{id:"description",rows:3,...h("description"),disabled:v,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${c.description?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),c.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:c.description.message})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{type:"submit",disabled:v||G,className:"flex-1 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",children:v?d?"Updating...":"Adding...":d?"Update Link":"Add Link"}),d&&q&&e.jsx("button",{type:"button",onClick:q,disabled:v,className:"flex-1 inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 dark:border-gray-500 dark:text-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600",children:"Cancel"})]}),v&&Q==="upload"&&he>0&&e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 my-3 relative",children:[e.jsx("div",{className:"bg-blue-600 h-4 rounded-full transition-all duration-150 ease-out",style:{width:`${he}%`}}),e.jsxs("p",{className:"absolute inset-0 text-center text-xs font-medium leading-4 text-white dark:text-gray-100",children:[Math.round(he),"%"]})]})]})},cs=()=>{const{searchTerm:a,setSearchTerm:w}=Vt(),{isAuthenticated:b,user:q}=et(),d=q==null?void 0:q.role,[h,ge]=s.useState([]),[X,c]=s.useState([]),[T,p]=s.useState([]),[y,V]=s.useState(null),[z,R]=s.useState(null),[I,xe]=s.useState(""),[C,ae]=s.useState(""),[M,Y]=s.useState(""),[W,v]=s.useState(""),[E,G]=s.useState(""),[K,A]=s.useState(1),[le,he]=s.useState(15),[we,pe]=s.useState(0),[be,ie]=s.useState(0),[D,Z]=s.useState("title"),[_,S]=s.useState("asc"),[ne,Q]=s.useState(!0),[L,oe]=s.useState(null),[ee,de]=s.useState(!1),[Se,ce]=s.useState(null),[je,r]=s.useState(!1),[o,x]=s.useState(null),[k,U]=s.useState(!1),[F,P]=s.useState(new Map),[te,N]=s.useState(!1),[m,se]=s.useState(new Set),[De,Ue]=s.useState(!1),[rt,Pe]=s.useState(!1),[me,Oe]=s.useState(!1),[$e,Ne]=s.useState(!1),[B,Le]=s.useState(null),[ze,Re]=s.useState([]),[Ve,_e]=s.useState(void 0),[Ee,Fe]=s.useState(!1),[Ce,Be]=s.useState(!1),[j,ye]=s.useState(null),Ie=s.useRef(null),qe=_t(),Me=s.useMemo(()=>y!==null||z!==null||I!==""||C!==""||M!==""||a!=="",[y,z,I,C,M,a]),Te=s.useCallback(()=>{V(null),R(null),xe(""),ae(""),Y(""),w&&w(""),A(1)},[w]),O=s.useCallback(async(t,l=!1)=>{var i,f;l&&Q(!0),oe(null);try{const n=await It(y||void 0,z||void 0,t,le,D,_,I||void 0,W||void 0,E||void 0,a);ge(n.links),pe(n.total_pages),ie(n.total_links),A(n.page),he(n.per_page);const g=new Map;b&&n.links&&n.links.forEach(ke=>g.set(ke.id,{favoriteId:ke.favorite_id})),P(g)}catch(n){const g=((f=(i=n.response)==null?void 0:i.data)==null?void 0:f.msg)||n.message||"Failed to fetch links.";l?(oe(g),ge([]),pe(0),ie(0)):u(g)}finally{l&&Q(!1)}},[y,z,le,D,_,I,W,E,b,a]);s.useEffect(()=>{const t=setTimeout(()=>v(C),500);return()=>clearTimeout(t)},[C]),s.useEffect(()=>{const t=setTimeout(()=>G(M),500);return()=>clearTimeout(t)},[M]),s.useEffect(()=>{b?tt().then(c).catch(t=>u("Failed to load software list.")):c([])},[b]),s.useEffect(()=>{b?O(1,!0):(ge([]),Q(!1))},[b,y,z,D,_,I,W,E,a,O]),s.useEffect(()=>{se(new Set)},[y,z,D,_,I,W,E,a,K]),s.useEffect(()=>{y?ve(y).then(p).catch(()=>{u("Failed to load versions for filter."),p([])}):p([])},[y]),s.useEffect(()=>{const t=new URLSearchParams(qe.search),l=t.get("item_id"),i=t.get("comment_id");if(l&&i&&h.length>0){const f=parseInt(l,10);if(!isNaN(f)){const n=h.find(g=>g.id===f);n?((!j||j.id!==n.id)&&ye(n),setTimeout(()=>{var g;(g=Ie.current)==null||g.scrollIntoView({behavior:"smooth",block:"center"})},100)):console.warn(`LinksView: Link with item_id ${f} not found in the current list.`)}}},[qe.search,h,j]),s.useEffect(()=>{B?(Be(!0),ve(B).then(Re).catch(()=>u("Failed to load versions for move.")).finally(()=>Be(!1))):Re([])},[B]);const at=t=>{V(t),R(null),A(1)},lt=t=>{R(t.target.value?parseInt(t.target.value):null),A(1)},it=t=>{A(t),O(t,!0)},nt=t=>{Z(t),S(l=>D===t&&l==="asc"?"desc":"asc"),A(1)},ot=()=>{A(1),O(1,!0)},We=async t=>{if(de(!1),ce(null),await O(1,!0),y)try{const l=await ve(y);p(l)}catch(l){console.error("Error refreshing version list after operation:",l),u("Failed to refresh version list for the current software filter.")}},dt=()=>{ce(null),de(!0)},ct=t=>{ce(t),de(!0),window.scrollTo({top:0,behavior:"smooth"})},He=()=>{ce(null),de(!1)},mt=t=>{x(t),r(!0)},Ae=()=>{x(null),r(!1)},ut=async()=>{if(o){U(!0),j&&j.id===o.id&&ye(null);try{await At(o.id),$(`Link "${o.title}" deleted.`),Ae(),O(1,!0)}catch(t){u(t.message||"Delete failed."),Ae()}finally{U(!1)}}},ft=(t,l)=>se(i=>{const f=new Set(i);return l?f.add(t):f.delete(t),f}),gt=t=>{const l=new Set;t&&h.forEach(i=>l.add(i.id)),se(l)},xt=()=>{if(m.size===0){u("No items selected.");return}Fe(!0)},ht=async()=>{Fe(!1),Ue(!0),j&&m.has(j.id)&&ye(null);try{const t=await Dt(Array.from(m),"link");$(t.msg||`${t.deleted_count} link(s) deleted.`),se(new Set),O(1,!0)}catch(t){u(t.message||"Bulk delete failed.")}finally{Ue(!1)}},Je=s.useMemo(()=>h.filter(t=>m.has(t.id)&&!t.is_external_link&&t.stored_filename).length,[h,m]),pt=async()=>{if(m.size===0){u("No items selected.");return}const t=h.filter(i=>m.has(i.id)&&!i.is_external_link&&i.stored_filename);if(t.length===0){u("No downloadable files among selected links. External links or links without files cannot be bulk downloaded.");return}const l=t.map(i=>i.id);l.length<m.size&&$(`Starting download for ${l.length} file-based links. External links were excluded.`),Pe(!0);try{const i=await Ft(l,"link"),f=URL.createObjectURL(i),n=document.createElement("a");n.href=f;const g=new Date().toISOString().replace(/:/g,"-");n.download=`bulk_download_links_${g}.zip`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(f),l.length===m.size&&$("Download started.")}catch(i){u(i.message||"Bulk download failed.")}finally{Pe(!1)}},bt=()=>{if(m.size===0){u("No items selected.");return}if(X.length===0){u("Software list unavailable.");return}Le(null),_e(void 0),Ne(!0)},yt=async()=>{if(!B){u("Select target software.");return}Ne(!1),Oe(!0);const t={target_software_id:B};Ve!==void 0&&(t.target_version_id=Ve);try{const l=await Ut(Array.from(m),"link",t);$(l.msg||`${l.moved_count} link(s) moved.`),se(new Set),O(1,!0)}catch(l){u(l.message||"Bulk move failed.")}finally{Oe(!1),Le(null),_e(void 0)}},kt=[{key:"title",header:"Title",sortable:!0},{key:"software_name",header:"Software",sortable:!0},{key:"version_name",header:"Version",sortable:!0,render:t=>t.version_name||"N/A"},{key:"compatible_vms_versions",header:"VMS Compatibility",sortable:!0,render:t=>{const l=t.software_name==="VMS"||t.software_name==="VA";let i="-";return l&&(t.compatible_vms_versions&&t.compatible_vms_versions.length>0?Array.isArray(t.compatible_vms_versions)?i=t.compatible_vms_versions.join(", "):typeof t.compatible_vms_versions=="string"?i=t.compatible_vms_versions:i="N/A":i="N/A"),e.jsx("div",{className:"text-center",children:i})}},{key:"description",header:"Description",render:t=>e.jsx("span",{className:"text-sm text-gray-600 block max-w-xs truncate",title:t.description||"",children:t.description||"-"})},{key:"url",header:"Link",render:t=>{var n;const l=t.is_external_link||t.is_downloadable!==!1,i="Link",f=Ge;return!l&&!t.is_external_link?e.jsxs("span",{className:"flex items-center text-gray-400 cursor-not-allowed",title:"Download not permitted",children:[e.jsx(f,{size:14,className:"mr-1 flex-shrink-0"}),i]}):e.jsxs("a",{href:t.url,target:t.is_external_link||!((n=t.url)!=null&&n.startsWith("/"))?"_blank":"_self",rel:"noopener noreferrer",className:`flex items-center ${l?"text-blue-600 hover:text-blue-800":"text-gray-400 cursor-not-allowed"}`,onClick:g=>{l||g.preventDefault(),g.stopPropagation()},title:l?t.is_external_link?"Open external link":"Download file":"Download not permitted",children:[e.jsx(f,{size:14,className:"mr-1 flex-shrink-0"}),i]})}},{key:"uploaded_by_username",header:"Added By",sortable:!0,render:t=>t.uploaded_by_username||"N/A"},{key:"updated_by_username",header:"Updated By",sortable:!1,render:t=>t.updated_by_username||"N/A"},{key:"created_at",header:"Created",sortable:!0,render:t=>Ke(t.created_at??"")},{key:"updated_at",header:"Updated",sortable:!0,render:t=>Ke(t.updated_at??"")},{key:"actions",header:"Actions",render:t=>{var l,i,f;return e.jsxs("div",{className:"flex space-x-1 items-center",children:[b&&e.jsx("button",{onClick:n=>{n.stopPropagation(),vt(t,"link")},className:`p-1 rounded-md ${(l=F.get(t.id))!=null&&l.favoriteId?"text-yellow-500 hover:text-yellow-600":"text-gray-400 hover:text-yellow-500"}`,title:(i=F.get(t.id))!=null&&i.favoriteId?"Remove Favorite":"Add Favorite",children:e.jsx(Ct,{size:16,className:(f=F.get(t.id))!=null&&f.favoriteId?"fill-current":""})}),b&&e.jsxs("button",{onClick:n=>{n.stopPropagation(),j&&j.id===t.id?ye(null):(ye(t),setTimeout(()=>{var g;return(g=Ie.current)==null?void 0:g.scrollIntoView({behavior:"smooth"})},0))},className:"p-1 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 rounded-md",title:j&&j.id===t.id?"Hide Comments":"View Comments",children:[e.jsx(Mt,{size:16}),e.jsxs("span",{className:"ml-1 text-xs",children:["(",t.comment_count??0,")"]})]}),(d==="admin"||d==="super_admin")&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:n=>{n.stopPropagation(),ct(t)},className:"p-1 text-blue-600 hover:text-blue-800 rounded-md",title:"Edit",children:e.jsx(Xt,{size:16})}),e.jsx("button",{onClick:n=>{n.stopPropagation(),mt(t)},className:"p-1 text-red-600 hover:text-red-800 rounded-md",title:"Delete",children:e.jsx(Ze,{size:16})})]})]})}}],Xe=s.useCallback(()=>{O(1,!0)},[O]),vt=async(t,l)=>{var g,ke;if(!b){u("Please log in to manage favorites.");return}const i=F.get(t.id),f=!!(i!=null&&i.favoriteId),n=new Map(F);f?n.set(t.id,{favoriteId:void 0}):n.set(t.id,{favoriteId:-1}),P(n);try{if(f&&typeof(i==null?void 0:i.favoriteId)=="number")await Pt(t.id,l),$(`"${t.title}" removed from favorites.`),P(H=>{const ue=new Map(H);return ue.set(t.id,{favoriteId:void 0}),ue});else{const H=await Ot(t.id,l);P(ue=>{const fe=new Map(ue);return fe.set(t.id,{favoriteId:H.id}),fe}),$(`"${t.title}" added to favorites.`)}}catch(H){u(((ke=(g=H==null?void 0:H.response)==null?void 0:g.data)==null?void 0:ke.msg)||H.message||"Failed to update favorite."),P(ue=>{const fe=new Map(ue);return f?fe.set(t.id,{favoriteId:i==null?void 0:i.favoriteId}):fe.set(t.id,{favoriteId:void 0}),fe})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-start sm:items-center mb-6 flex-col sm:flex-row",children:[e.jsxs("div",{children:[" ",e.jsx("h2",{className:"text-2xl font-bold text-gray-800 dark:text-white",children:"Links"})," ",e.jsx("p",{className:"text-gray-600 mt-1 dark:text-gray-300",children:"Manage and browse useful links and resources."})," "]}),b&&(d==="admin"||d==="super_admin")&&!Se&&e.jsxs("button",{onClick:()=>{ee?He():dt()},className:"mt-4 sm:mt-0 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx(es,{size:18,className:"mr-2"})," ",ee?"Cancel":"Add New Link"]})]}),ee&&e.jsx("div",{className:"my-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow",children:e.jsx(ss,{linkToEdit:Se,onLinkAdded:()=>We(),onLinkUpdated:()=>We(),onCancelEdit:He})}),m.size>0&&e.jsx("div",{className:"my-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:[m.size," item(s) selected"]}),(d==="admin"||d==="super_admin")&&e.jsxs("button",{onClick:xt,disabled:De,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-800 focus:ring-red-500 disabled:opacity-50",children:[e.jsx(Ze,{size:14,className:"mr-1.5"}),"Delete"]}),b&&e.jsxs("button",{onClick:pt,disabled:rt||Je===0,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-green-500 hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 focus:ring-green-500 disabled:opacity-50",children:[e.jsx(Ge,{size:14,className:"mr-1.5"}),"Download (",Je,")"]}),(d==="admin"||d==="super_admin")&&e.jsxs("button",{onClick:bt,disabled:me,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 focus:ring-blue-500 disabled:opacity-50",children:[e.jsx(Wt,{size:14,className:"mr-1.5"}),"Move"]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:gap-4 -mt-20",children:[X.length>0&&e.jsx("div",{className:"w-fit flex-shrink-0",children:e.jsx(Kt,{software:X,selectedSoftwareId:y,onSelectFilter:at})}),y&&e.jsx("div",{className:"flex items-center gap-2 min-w-[200px] mt-4 md:mt-0 flex-shrink-0",children:e.jsxs("select",{id:"versionFilterLinks",value:z||"",onChange:lt,className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200",disabled:T.length===0,children:[e.jsx("option",{value:"",children:"Version"}),T.map(t=>e.jsx("option",{value:t.id,children:t.version_number},t.id))]})})]}),e.jsx("div",{className:"mb-4 mt-0",children:e.jsxs("button",{onClick:()=>N(t=>!t),className:"flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-md text-sm font-medium",children:[te?e.jsx(Yt,{size:18,className:"mr-1.5"}):e.jsx(Ht,{size:18,className:"mr-1.5"})," Advanced Filters"]})}),te&&e.jsxs("div",{className:"my-4 p-4 border dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 space-y-4 md:space-y-0 md:flex md:flex-wrap md:items-end md:gap-4",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{htmlFor:"linkTypeFilterSelect",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Link Type"}),e.jsxs("select",{id:"linkTypeFilterSelect",value:I,onChange:t=>xe(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200",children:[e.jsx("option",{value:"",children:"All"})," ",e.jsx("option",{value:"external",children:"External URL"})," ",e.jsx("option",{value:"uploaded",children:"Uploaded File"})]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Created Between"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"date",value:C,onChange:t=>ae(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"to"}),e.jsx("input",{type:"date",value:M,onChange:t=>Y(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"})]})]}),e.jsxs("div",{className:"flex items-end gap-2 pt-5",children:[e.jsx("button",{onClick:ot,className:"text-sm px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"Apply"}),e.jsx("button",{onClick:Te,className:"text-sm px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500",children:"Clear All"})]})]}),ne?e.jsx("div",{className:"py-10",children:e.jsx(Lt,{message:"Loading links..."})}):L&&h.length===0&&!ne?e.jsx(Zt,{message:L,onRetry:Xe}):!ne&&!L&&h.length===0?e.jsxs("div",{className:"text-center py-10 bg-white dark:bg-gray-800 rounded-lg shadow-sm my-6",children:[e.jsx(st,{size:48,className:"mx-auto text-yellow-500 dark:text-yellow-400 mb-4"}),e.jsx("p",{className:"text-xl font-semibold text-gray-700 dark:text-gray-200 mb-3",children:Me?"No Links Found Matching Criteria":"No Links Available"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 px-4",children:Me?"Try adjusting or clearing your search/filter settings.":d==="admin"||d==="super_admin"?"Add new links to get started.":"Please check back later."}),Me&&e.jsx("button",{onClick:Te,className:"mt-6 btn-primary text-sm",children:"Clear All Filters & Search"})]}):e.jsx(Gt,{columns:kt,data:h,rowClassName:"group",isLoading:ne||k,currentPage:K,totalPages:we,onPageChange:it,itemsPerPage:le,totalItems:be,sortColumn:D,sortOrder:_,onSort:nt,isSelectionEnabled:!0,selectedItemIds:m,onSelectItem:ft,onSelectAllItems:gt}),je&&o&&e.jsx(Qe,{isOpen:je,title:"Delete Link",message:`Delete "${o.title}"?`,onConfirm:ut,onCancel:Ae,isConfirming:k,confirmButtonText:"Delete",confirmButtonVariant:"danger"}),Ee&&e.jsx(Qe,{isOpen:Ee,title:`Delete ${m.size} Link(s)`,message:`Delete ${m.size} selected items?`,onConfirm:ht,onCancel:()=>Fe(!1),isConfirming:De,confirmButtonText:"Delete Selected",confirmButtonVariant:"danger"}),$e&&e.jsx(Qt,{isOpen:$e,onClose:()=>Ne(!1),title:`Move ${m.size} Link(s)`,children:e.jsxs("div",{className:"p-4",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mb-2",children:"Select target Software and optionally a Version:"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"modalSoftwareMoveLinks",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Target Software*"}),e.jsxs("select",{id:"modalSoftwareMoveLinks",value:B??"",onChange:t=>{Le(t.target.value?parseInt(t.target.value):null),_e(void 0)},className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white",disabled:me||X.length===0,children:[e.jsx("option",{value:"",children:"Select Software..."}),X.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),B&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"modalVersionMoveLinks",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Target Version (Optional)"}),e.jsxs("select",{id:"modalVersionMoveLinks",value:Ve===null?"NULL_VERSION":Ve??"",onChange:t=>_e(t.target.value==="NULL_VERSION"?null:t.target.value?parseInt(t.target.value):void 0),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white",disabled:me||Ce,children:[e.jsx("option",{value:"",children:Ce?"Loading...":"Select Version (Optional)..."}),e.jsx("option",{value:"NULL_VERSION",children:"No Specific Version (Clear Association)"}),ze.map(t=>e.jsx("option",{value:t.id,children:t.version_number},t.id))]}),ze.length===0&&!Ce&&B&&e.jsx("p",{className:"text-xs text-yellow-600 mt-1",children:"No versions for selected software. You can still move to the software without a specific version."})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[e.jsx("button",{type:"button",onClick:()=>Ne(!1),className:"px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500",disabled:me,children:"Cancel"}),e.jsx("button",{type:"button",onClick:yt,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",disabled:me||!B,children:me?"Moving...":"Confirm Move"})]})]})}),b&&j&&e.jsxs("div",{ref:Ie,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("h3",{className:"text-xl font-semibold text-gray-800 dark:text-white mb-4",children:["Comments for: ",e.jsx("span",{className:"font-bold text-blue-600 dark:text-blue-400",children:j.title})]}),e.jsx(Jt,{itemId:j.id,itemType:"link",onCommentAction:Xe})]}),!b&&j&&e.jsx("div",{ref:Ie,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 text-center",children:e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Please log in to view and manage comments."})})]})};export{cs as default};
