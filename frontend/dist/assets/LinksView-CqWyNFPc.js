import{r as s,u as Je,f as Qe,s as u,q as we,j as e,L as et,F as He,X as vt,y as St,a as M,z as jt,c as Nt,d as It,g as Lt,A as _t,i as Ft,k as Ct,S as Vt,B as Mt,m as At,n as Dt,o as Ut,p as Pt}from"./index-D5Qs25Th.js";import{u as zt,U as $t,o as Et,c as Rt,a as X,b as Ot,P as Bt,T as Xe,D as Ye,M as Tt,F as qt,C as Wt,e as Kt,d as Zt}from"./CommentSection-DP3lpp68.js";import{C as Ht,D as Xt,a as Ge,M as Yt}from"./Modal-Brzi7e9x.js";import{F as Gt}from"./FilterTabs-DzGz_gOS.js";import{E as Jt}from"./ErrorState-CzdUF6B1.js";const Y="CREATE_NEW_VERSION_SENTINEL_VALUE",Qt=Rt().shape({selectedSoftwareId:X().required("Software Product must be selected."),title:X().required("Link Title is required.").max(255,"Title cannot exceed 255 characters."),selectedVersionId:X().required("Version must be selected or a new one entered."),typedVersionString:X().when("selectedVersionId",{is:Y,then:r=>r.required('New Version String is required when "Enter New Version" is selected.').min(1,"New Version String cannot be empty."),otherwise:r=>r.transform(y=>y===""?void 0:y).optional().nullable()}),inputMode:X().oneOf(["url","upload"]).required("Input mode must be selected."),externalUrl:X().when("inputMode",{is:"url",then:r=>r.required("External URL is required for URL mode.").url("Please enter a valid URL (e.g., http://example.com)."),otherwise:r=>r.optional().nullable()}),selectedFile:Ot().when(["inputMode","isEditMode","existingFileName"],{is:(r,y,x)=>r==="upload"&&(!y||!x),then:r=>r.required("A file is required for new link uploads.").test("filePresent","A file is required for new link uploads.",y=>!!y),otherwise:r=>r.nullable()}),description:X().optional().max(1e3,"Description cannot exceed 1000 characters.")}),es=({linkToEdit:r,onLinkAdded:y,onLinkUpdated:x,onCancelEdit:E})=>{const o=!!r,{register:g,handleSubmit:ie,control:G,formState:{errors:d},watch:R,setValue:f,reset:h}=zt({resolver:Et(Qt),context:{isEditMode:o,existingFileName:(r==null?void 0:r.original_filename_ref)||(r&&!r.is_external_link?r.url.split("/").pop():null)},defaultValues:{selectedSoftwareId:"",title:"",selectedVersionId:"",typedVersionString:"",inputMode:"url",externalUrl:"",selectedFile:null,description:""}}),[J,A]=s.useState([]),[D,N]=s.useState([]),[T,U]=s.useState(null),[b,_]=s.useState(!1),[O,P]=s.useState(!1),[le,q]=s.useState(0),{isAuthenticated:oe,user:Q}=Je(),v=Q==null?void 0:Q.role,I=s.useRef(null),L=R("selectedSoftwareId"),ve=R("selectedVersionId"),ee=R("inputMode"),z=R("selectedFile"),te=ve===Y;s.useEffect(()=>{oe&&(v==="admin"||v==="super_admin")&&(P(!0),Qe().then(A).catch(()=>u("Failed to load software list.")).finally(()=>P(!1)))},[oe,v]),s.useEffect(()=>{L?(P(!0),N([]),f("selectedVersionId",""),f("typedVersionString",""),we(parseInt(L)).then(N).catch(()=>u("Failed to load versions for selected software.")).finally(()=>P(!1))):(N([]),f("selectedVersionId",""),f("typedVersionString",""))},[L,f]),s.useEffect(()=>{if(o&&r){const a={selectedSoftwareId:r.software_id.toString(),title:r.title,description:r.description||"",inputMode:r.is_external_link?"url":"upload",externalUrl:r.is_external_link?r.url:""};r.version_id&&r.software_id.toString()===L&&D.length>0?D.find(C=>C.id===r.version_id)?(a.selectedVersionId=r.version_id.toString(),a.typedVersionString=r.version_number):(a.selectedVersionId=Y,a.typedVersionString=r.version_number):r.version_number&&(a.selectedVersionId=Y,a.typedVersionString=r.version_number),h(a),r.is_external_link?U(null):U(r.original_filename_ref||r.url.split("/").pop()||"unknown_file"),f("selectedFile",null),I.current&&(I.current.value="")}else o||F(!!L)},[o,r,h,f,D,L]);const F=(a=!1)=>{const j=a?R("selectedSoftwareId"):"";h({selectedSoftwareId:j,title:"",selectedVersionId:"",typedVersionString:"",inputMode:"url",externalUrl:"",selectedFile:null,description:""}),U(null),I.current&&(I.current.value="")},Se=a=>{a.target.files&&a.target.files[0]?f("selectedFile",a.target.files[0],{shouldValidate:!0,shouldDirty:!0}):f("selectedFile",null,{shouldValidate:!0,shouldDirty:!0})},W=()=>{f("selectedFile",null,{shouldValidate:!0,shouldDirty:!0}),I.current&&(I.current.value="")},je=async a=>{var Z,de,H,ce;_(!0),q(0);let j,C;a.selectedVersionId===Y&&a.typedVersionString?C=a.typedVersionString.trim():a.selectedVersionId&&a.selectedVersionId!==Y&&(j=parseInt(a.selectedVersionId));const K={software_id:parseInt(a.selectedSoftwareId),title:a.title.trim(),description:((Z=a.description)==null?void 0:Z.trim())||void 0};j&&(K.version_id=j),C&&(K.typed_version_string=C);try{let k;if(a.inputMode==="url"){const S={...K,url:a.externalUrl.trim(),is_external_link:!0};o&&r?(k=await St(r.id,S),M(`Link "${k.title}" updated successfully!`),x&&x(k)):(k=await jt(S),M(`Link "${k.title}" added successfully!`),y&&y(k),o||(F(!0),f("selectedVersionId",""),f("typedVersionString","")))}else{if(!a.selectedFile){if(o&&r&&!r.is_external_link&&!a.selectedFile){u("To update metadata of an existing uploaded file link without re-uploading, use a different form/feature. To replace the file, select a new file."),_(!1);return}if(!a.selectedFile&&!o){u("No file selected for upload."),_(!1);return}}const S={software_id:a.selectedSoftwareId,...j&&{version_id:j.toString()},...C&&{typed_version_string:C},link_title:a.title.trim(),description:((de=a.description)==null?void 0:de.trim())||""};k=await Nt(a.selectedFile,"link_file",S,he=>q(he)),M(`Link file "${k.title}" added successfully via chunked upload!`),y&&y(k),F(!0),f("selectedVersionId",""),f("typedVersionString","")}}catch(k){const S=((ce=(H=k.response)==null?void 0:H.data)==null?void 0:ce.msg)||k.message||`Failed to ${o&&a.inputMode==="url"?"update":"add"} link.`;u(S)}finally{_(!1)}},se=a=>{console.error("Form validation errors:",a),u("Please correct the errors highlighted in the form.")};return!oe||!v||!["admin","super_admin"].includes(v)?null:e.jsxs("form",{onSubmit:ie(je,se),className:"space-y-6 bg-white dark:bg-gray-800 dark:border-gray-700 p-6 rounded-lg shadow-md border border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-xl font-semibold text-gray-800 dark:text-gray-100",children:[" ",o?"Edit Link":"Add New Link"," "]}),o&&E&&e.jsx("button",{type:"button",onClick:E,className:"text-sm text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200",children:" Cancel "})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedSoftwareId",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Software Product*"}),O&&!J.length?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading software..."}):e.jsxs("select",{id:"selectedSoftwareId",...g("selectedSoftwareId"),disabled:b||O&&!J.length,className:`mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${d.selectedSoftwareId?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",disabled:!0,children:"Select Software Product"}),J.map(a=>e.jsx("option",{value:a.id.toString(),children:a.name},a.id))]}),d.selectedSoftwareId&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:d.selectedSoftwareId.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedVersionId",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Version*"}),e.jsx("div",{className:"mt-1",children:e.jsxs("select",{id:"selectedVersionId",...g("selectedVersionId"),disabled:b||O||!L,className:`block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${d.selectedVersionId?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",disabled:D.length>0&&!!L,children:O&&L?"Loading versions...":"Select Existing Version"}),D.map(a=>e.jsx("option",{value:a.id.toString(),children:a.version_number},a.id)),e.jsx("option",{value:Y,children:"Enter New Version String..."})]})}),te&&e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{htmlFor:"typedVersionString",className:"block text-xs font-medium text-gray-600 dark:text-gray-400",children:"New Version String*:"}),e.jsx("input",{type:"text",id:"typedVersionString",...g("typedVersionString"),placeholder:"e.g., 1.2.4-final",className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.typedVersionString?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"This version will be created for the selected software if it doesn't exist."})]}),d.selectedVersionId&&!te&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.selectedVersionId.message}),d.typedVersionString&&te&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.typedVersionString.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"title",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Link Title*"}),e.jsx("input",{type:"text",id:"title",...g("title"),disabled:b,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.title?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),d.title&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.title.message})]}),e.jsxs("div",{className:"my-4",children:[e.jsx("span",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Link Source:"}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",...g("inputMode"),value:"url",className:"form-radio h-4 w-4 text-blue-600",disabled:b}),e.jsxs("span",{className:"flex items-center dark:text-gray-300",children:[e.jsx(et,{size:16,className:"mr-1 text-gray-600 dark:text-gray-400"}),"Provide External URL"]})]}),e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",...g("inputMode"),value:"upload",className:"form-radio h-4 w-4 text-blue-600",disabled:b}),e.jsxs("span",{className:"flex items-center dark:text-gray-300",children:[e.jsx($t,{size:16,className:"mr-1 text-gray-600 dark:text-gray-400"}),"Upload File for this Link"]})]})]}),d.inputMode&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.inputMode.message})]}),ee==="url"&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"externalUrl",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Link URL*"}),e.jsx("input",{type:"url",id:"externalUrl",...g("externalUrl"),placeholder:"https://example.com/resource",disabled:b,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.externalUrl?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),d.externalUrl&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.externalUrl.message})]}),ee==="upload"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:o&&T&&!z?"Replace File (Optional)":"Select File to Upload*"}),e.jsx("div",{className:"mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-blue-500 dark:border-gray-600 dark:hover:border-blue-400 transition-colors",children:e.jsxs("div",{className:"space-y-1 text-center",children:[e.jsx(He,{className:"mx-auto h-12 w-12 text-gray-400 dark:text-gray-500"}),e.jsxs("div",{className:"flex text-sm text-gray-600 dark:text-gray-400",children:[e.jsxs("label",{htmlFor:"link-file-upload-input",className:"relative cursor-pointer bg-white dark:bg-gray-800 rounded-md font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500",children:[e.jsx("span",{children:z?"Change file":"Upload a file"}),e.jsx("input",{id:"link-file-upload-input",name:"file-input-element",type:"file",className:"sr-only",onChange:Se,ref:I,disabled:b})]}),e.jsx("p",{className:"pl-1",children:"or drag and drop"})]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Any file type relevant for links."})]})}),(z||o&&T)&&e.jsxs("div",{className:"mt-3 flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md",children:[e.jsxs("div",{className:"flex items-center space-x-2 overflow-hidden",children:[e.jsx(He,{size:18,className:"text-gray-500 dark:text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:z?z.name:T}),o&&T&&!z&&e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 ml-2",children:"(current)"})]}),z&&e.jsx("button",{type:"button",onClick:W,disabled:b,className:"p-1 rounded-full text-gray-400 hover:text-gray-600 hover:bg-gray-200 dark:text-gray-500 dark:hover:text-gray-300 dark:hover:bg-gray-600",children:e.jsx(vt,{size:16})})]}),d.selectedFile&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.selectedFile.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Description"}),e.jsx("textarea",{id:"description",rows:3,...g("description"),disabled:b,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.description?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),d.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.description.message})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{type:"submit",disabled:b||O,className:"flex-1 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",children:b?o?"Updating...":"Adding...":o?"Update Link":"Add Link"}),o&&E&&e.jsx("button",{type:"button",onClick:E,disabled:b,className:"flex-1 inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 dark:border-gray-500 dark:text-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600",children:"Cancel"})]}),b&&ee==="upload"&&le>0&&e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 my-3 relative",children:[e.jsx("div",{className:"bg-blue-600 h-4 rounded-full transition-all duration-150 ease-out",style:{width:`${le}%`}}),e.jsxs("p",{className:"absolute inset-0 text-center text-xs font-medium leading-4 text-white dark:text-gray-100",children:[Math.round(le),"%"]})]})]})},is=()=>{const{searchTerm:r,setSearchTerm:y}=It(),{isAuthenticated:x,user:E}=Je(),o=E==null?void 0:E.role,[g,ie]=s.useState([]),[G,d]=s.useState([]),[R,f]=s.useState([]),[h,J]=s.useState(null),[A,D]=s.useState(null),[N,T]=s.useState(""),[U,b]=s.useState(""),[_,O]=s.useState(""),[P,le]=s.useState(""),[q,oe]=s.useState(""),[Q,v]=s.useState(1),[I,L]=s.useState(15),[ve,ee]=s.useState(0),[z,te]=s.useState(0),[F,Se]=s.useState("title"),[W,je]=s.useState("asc"),[se,a]=s.useState(!0),[j,C]=s.useState(null),[K,Z]=s.useState(!1),[de,H]=s.useState(null),[ce,k]=s.useState(!1),[S,he]=s.useState(null),[Ce,Ve]=s.useState(!1),[ue,me]=s.useState(new Map),[Me,tt]=s.useState(!1),[p,ge]=s.useState(new Set),[Ae,De]=s.useState(!1),[st,Ue]=s.useState(!1),[re,Pe]=s.useState(!1),[ze,pe]=s.useState(!1),[$,Ne]=s.useState(null),[$e,Ee]=s.useState([]),[be,ye]=s.useState(void 0),[Re,Ie]=s.useState(!1),[Le,Oe]=s.useState(!1),[w,fe]=s.useState(null),ke=s.useRef(null),Be=Lt(),_e=s.useMemo(()=>h!==null||A!==null||N!==""||U!==""||_!==""||r!=="",[h,A,N,U,_,r]),Te=s.useCallback(()=>{J(null),D(null),T(""),b(""),O(""),y&&y(""),v(1)},[y]),V=s.useCallback(async(t,n=!1)=>{var l,c;n&&a(!0),C(null);try{const i=await _t(h||void 0,A||void 0,t,I,F,W,N||void 0,P||void 0,q||void 0);ie(i.links),ee(i.total_pages),te(i.total_links),v(i.page),L(i.per_page);const m=new Map;x&&i.links&&i.links.forEach(xe=>m.set(xe.id,{favoriteId:xe.favorite_id})),me(m)}catch(i){const m=((c=(l=i.response)==null?void 0:l.data)==null?void 0:c.msg)||i.message||"Failed to fetch links.";n?(C(m),ie([]),ee(0),te(0)):u(m)}finally{n&&a(!1)}},[h,A,I,F,W,N,P,q,x]);s.useEffect(()=>{const t=setTimeout(()=>le(U),500);return()=>clearTimeout(t)},[U]),s.useEffect(()=>{const t=setTimeout(()=>oe(_),500);return()=>clearTimeout(t)},[_]),s.useEffect(()=>{x?Qe().then(d).catch(t=>u("Failed to load software list.")):d([])},[x]),s.useEffect(()=>{x?V(1,!0):(ie([]),a(!1))},[x,h,A,F,W,N,P,q,r,V]),s.useEffect(()=>{ge(new Set)},[h,A,F,W,N,P,q,r,Q]),s.useEffect(()=>{h?we(h).then(f).catch(()=>{u("Failed to load versions for filter."),f([])}):f([])},[h]),s.useEffect(()=>{const t=new URLSearchParams(Be.search),n=t.get("item_id"),l=t.get("comment_id");if(n&&l&&g.length>0){const c=parseInt(n,10);if(!isNaN(c)){const i=g.find(m=>m.id===c);i?((!w||w.id!==i.id)&&fe(i),setTimeout(()=>{var m;(m=ke.current)==null||m.scrollIntoView({behavior:"smooth",block:"center"})},100)):console.warn(`LinksView: Link with item_id ${c} not found in the current list.`)}}},[Be.search,g,w]),s.useEffect(()=>{$?(Oe(!0),we($).then(Ee).catch(()=>u("Failed to load versions for move.")).finally(()=>Oe(!1))):Ee([])},[$]);const rt=t=>{J(t),D(null),v(1)},at=t=>{D(t.target.value?parseInt(t.target.value):null),v(1)},nt=t=>{v(t),V(t,!0)},it=t=>{Se(t),je(n=>F===t&&n==="asc"?"desc":"asc"),v(1)},lt=()=>{v(1),V(1,!0)},qe=async t=>{if(Z(!1),H(null),await V(1,!0),h)try{const n=await we(h);f(n)}catch(n){console.error("Error refreshing version list after operation:",n),u("Failed to refresh version list for the current software filter.")}},ot=()=>{H(null),Z(!0)},dt=t=>{H(t),Z(!0),window.scrollTo({top:0,behavior:"smooth"})},We=()=>{H(null),Z(!1)},ct=t=>{he(t),k(!0)},Fe=()=>{he(null),k(!1)},ut=async()=>{if(S){Ve(!0),w&&w.id===S.id&&fe(null);try{await Mt(S.id),M(`Link "${S.title}" deleted.`),Fe(),V(1,!0)}catch(t){u(t.message||"Delete failed."),Fe()}finally{Ve(!1)}}},Ke=s.useMemo(()=>{if(!r)return g;const t=r.toLowerCase();return g.filter(n=>n.title.toLowerCase().includes(t)||(n.description||"").toLowerCase().includes(t)||(n.software_name||"").toLowerCase().includes(t)||(n.version_name||"").toLowerCase().includes(t))},[g,r]),mt=(t,n)=>ge(l=>{const c=new Set(l);return n?c.add(t):c.delete(t),c}),gt=t=>{const n=new Set;t&&Ke.forEach(l=>n.add(l.id)),ge(n)},ft=()=>{if(p.size===0){u("No items selected.");return}Ie(!0)},xt=async()=>{Ie(!1),De(!0),w&&p.has(w.id)&&fe(null);try{const t=await At(Array.from(p),"link");M(t.msg||`${t.deleted_count} link(s) deleted.`),ge(new Set),V(1,!0)}catch(t){u(t.message||"Bulk delete failed.")}finally{De(!1)}},Ze=s.useMemo(()=>g.filter(t=>p.has(t.id)&&!t.is_external_link&&t.stored_filename).length,[g,p]),ht=async()=>{if(p.size===0){u("No items selected.");return}const t=g.filter(l=>p.has(l.id)&&!l.is_external_link&&l.stored_filename);if(t.length===0){u("No downloadable files among selected links. External links or links without files cannot be bulk downloaded.");return}const n=t.map(l=>l.id);n.length<p.size&&M(`Starting download for ${n.length} file-based links. External links were excluded.`),Ue(!0);try{const l=await Ct(n,"link"),c=URL.createObjectURL(l),i=document.createElement("a");i.href=c;const m=new Date().toISOString().replace(/:/g,"-");i.download=`bulk_download_links_${m}.zip`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(c),n.length===p.size&&M("Download started.")}catch(l){u(l.message||"Bulk download failed.")}finally{Ue(!1)}},pt=()=>{if(p.size===0){u("No items selected.");return}if(G.length===0){u("Software list unavailable.");return}Ne(null),ye(void 0),pe(!0)},bt=async()=>{if(!$){u("Select target software.");return}pe(!1),Pe(!0);const t={target_software_id:$};be!==void 0&&(t.target_version_id=be);try{const n=await Dt(Array.from(p),"link",t);M(n.msg||`${n.moved_count} link(s) moved.`),ge(new Set),V(1,!0)}catch(n){u(n.message||"Bulk move failed.")}finally{Pe(!1),Ne(null),ye(void 0)}},yt=[{key:"title",header:"Title",sortable:!0},{key:"software_name",header:"Software",sortable:!0},{key:"version_name",header:"Version",sortable:!0,render:t=>t.version_name||"N/A"},{key:"description",header:"Description",render:t=>e.jsx("span",{className:"text-sm text-gray-600 block max-w-xs truncate",title:t.description||"",children:t.description||"-"})},{key:"url",header:"Link",render:t=>{var i;const n=t.is_external_link||t.is_downloadable!==!1,l="Link",c=Ye;return!n&&!t.is_external_link?e.jsxs("span",{className:"flex items-center text-gray-400 cursor-not-allowed",title:"Download not permitted",children:[e.jsx(c,{size:14,className:"mr-1 flex-shrink-0"}),l]}):e.jsxs("a",{href:t.url,target:t.is_external_link||!((i=t.url)!=null&&i.startsWith("/"))?"_blank":"_self",rel:"noopener noreferrer",className:`flex items-center ${n?"text-blue-600 hover:text-blue-800":"text-gray-400 cursor-not-allowed"}`,onClick:m=>{n||m.preventDefault(),m.stopPropagation()},title:n?t.is_external_link?"Open external link":"Download file":"Download not permitted",children:[e.jsx(c,{size:14,className:"mr-1 flex-shrink-0"}),l]})}},{key:"uploaded_by_username",header:"Added By",sortable:!0,render:t=>t.uploaded_by_username||"N/A"},{key:"updated_by_username",header:"Updated By",sortable:!1,render:t=>t.updated_by_username||"N/A"},{key:"created_at",header:"Created",sortable:!0,render:t=>t.created_at?new Date(t.created_at).toLocaleString("en-IN",{timeZone:"Asia/Kolkata",day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0}):"-"},{key:"updated_at",header:"Updated",sortable:!0,render:t=>t.updated_at?new Date(t.updated_at).toLocaleString("en-IN",{timeZone:"Asia/Kolkata",day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0}):"-"},{key:"actions",header:"Actions",render:t=>{var n,l,c;return e.jsxs("div",{className:"flex space-x-1 items-center",children:[x&&e.jsx("button",{onClick:i=>{i.stopPropagation(),wt(t,"link")},className:`p-1 rounded-md ${(n=ue.get(t.id))!=null&&n.favoriteId?"text-yellow-500 hover:text-yellow-600":"text-gray-400 hover:text-yellow-500"}`,title:(l=ue.get(t.id))!=null&&l.favoriteId?"Remove Favorite":"Add Favorite",children:e.jsx(Vt,{size:16,className:(c=ue.get(t.id))!=null&&c.favoriteId?"fill-current":""})}),x&&e.jsxs("button",{onClick:i=>{i.stopPropagation(),w&&w.id===t.id?fe(null):(fe(t),setTimeout(()=>{var m;return(m=ke.current)==null?void 0:m.scrollIntoView({behavior:"smooth"})},0))},className:"p-1 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 rounded-md",title:w&&w.id===t.id?"Hide Comments":"View Comments",children:[e.jsx(Kt,{size:16}),e.jsxs("span",{className:"ml-1 text-xs",children:["(",t.comment_count??0,")"]})]}),(o==="admin"||o==="super_admin")&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:i=>{i.stopPropagation(),dt(t)},className:"p-1 text-blue-600 hover:text-blue-800 rounded-md",title:"Edit",children:e.jsx(Zt,{size:16})}),e.jsx("button",{onClick:i=>{i.stopPropagation(),ct(t)},className:"p-1 text-red-600 hover:text-red-800 rounded-md",title:"Delete",children:e.jsx(Xe,{size:16})})]})]})}}],kt=s.useCallback(()=>{V(1,!0)},[V]),wt=async(t,n)=>{var m,xe;if(!x){u("Please log in to manage favorites.");return}const l=ue.get(t.id),c=!!(l!=null&&l.favoriteId),i=new Map(ue);c?i.set(t.id,{favoriteId:void 0}):i.set(t.id,{favoriteId:-1}),me(i);try{if(c&&typeof(l==null?void 0:l.favoriteId)=="number")await Ut(t.id,n),M(`"${t.title}" removed from favorites.`),me(B=>{const ae=new Map(B);return ae.set(t.id,{favoriteId:void 0}),ae});else{const B=await Pt(t.id,n);me(ae=>{const ne=new Map(ae);return ne.set(t.id,{favoriteId:B.id}),ne}),M(`"${t.title}" added to favorites.`)}}catch(B){u(((xe=(m=B==null?void 0:B.response)==null?void 0:m.data)==null?void 0:xe.msg)||B.message||"Failed to update favorite."),me(ae=>{const ne=new Map(ae);return c?ne.set(t.id,{favoriteId:l==null?void 0:l.favoriteId}):ne.set(t.id,{favoriteId:void 0}),ne})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-start sm:items-center mb-6 flex-col sm:flex-row",children:[e.jsxs("div",{children:[" ",e.jsx("h2",{className:"text-2xl font-bold text-gray-800 dark:text-white",children:"Links"})," ",e.jsx("p",{className:"text-gray-600 mt-1 dark:text-gray-300",children:"Manage and browse useful links and resources."})," "]}),x&&(o==="admin"||o==="super_admin")&&!de&&e.jsxs("button",{onClick:()=>{K?We():ot()},className:"mt-4 sm:mt-0 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx(Bt,{size:18,className:"mr-2"})," ",K?"Cancel":"Add New Link"]})]}),K&&e.jsx("div",{className:"my-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow",children:e.jsx(es,{linkToEdit:de,onLinkAdded:()=>qe(),onLinkUpdated:()=>qe(),onCancelEdit:We})}),p.size>0&&e.jsx("div",{className:"my-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:[p.size," item(s) selected"]}),(o==="admin"||o==="super_admin")&&e.jsxs("button",{onClick:ft,disabled:Ae,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-800 focus:ring-red-500 disabled:opacity-50",children:[e.jsx(Xe,{size:14,className:"mr-1.5"}),"Delete"]}),x&&e.jsxs("button",{onClick:ht,disabled:st||Ze===0,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-green-500 hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 focus:ring-green-500 disabled:opacity-50",children:[e.jsx(Ye,{size:14,className:"mr-1.5"}),"Download (",Ze,")"]}),(o==="admin"||o==="super_admin")&&e.jsxs("button",{onClick:pt,disabled:re,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 focus:ring-blue-500 disabled:opacity-50",children:[e.jsx(Tt,{size:14,className:"mr-1.5"}),"Move"]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:gap-4 -mt-20",children:[G.length>0&&e.jsx("div",{className:"w-fit flex-shrink-0",children:e.jsx(Gt,{software:G,selectedSoftwareId:h,onSelectFilter:rt})}),h&&e.jsxs("div",{className:"flex items-center gap-2 min-w-[200px] mt-4 md:mt-0 flex-shrink-0",children:[e.jsx("label",{htmlFor:"versionFilterLinks",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Version"}),e.jsxs("select",{id:"versionFilterLinks",value:A||"",onChange:at,className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200",disabled:R.length===0,children:[e.jsx("option",{value:"",children:"All Versions"}),R.map(t=>e.jsx("option",{value:t.id,children:t.version_number},t.id))]})]})]}),e.jsx("div",{className:"mb-4 mt-0",children:e.jsxs("button",{onClick:()=>tt(t=>!t),className:"flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-md text-sm font-medium",children:[Me?e.jsx(Ht,{size:18,className:"mr-1.5"}):e.jsx(qt,{size:18,className:"mr-1.5"})," Advanced Filters"]})}),Me&&e.jsxs("div",{className:"my-4 p-4 border dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 space-y-4 md:space-y-0 md:flex md:flex-wrap md:items-end md:gap-4",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{htmlFor:"linkTypeFilterSelect",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Link Type"}),e.jsxs("select",{id:"linkTypeFilterSelect",value:N,onChange:t=>T(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200",children:[e.jsx("option",{value:"",children:"All"})," ",e.jsx("option",{value:"external",children:"External URL"})," ",e.jsx("option",{value:"uploaded",children:"Uploaded File"})]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Created Between"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"date",value:U,onChange:t=>b(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"to"}),e.jsx("input",{type:"date",value:_,onChange:t=>O(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"})]})]}),e.jsxs("div",{className:"flex items-end gap-2 pt-5",children:[e.jsx("button",{onClick:lt,className:"text-sm px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"Apply"}),e.jsx("button",{onClick:Te,className:"text-sm px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500",children:"Clear All"})]})]}),se?e.jsx("div",{className:"py-10",children:e.jsx(Ft,{message:"Loading links..."})}):j&&g.length===0&&!se?e.jsx(Jt,{message:j,onRetry:kt}):!se&&!j&&g.length===0?e.jsxs("div",{className:"text-center py-10 bg-white dark:bg-gray-800 rounded-lg shadow-sm my-6",children:[e.jsx(et,{size:48,className:"mx-auto text-yellow-500 dark:text-yellow-400 mb-4"}),e.jsx("p",{className:"text-xl font-semibold text-gray-700 dark:text-gray-200 mb-3",children:_e?"No Links Found Matching Criteria":"No Links Available"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 px-4",children:_e?"Try adjusting or clearing your search/filter settings.":o==="admin"||o==="super_admin"?"Add new links to get started.":"Please check back later."}),_e&&e.jsx("button",{onClick:Te,className:"mt-6 btn-primary text-sm",children:"Clear All Filters & Search"})]}):e.jsx(Xt,{columns:yt,data:Ke,rowClassName:"group",isLoading:se||Ce,currentPage:Q,totalPages:ve,onPageChange:nt,itemsPerPage:I,totalItems:z,sortColumn:F,sortOrder:W,onSort:it,isSelectionEnabled:!0,selectedItemIds:p,onSelectItem:mt,onSelectAllItems:gt}),ce&&S&&e.jsx(Ge,{isOpen:ce,title:"Delete Link",message:`Delete "${S.title}"?`,onConfirm:ut,onCancel:Fe,isConfirming:Ce,confirmButtonText:"Delete",confirmButtonVariant:"danger"}),Re&&e.jsx(Ge,{isOpen:Re,title:`Delete ${p.size} Link(s)`,message:`Delete ${p.size} selected items?`,onConfirm:xt,onCancel:()=>Ie(!1),isConfirming:Ae,confirmButtonText:"Delete Selected",confirmButtonVariant:"danger"}),ze&&e.jsx(Yt,{isOpen:ze,onClose:()=>pe(!1),title:`Move ${p.size} Link(s)`,children:e.jsxs("div",{className:"p-4",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mb-2",children:"Select target Software and optionally a Version:"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"modalSoftwareMoveLinks",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Target Software*"}),e.jsxs("select",{id:"modalSoftwareMoveLinks",value:$??"",onChange:t=>{Ne(t.target.value?parseInt(t.target.value):null),ye(void 0)},className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white",disabled:re||G.length===0,children:[e.jsx("option",{value:"",children:"Select Software..."}),G.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),$&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"modalVersionMoveLinks",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Target Version (Optional)"}),e.jsxs("select",{id:"modalVersionMoveLinks",value:be===null?"NULL_VERSION":be??"",onChange:t=>ye(t.target.value==="NULL_VERSION"?null:t.target.value?parseInt(t.target.value):void 0),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white",disabled:re||Le,children:[e.jsx("option",{value:"",children:Le?"Loading...":"Select Version (Optional)..."}),e.jsx("option",{value:"NULL_VERSION",children:"No Specific Version (Clear Association)"}),$e.map(t=>e.jsx("option",{value:t.id,children:t.version_number},t.id))]}),$e.length===0&&!Le&&$&&e.jsx("p",{className:"text-xs text-yellow-600 mt-1",children:"No versions for selected software. You can still move to the software without a specific version."})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[e.jsx("button",{type:"button",onClick:()=>pe(!1),className:"px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500",disabled:re,children:"Cancel"}),e.jsx("button",{type:"button",onClick:bt,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",disabled:re||!$,children:re?"Moving...":"Confirm Move"})]})]})}),x&&w&&e.jsxs("div",{ref:ke,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("h3",{className:"text-xl font-semibold text-gray-800 dark:text-white mb-4",children:["Comments for: ",e.jsx("span",{className:"font-bold text-blue-600 dark:text-blue-400",children:w.title})]}),e.jsx(Wt,{itemId:w.id,itemType:"link"})]}),!x&&w&&e.jsx("div",{ref:ke,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 text-center",children:e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Please log in to view and manage comments."})})]})};export{is as default};
