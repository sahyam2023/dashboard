<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Software Dashboard</title>
    <style>
        body { font-family: sans-serif; display: flex; margin: 0; }
        #sidebar { width: 200px; background-color: #f4f4f4; padding: 15px; height: 100vh; border-right: 1px solid #ccc; overflow-y: auto; }
        #main-content { flex-grow: 1; padding: 20px; overflow-y: auto; height: 100vh;} /* Added overflow */
        #sidebar h2 { margin-top: 0; }
        #sidebar ul { list-style: none; padding: 0; }
        #sidebar li a { text-decoration: none; color: #333; display: block; padding: 8px; border-radius: 4px; }
        #sidebar li a:hover { background-color: #ddd; }
        #sidebar li a.active { background-color: #007bff; color: white; }

        /* General Sections & Links */
        .section { margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 5px; }
        .section h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .section ul { list-style: disc; margin-left: 20px; padding-left: 0; } /* Adjusted padding */
        .section li { margin-bottom: 8px; } /* Spacing for list items */
        .section table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .section th, .section td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .section th { background-color: #f8f8f8; }
        .section pre { background-color: #f8f8f8; padding: 10px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto; } /* Scrollable pre */
        label { margin-right: 10px; font-weight: bold;}
        select { padding: 5px; margin-bottom: 15px; min-width: 200px;}
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        hr { border: 0; border-top: 1px solid #ccc; margin: 20px 0; }

        /* Tab Specific Styles */
        ul.tabs {
            list-style: none;
            padding: 0;
            margin: 20px 0 0 0;
            border-bottom: 1px solid #ccc;
            display: flex; /* Use flexbox for layout */
        }
        ul.tabs li {
            margin: 0 5px -1px 0; /* Adjust margin for alignment */
        }
        ul.tabs li a {
            display: block;
            padding: 10px 15px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            color: #333;
            text-decoration: none;
        }
        ul.tabs li a:hover {
            background-color: #e0e0e0;
            text-decoration: none;
        }
        ul.tabs li a.active {
            background-color: #fff;
            border-color: #ccc;
            border-bottom: 1px solid #fff; /* Overlap the bottom border */
            color: #000;
            font-weight: bold;
        }
        .tab-content {
            display: none; /* Hide content by default */
            padding: 15px;
            border: 1px solid #ccc;
            border-top: none; /* Remove top border as tabs handle it */
            border-radius: 0 0 4px 4px;
            margin-bottom: 20px;
        }
        .tab-content.active {
            display: block; /* Show active content */
        }
        .tab-content h4 { margin-top: 0; } /* Heading inside tab */

    </style>
</head>
<body>
    <div id="sidebar">
        <h2>Software</h2>
        <ul>
            {% for sw in all_software %}
            <li>
                <a href="{{ url_for('index', software_id=sw.id) }}"
                   class="{{ 'active' if sw.id == selected_software_id else '' }}">
                   {{ sw.name }}
                </a>
            </li>
            {% else %}
            <li>No software found.</li>
            {% endfor %}
        </ul>
    </div>

    <div id="main-content">
        {% if current_software %}
            <h1>{{ current_software.name }}</h1>
            <p>{{ current_software.description or 'No description available.' }}</p>

            {# --- NEW: Software-Wide Documents Section --- #}
            <div class="section">
                <h3>Software Documents</h3>
                {% if software_documents %}
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Link</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for doc in software_documents %}
                            <tr>
                                <td>{{ doc.doc_name }}</td>
                                <td>{{ doc.doc_type or 'N/A' }}</td>
                                <td>{{ doc.description or ' ' }}</td>
                                <td><a href="{{ doc.download_link }}" target="_blank">Download</a></td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>No general documents found for this software.</p>
                {% endif %}
            </div>

            <hr>

            {# --- Version Selection --- #}
            <form method="GET" action="{{ url_for('index') }}" id="versionForm">
                <input type="hidden" name="software_id" value="{{ selected_software_id }}">
                <label for="version_select">Select Version:</label>
                <select name="version_id" id="version_select" onchange="document.getElementById('versionForm').submit()">
                    <option value="">-- Select Version --</option>
                    {% for v in versions_list %}
                        <option value="{{ v.id }}" {{ 'selected' if v.id == selected_version_id else '' }}>
                            {{ v.version_number }} {% if v.release_date %}({{ v.release_date }}){% endif %}
                        </option>
                    {% else %}
                        <option value="" disabled>No versions available</option>
                    {% endfor %}
                </select>
            </form>

            {# --- Version Specific Details (Using Tabs) --- #}
            {% if version_details %}
                <h2>Version: {{ version_details.version.version_number }}</h2>
                {% if version_details.version.release_date %}
                    <p><strong>Release Date:</strong> {{ version_details.version.release_date }}</p>
                {% endif %}

                {# Tab Links #}
                <ul class="tabs">
                    <li><a href="#tab-download" class="tab-link active">Download</a></li>
                    <li><a href="#tab-patches" class="tab-link">Patches</a></li>
                    <li><a href="#tab-changelog" class="tab-link">Changelog</a></li>
                    <li><a href="#tab-bugs" class="tab-link">Known Bugs</a></li>
                </ul>

                {# Tab Content Panes #}
                <div id="tab-download" class="tab-content active">
                    <h4>Main Download</h4>
                    {% if version_details.version.main_download_link %}
                        <p><a href="{{ version_details.version.main_download_link }}" target="_blank" class="button">Download {{ current_software.name }} {{ version_details.version.version_number }}</a></p>
                    {% else %}
                        <p>No main download link provided for this version.</p>
                    {% endif %}
                    {# You could add other overview info here if needed #}
                </div>

                <div id="tab-patches" class="tab-content">
                    <h4>Patches</h4>
                    {% if version_details.patches %}
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Release Date</th>
                                    <th>Description</th>
                                    <th>Link</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for patch in version_details.patches %}
                                <tr>
                                    <td>{{ patch.patch_name }}</td>
                                    <td>{{ patch.release_date or 'N/A' }}</td>
                                    <td>{{ patch.description or ' ' }}</td>
                                    <td><a href="{{ patch.download_link }}" target="_blank">Download</a></td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p>No patches listed for this version.</p>
                    {% endif %}
                </div>

                <div id="tab-changelog" class="tab-content">
                    <h4>Changelog</h4>
                    {% if version_details.version.changelog %}
                        <pre>{{ version_details.version.changelog }}</pre>
                    {% else %}
                        <p>No changelog provided for this version.</p>
                    {% endif %}
                </div>

                <div id="tab-bugs" class="tab-content">
                    <h4>Known Bugs</h4>
                     {% if version_details.version.known_bugs %}
                        <pre>{{ version_details.version.known_bugs }}</pre>
                    {% else %}
                        <p>No known bugs listed for this version.</p>
                    {% endif %}
                </div>

            {# Message if software selected, but no version #}
            {% elif selected_software_id and not selected_version_id and versions_list %}
                <p style="margin-top: 20px;">Please select a version from the dropdown above to view its details.</p>
             {% elif selected_software_id and not versions_list %}
                 <p style="margin-top: 20px;">No versions found for this software.</p>
            {% endif %}

        {# Message if no software selected at all #}
        {% else %}
            <h2>Welcome to the Software Dashboard</h2>
            <p>Please select a software product from the sidebar to view its details.</p>
        {% endif %}
    </div>

    {# --- JavaScript for Tabs --- #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tabLinks = document.querySelectorAll('.tabs .tab-link');
            const tabContents = document.querySelectorAll('.tab-content');

            tabLinks.forEach(link => {
                link.addEventListener('click', function(event) {
                    event.preventDefault(); // Prevent browser jump to hash

                    const targetId = this.getAttribute('href'); // e.g., "#tab-patches"
                    const targetContent = document.querySelector(targetId);

                    // Remove active class from all links and content panes
                    tabLinks.forEach(l => l.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));

                    // Add active class to the clicked link and target content pane
                    this.classList.add('active');
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                });
            });

            // Ensure the first tab is active initially if tabs are present
            const firstTabLink = document.querySelector('.tabs .tab-link');
            const firstTabContent = document.querySelector('.tab-content');
             if (firstTabLink && firstTabContent){ //Check they exist before adding class
                 firstTabLink.classList.add('active');
                 firstTabContent.classList.add('active');
             }
             // Correction: The above logic activates the *first* .tab-content always.
             // We need to activate the one linked by the first tab link specifically.
             // Let's refine the initial activation logic.

            // Clear previous logic for initial activation
            // New logic: Find the first link, get its href, activate that specific content.
            const initialActiveLink = document.querySelector('.tabs .tab-link.active'); // Get pre-set active link
            if (initialActiveLink) {
                 const initialTargetId = initialActiveLink.getAttribute('href');
                 const initialTargetContent = document.querySelector(initialTargetId);
                 if (initialTargetContent) {
                     // Deactivate all first, then activate the correct initial one
                     tabContents.forEach(c => c.classList.remove('active'));
                     initialTargetContent.classList.add('active');
                 }
            }


        });
    </script>

</body>
</html>