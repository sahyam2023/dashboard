import{r as a,u as qe,f as We,Q as ue,q as He,j as e,L as xt,F as Re,X as gt,t as ht,v as ft,w as pt,x as bt,g as yt,y as vt,s as p,i as kt,P as wt,d as H,k as jt,S as St,z as Nt,m as _t,n as It,o as Ft,p as Ct}from"./index-CxRLU1Q9.js";import{u as Pt,U as Vt,o as Dt,c as Mt,a as A,b as At,P as Lt,T as Oe,D as Fe,M as Ut,F as $t,C as zt,e as Bt,d as Rt}from"./CommentSection-GZpLJ71L.js";import{C as Ot,D as Et,M as qt}from"./Modal-Ce5HiDqL.js";import{F as Wt}from"./FilterTabs-DIAJePOQ.js";import{E as Ht}from"./ErrorState-BQ_jwQrW.js";import{C as Ee}from"./ConfirmationModal-BLbBgNYt.js";const X="CREATE_NEW_VERSION_SENTINEL_VALUE",Xt=Mt().shape({selectedSoftwareId:A().required("Software Product must be selected."),selectedVersionId:A().required("Version selection is required."),typedVersionString:A().when("selectedVersionId",{is:X,then:s=>s.required("New Version String is required when 'Enter New Version' is selected.").min(1),otherwise:s=>s.transform(f=>f===""?void 0:f).optional().nullable()}),patchName:A().required("Patch Name is required.").max(255,"Patch Name cannot exceed 255 characters."),releaseDate:A().transform(s=>s===""?void 0:s).optional().nullable(),inputMode:A().oneOf(["url","upload"]).required("Input mode must be selected."),externalUrl:A().when("inputMode",{is:"url",then:s=>s.required("External Download URL is required.").url("Please enter a valid URL."),otherwise:s=>s.optional().nullable()}),selectedFile:At().when(["inputMode","$isEditMode","$patchToEditIsExternal"],{is:(s,f,m)=>s!=="upload"?!1:!!(!f||f&&m),then:s=>s.required("Please select a file to upload.").test("filePresent","File is required for upload.",f=>!!f),otherwise:s=>s.nullable()}),description:A().transform(s=>s===""?void 0:s).optional().max(2e3,"Description cannot exceed 2000 characters.").nullable(),patch_by_developer:A().transform(s=>s===""?void 0:s).optional().max(255,"Patch developer name cannot exceed 255 characters.").nullable()}),Zt=({patchToEdit:s,onPatchAdded:f,onPatchUpdated:m,onCancelEdit:L})=>{const l=!!s,{register:x,handleSubmit:re,control:Z,formState:{errors:n},watch:b,setValue:h,reset:j}=Pt({resolver:Dt(Xt),context:{isEditMode:l,patchToEditIsExternal:(s==null?void 0:s.is_external_link)||!1},defaultValues:{selectedSoftwareId:"",selectedVersionId:"",typedVersionString:"",patchName:"",releaseDate:"",description:"",inputMode:"url",externalUrl:"",selectedFile:null,patch_by_developer:""}}),[O,D]=a.useState([]),[M,S]=a.useState([]),[U,$]=a.useState(null),[g,G]=a.useState(!1),[E,J]=a.useState(!1),F=a.useRef(null),{isAuthenticated:ae,user:K}=qe(),y=K==null?void 0:K.role,N=b("selectedSoftwareId"),q=b("selectedVersionId"),xe=b("inputMode"),v=b("selectedFile"),W=q===X;a.useEffect(()=>{ae&&(y==="admin"||y==="super_admin")&&(J(!0),We().then(D).catch(()=>ue.error("Failed to load software list.")).finally(()=>J(!1)))},[ae,y]),a.useEffect(()=>{N?(J(!0),S([]),h("selectedVersionId",""),h("typedVersionString",""),He(parseInt(N)).then(S).catch(()=>ue.error("Failed to load versions.")).finally(()=>J(!1))):(S([]),h("selectedVersionId",""),h("typedVersionString",""))},[N,h]),a.useEffect(()=>{if(l&&s){const r={selectedSoftwareId:s.software_id.toString(),patchName:s.patch_name,releaseDate:s.release_date?s.release_date.split("T")[0]:"",description:s.description||"",inputMode:s.is_external_link?"url":"upload",externalUrl:s.is_external_link?s.download_link:"",patch_by_developer:s.patch_by_developer||""};s.version_id&&s.software_id.toString()===N&&M.length>0?M.find(C=>C.id===s.version_id)?(r.selectedVersionId=s.version_id.toString(),r.typedVersionString=s.version_number):(r.selectedVersionId=X,r.typedVersionString=s.version_number):s.version_number&&(r.selectedVersionId=X,r.typedVersionString=s.version_number),j(r),s.is_external_link?$(null):$(s.original_filename_ref||s.download_link.split("/").pop()||"unknown_file"),h("selectedFile",null),F.current&&(F.current.value="")}else l||Y(!!N)},[l,s,M,N,j,h]);const Y=(r=!1)=>{const _=r?b("selectedSoftwareId"):"";j({selectedSoftwareId:_,selectedVersionId:"",typedVersionString:"",patchName:"",releaseDate:"",description:"",inputMode:"url",externalUrl:"",selectedFile:null,patch_by_developer:""}),$(null),F.current&&(F.current.value="")},ge=r=>{r.target.files&&r.target.files[0]?(h("selectedFile",r.target.files[0],{shouldValidate:!0,shouldDirty:!0}),$(null)):h("selectedFile",null,{shouldValidate:!0,shouldDirty:!0})},le=()=>{h("selectedFile",null,{shouldValidate:!0,shouldDirty:!0}),F.current&&(F.current.value=""),l&&s&&!s.is_external_link&&$(s.original_filename_ref||s.download_link.split("/").pop()||"unknown_file")},Q=async r=>{var ne,de,oe,z,B,ie;G(!0);let _,C;r.selectedVersionId===X&&r.typedVersionString?C=r.typedVersionString.trim():r.selectedVersionId&&r.selectedVersionId!==X&&(_=parseInt(r.selectedVersionId));const P={software_id:parseInt(r.selectedSoftwareId),patch_name:r.patchName.trim(),description:((ne=r.description)==null?void 0:ne.trim())||void 0,release_date:r.releaseDate||void 0,patch_by_developer:((de=r.patch_by_developer)==null?void 0:de.trim())||void 0};_&&(P.version_id=_),C&&(P.typed_version_string=C);try{let k;if(r.inputMode==="url"){const d={...P,download_link:r.externalUrl.trim(),is_external_link:!0};l&&s?k=await ht(s.id,d):k=await ft(d)}else{const d=new FormData;d.append("software_id",r.selectedSoftwareId),_&&d.append("version_id",_.toString()),C&&d.append("typed_version_string",C),d.append("patch_name",r.patchName.trim()),r.releaseDate&&d.append("release_date",r.releaseDate),(oe=r.description)!=null&&oe.trim()&&d.append("description",r.description.trim()),(z=r.patch_by_developer)!=null&&z.trim()&&d.append("patch_by_developer",r.patch_by_developer.trim()),r.selectedFile&&d.append("file",r.selectedFile),l&&s?k=await pt(s.id,d):k=await bt(d)}ue.success(`Patch "${k.patch_name}" ${l?"updated":"added"} successfully!`),l||(Y(!0),h("selectedVersionId",""),h("typedVersionString","")),l&&m&&m(k),!l&&f&&f(k)}catch(k){const d=((ie=(B=k.response)==null?void 0:B.data)==null?void 0:ie.msg)||k.message||`Failed to ${l?"update":"add"} patch.`;ue.error(d)}finally{G(!1)}},he=r=>{console.error("Form validation errors:",r),ue.error("Please correct the errors highlighted in the form.")};return!ae||!y||!["admin","super_admin"].includes(y)?null:e.jsxs("form",{onSubmit:re(Q,he),className:"space-y-6 bg-white dark:bg-gray-800 dark:border-gray-700 p-6 rounded-lg shadow-md border border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-800 dark:text-gray-100",children:l?"Edit Patch":"Add New Patch"}),l&&L&&e.jsx("button",{type:"button",onClick:L,className:"text-sm text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200",children:"Cancel"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedSoftwareId",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Software Product*"}),E&&!O.length?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading software..."}):e.jsxs("select",{id:"selectedSoftwareId",...x("selectedSoftwareId"),disabled:g||E&&!O.length,className:`mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${n.selectedSoftwareId?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",disabled:!0,children:"Select Software Product"}),O.map(r=>e.jsx("option",{value:r.id.toString(),children:r.name},r.id))]}),n.selectedSoftwareId&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:n.selectedSoftwareId.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedVersionId",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Version*"}),e.jsx("div",{className:"mt-1",children:e.jsxs("select",{id:"selectedVersionId",...x("selectedVersionId"),disabled:g||E||!N,className:`block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${n.selectedVersionId?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",disabled:M.length>0&&!!N,children:E&&N?"Loading versions...":"Select Existing Version"}),M.map(r=>e.jsx("option",{value:r.id.toString(),children:r.version_number},r.id)),e.jsx("option",{value:X,children:"Enter New Version String..."})]})}),W&&e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{htmlFor:"typedVersionString",className:"block text-xs font-medium text-gray-600 dark:text-gray-400",children:"New Version String*:"}),e.jsx("input",{type:"text",id:"typedVersionString",...x("typedVersionString"),placeholder:"e.g., 2.5.1-hotfix",className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${n.typedVersionString?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"This version will be created for the selected software if it doesn't exist."})]}),n.selectedVersionId&&!W&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.selectedVersionId.message}),n.typedVersionString&&W&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.typedVersionString.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"patchName",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Patch Name*"}),e.jsx("input",{type:"text",id:"patchName",...x("patchName"),disabled:g,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${n.patchName?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),n.patchName&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.patchName.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"releaseDate",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Release Date"}),e.jsx("input",{type:"date",id:"releaseDate",...x("releaseDate"),disabled:g,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${n.releaseDate?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`}),n.releaseDate&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.releaseDate.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"patch_by_developer",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Patch By Developer"}),e.jsx("input",{type:"text",id:"patch_by_developer",...x("patch_by_developer"),disabled:g,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${n.patch_by_developer?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),n.patch_by_developer&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.patch_by_developer.message})]}),e.jsxs("div",{className:"my-4",children:[e.jsx("span",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Patch Source:"}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",...x("inputMode"),value:"url",className:"form-radio h-4 w-4 text-blue-600",disabled:g}),e.jsxs("span",{className:"flex items-center dark:text-gray-300",children:[e.jsx(xt,{size:16,className:"mr-1 text-gray-600 dark:text-gray-400"}),"Provide External Link"]})]}),e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",...x("inputMode"),value:"upload",className:"form-radio h-4 w-4 text-blue-600",disabled:g}),e.jsxs("span",{className:"flex items-center dark:text-gray-300",children:[e.jsx(Vt,{size:16,className:"mr-1 text-gray-600 dark:text-gray-400"}),"Upload File"]})]})]}),n.inputMode&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.inputMode.message})]}),xe==="url"&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"externalUrl",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"External Download URL*"}),e.jsx("input",{type:"url",id:"externalUrl",...x("externalUrl"),placeholder:"https://example.com/patch.exe",disabled:g,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${n.externalUrl?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),n.externalUrl&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.externalUrl.message})]}),xe==="upload"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:l&&U&&!v?"Replace File (Optional)":"Select File to Upload*"}),e.jsx("div",{className:"mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-blue-500 dark:border-gray-600 dark:hover:border-blue-400 transition-colors",children:e.jsxs("div",{className:"space-y-1 text-center",children:[e.jsx(Re,{className:"mx-auto h-12 w-12 text-gray-400 dark:text-gray-500"}),e.jsxs("div",{className:"flex text-sm text-gray-600 dark:text-gray-400",children:[e.jsxs("label",{htmlFor:"patch-file-upload-input",className:"relative cursor-pointer bg-white dark:bg-gray-800 rounded-md font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500",children:[e.jsx("span",{children:v?"Change file":"Upload a file"}),e.jsx("input",{id:"patch-file-upload-input",name:"patch-file-input",type:"file",className:"sr-only",onChange:ge,ref:F,disabled:g})]}),e.jsx("p",{className:"pl-1",children:"or drag and drop"})]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"EXE, MSI, ZIP, etc."})]})}),(v||l&&U)&&e.jsxs("div",{className:"mt-3 flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md",children:[e.jsxs("div",{className:"flex items-center space-x-2 overflow-hidden",children:[e.jsx(Re,{size:18,className:"text-gray-500 dark:text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:v?v.name:U}),l&&U&&!v&&e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 ml-2",children:"(current)"})]}),v&&e.jsx("button",{type:"button",onClick:le,disabled:g,className:"p-1 rounded-full text-gray-400 hover:text-gray-600 hover:bg-gray-200 dark:text-gray-500 dark:hover:text-gray-300 dark:hover:bg-gray-600",children:e.jsx(gt,{size:16})})]}),n.selectedFile&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.selectedFile.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Description"}),e.jsx("textarea",{id:"description",rows:3,...x("description"),disabled:g,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${n.description?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),n.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.description.message})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{type:"submit",disabled:g||E,className:"flex-1 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",children:g?l?"Updating...":"Adding...":l?"Update Patch":"Add Patch"}),l&&L&&e.jsx("button",{type:"button",onClick:L,disabled:g,className:"flex-1 inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 dark:border-gray-500 dark:text-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600",children:"Cancel"})]})]})},es=()=>{const{searchTerm:s,setSearchTerm:f}=yt(),{isAuthenticated:m,user:L}=qe(),l=L==null?void 0:L.role,[x,re]=a.useState([]),[Z,n]=a.useState([]),[b,h]=a.useState(null),[j,O]=a.useState(""),[D,M]=a.useState(""),[S,U]=a.useState(""),[$,g]=a.useState(1),[G,E]=a.useState(15),[J,F]=a.useState(0),[ae,K]=a.useState(0),[y,N]=a.useState("patch_name"),[q,xe]=a.useState("asc"),[v,W]=a.useState(!0),[Y,ge]=a.useState(null),[le,Q]=a.useState(!1),[he,r]=a.useState(null),[_,C]=a.useState(!1),[P,ne]=a.useState(null),[de,oe]=a.useState(!1),[z,B]=a.useState(new Map),[ie,k]=a.useState(!1),[d,ce]=a.useState(new Set),[Ce,Pe]=a.useState(!1),[Xe,Ve]=a.useState(!1),[T,De]=a.useState(!1),[Me,fe]=a.useState(!1),[ee,ve]=a.useState(null),[ke,Ae]=a.useState([]),[pe,be]=a.useState(null),[Le,we]=a.useState(!1),[je,Ue]=a.useState(!1),[w,ye]=a.useState(null),Se=a.useRef(null),Ne=a.useMemo(()=>b!==null||j!==""||D!==""||S!==""||s!=="",[b,j,D,S,s]),Ze=a.useCallback(()=>{h(null),O(""),M(""),U(""),f&&f("")},[f]),Ge=()=>{V(1,!0)},Je=()=>{O(""),M(""),U("")},V=a.useCallback(async(t,o=!1)=>{var i,u;o&&W(!0),ge(null);try{const c=await vt(b??void 0,t,G,y,q,j||void 0,D||void 0,S||void 0);re(c.patches),F(c.total_pages),K(c.total_patches),g(c.page),E(c.per_page);const I=new Map;if(m&&c.patches)for(const me of c.patches)I.set(me.id,{favoriteId:me.favorite_id});B(I)}catch(c){const I=((u=(i=c.response)==null?void 0:i.data)==null?void 0:u.msg)||c.message||"Failed to fetch patches.";o?(ge(I),re([]),F(0),K(0)):p(I)}finally{o&&W(!1)}},[b,G,y,q,j,D,S,m]);a.useEffect(()=>{m?V(1,!0):(re([]),W(!1))},[m,b,y,q,j,D,S,V]),a.useEffect(()=>{ce(new Set)},[b,y,q,j,D,S,s,$]),a.useEffect(()=>{m&&We().then(n).catch(t=>p("Failed to load software list."))},[m]),a.useEffect(()=>{ee?(Ue(!0),He(ee).then(Ae).catch(()=>p("Failed to load versions for move target.")).finally(()=>Ue(!1))):Ae([])},[ee]);const Ke=t=>h(t),Ye=t=>{N(t),xe(o=>y===t&&o==="asc"?"desc":"asc")},Qe=t=>V(t,!0),$e=t=>{Q(!1),r(null),H(t),V(1,!0)},Te=()=>{r(null),Q(!0)},et=t=>{r(t),Q(!0)},ze=()=>{r(null),Q(!1)},tt=t=>{ne(t),C(!0)},_e=()=>{ne(null),C(!1)},st=async()=>{if(P){oe(!0),w&&w.id===P.id&&ye(null);try{await Nt(P.id),H(`Patch "${P.patch_name}" deleted.`),_e(),V(1,!0)}catch(t){p(t.message||"Delete failed."),_e()}finally{oe(!1)}}},Be=a.useMemo(()=>{if(!s)return x;const t=s.toLowerCase();return x.filter(o=>o.patch_name.toLowerCase().includes(t)||(o.description||"").toLowerCase().includes(t)||(o.software_name||"").toLowerCase().includes(t)||(o.version_number||"").toLowerCase().includes(t))},[x,s]),rt=(t,o)=>ce(i=>{const u=new Set(i);return o?u.add(t):u.delete(t),u}),at=t=>{const o=new Set;t&&Be.forEach(i=>o.add(i.id)),ce(o)},lt=()=>{if(d.size===0){p("No items selected.");return}we(!0)},nt=async()=>{we(!1),Pe(!0),w&&d.has(w.id)&&ye(null);try{const t=await _t(Array.from(d),"patch");H(t.msg||`${t.deleted_count} patch(es) deleted.`),ce(new Set),V(1,!0)}catch(t){p(t.message||"Bulk delete failed.")}finally{Pe(!1)}},dt=async()=>{if(d.size===0){p("No items selected.");return}Ve(!0);try{const t=await jt(Array.from(d),"patch"),o=URL.createObjectURL(t),i=document.createElement("a");i.href=o;const u=new Date().toISOString().replace(/:/g,"-");i.download=`bulk_download_patches_${u}.zip`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o),H("Download started.")}catch(t){p(t.message||"Bulk download failed.")}finally{Ve(!1)}},ot=()=>{if(d.size===0){p("No items selected.");return}if(Z.length===0){p("Software list unavailable.");return}ve(null),be(null),fe(!0)},it=async()=>{if(!pe){p("Select target version.");return}fe(!1),De(!0);try{const t=await It(Array.from(d),"patch",{target_version_id:pe});H(t.msg||`${t.moved_count} patch(es) moved.`),ce(new Set),V(1,!0)}catch(t){p(t.message||"Bulk move failed.")}finally{De(!1),ve(null),be(null)}},Ie=t=>t?new Date(t).toLocaleDateString("en-CA"):"-",ct=[{key:"patch_name",header:"Patch Name",sortable:!0},{key:"software_name",header:"Software",sortable:!0},{key:"version_number",header:"Version",sortable:!0},{key:"patch_by_developer",header:"Developer",sortable:!0,render:t=>t.patch_by_developer||"-"},{key:"description",header:"Description",render:t=>e.jsx("span",{className:"text-sm text-gray-600 block max-w-xs truncate",title:t.description||"",children:t.description||"-"})},{key:"release_date",header:"Release Date",sortable:!0,render:t=>Ie(t.release_date)},{key:"download_link",header:"Link",render:t=>{var i;const o=t.is_external_link||t.is_downloadable!==!1;return!o&&!t.is_external_link?e.jsxs("span",{className:"flex items-center text-gray-400 cursor-not-allowed",title:"Download not permitted",children:[e.jsx(Fe,{size:14,className:"mr-1"}),"Link"]}):e.jsxs("a",{href:t.download_link,target:t.is_external_link||!((i=t.download_link)!=null&&i.startsWith("/"))?"_blank":"_self",rel:"noopener noreferrer",className:`flex items-center ${o?"text-blue-600 hover:text-blue-800":"text-gray-400 cursor-not-allowed"}`,onClick:u=>{o||u.preventDefault(),u.stopPropagation()},title:o?t.is_external_link?"Open external link":"Download patch":"Download not permitted",children:[e.jsx(Fe,{size:14,className:"mr-1"}),"Link"]})}},{key:"uploaded_by_username",header:"Uploaded By",sortable:!0,render:t=>t.uploaded_by_username||"N/A"},{key:"updated_by_username",header:"Updated By",sortable:!1,render:t=>t.updated_by_username||"N/A"},{key:"created_at",header:"Created At",sortable:!0,render:t=>Ie(t.created_at)},{key:"updated_at",header:"Updated At",sortable:!0,render:t=>Ie(t.updated_at)},{key:"actions",header:"Actions",render:t=>{var o,i,u;return e.jsxs("div",{className:"flex space-x-1 items-center",children:[m&&e.jsx("button",{onClick:c=>{c.stopPropagation(),ut(t,"patch")},className:`p-1 rounded-md ${(o=z.get(t.id))!=null&&o.favoriteId?"text-yellow-500 hover:text-yellow-600":"text-gray-400 hover:text-yellow-500"}`,title:(i=z.get(t.id))!=null&&i.favoriteId?"Remove Favorite":"Add Favorite",children:e.jsx(St,{size:16,className:(u=z.get(t.id))!=null&&u.favoriteId?"fill-current":""})}),m&&e.jsxs("button",{onClick:c=>{c.stopPropagation(),w&&w.id===t.id?ye(null):(ye(t),setTimeout(()=>{var I;return(I=Se.current)==null?void 0:I.scrollIntoView({behavior:"smooth"})},0))},className:"p-1 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 rounded-md",title:w&&w.id===t.id?"Hide Comments":"View Comments",children:[e.jsx(Bt,{size:16}),e.jsxs("span",{className:"ml-1 text-xs",children:["(",t.comment_count??0,")"]})]}),(l==="admin"||l==="super_admin")&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:c=>{c.stopPropagation(),et(t)},className:"p-1 text-blue-600 hover:text-blue-800 rounded-md",title:"Edit",children:e.jsx(Rt,{size:16})}),e.jsx("button",{onClick:c=>{c.stopPropagation(),tt(t)},className:"p-1 text-red-600 hover:text-red-800 rounded-md",title:"Delete",children:e.jsx(Oe,{size:16})})]})]})}}],mt=a.useCallback(()=>{V(1,!0)},[V]),ut=async(t,o)=>{var I,me;if(!m){p("Please log in to manage favorites.");return}const i=z.get(t.id),u=!!(i!=null&&i.favoriteId),c=new Map(z);u?c.set(t.id,{favoriteId:void 0}):c.set(t.id,{favoriteId:-1}),B(c);try{if(u&&typeof(i==null?void 0:i.favoriteId)=="number")await Ft(t.id,o),H(`"${t.patch_name}" removed from favorites.`),B(R=>{const te=new Map(R);return te.set(t.id,{favoriteId:void 0}),te});else{const R=await Ct(t.id,o);B(te=>{const se=new Map(te);return se.set(t.id,{favoriteId:R.id}),se}),H(`"${t.patch_name}" added to favorites.`)}}catch(R){p(((me=(I=R==null?void 0:R.response)==null?void 0:I.data)==null?void 0:me.msg)||R.message||"Failed to update favorite."),B(te=>{const se=new Map(te);return u?se.set(t.id,{favoriteId:i==null?void 0:i.favoriteId}):se.set(t.id,{favoriteId:void 0}),se})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-start sm:items-center mb-6 flex-col sm:flex-row",children:[e.jsxs("div",{children:[" ",e.jsx("h2",{className:"text-2xl font-bold text-gray-800 dark:text-white",children:"Patches"})," ",e.jsx("p",{className:"text-gray-600 mt-1 dark:text-gray-300",children:"Browse and manage software patches."})," "]}),m&&(l==="admin"||l==="super_admin")&&!he&&e.jsxs("button",{onClick:le?ze:Te,className:"mt-4 sm:mt-0 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx(Lt,{size:18,className:"mr-2"})," ",le?"Cancel":"Add New Patch"]})]}),le&&e.jsxs("div",{className:"my-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow",children:[" ",e.jsx(Zt,{patchToEdit:he,onPatchAdded:()=>$e("Patch added."),onPatchUpdated:()=>$e("Patch updated."),onCancelEdit:ze})," "]}),d.size>0&&e.jsx("div",{className:"my-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:[d.size," item(s) selected"]}),(l==="admin"||l==="super_admin")&&e.jsxs("button",{onClick:lt,disabled:Ce,className:"btn-danger-xs flex items-center",children:[e.jsx(Oe,{size:14,className:"mr-1.5"}),"Delete"]}),m&&e.jsxs("button",{onClick:dt,disabled:Xe,className:"btn-success-xs flex items-center",children:[e.jsx(Fe,{size:14,className:"mr-1.5"}),"Download"]}),(l==="admin"||l==="super_admin")&&e.jsxs("button",{onClick:ot,disabled:T,className:"btn-warning-xs flex items-center",children:[e.jsx(Ut,{size:14,className:"mr-1.5"}),"Move"]})]})}),Z.length>0&&e.jsx(Wt,{software:Z,selectedSoftwareId:b,onSelectFilter:Ke}),e.jsx("div",{className:"my-4",children:e.jsxs("button",{onClick:()=>k(t=>!t),className:"flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-md text-sm font-medium",children:[ie?e.jsxs(e.Fragment,{children:[e.jsx(Ot,{size:18,className:"mr-2"}),"Hide"]}):e.jsxs(e.Fragment,{children:[e.jsx($t,{size:18,className:"mr-2"}),"Show"]})," Advanced Filters"]})}),ie&&e.jsxs("div",{className:"my-4 p-4 border dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 space-y-4 md:space-y-0 md:flex md:flex-wrap md:items-end md:gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"patchedByDevFilter",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Developer"}),e.jsx("input",{id:"patchedByDevFilter",type:"text",value:S,onChange:t=>U(t.target.value),placeholder:"e.g., Main Dev",className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Released"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"date",value:j,onChange:t=>O(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"to"}),e.jsx("input",{type:"date",value:D,onChange:t=>M(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"})]})]}),e.jsxs("div",{className:"flex items-end gap-2 pt-5",children:[e.jsx("button",{onClick:Ge,className:"text-sm px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"Apply"}),e.jsx("button",{onClick:Je,className:"text-sm px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500",children:"Clear"})]})]}),v?e.jsx("div",{className:"py-10",children:e.jsx(kt,{message:"Loading patches..."})}):Y&&x.length===0&&!v?e.jsx(Ht,{message:Y,onRetry:mt}):!v&&!Y&&x.length===0?e.jsxs("div",{className:"text-center py-10 bg-white dark:bg-gray-800 rounded-lg shadow-sm my-6",children:[e.jsx(wt,{size:48,className:"mx-auto text-yellow-500 dark:text-yellow-400 mb-4"}),e.jsx("p",{className:"text-xl font-semibold text-gray-700 dark:text-gray-200 mb-3",children:Ne?"No Patches Found Matching Criteria":"No Patches Available"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 px-4",children:Ne?"Try adjusting or clearing your search/filter settings.":l==="admin"||l==="super_admin"?"Add new patches to get started.":"Please check back later."}),Ne&&e.jsx("button",{onClick:Ze,className:"mt-6 btn-primary text-sm",children:"Clear All Filters & Search"})]}):e.jsx(Et,{columns:ct,data:Be,rowClassName:"group",isLoading:v||de,currentPage:$,totalPages:J,onPageChange:Qe,itemsPerPage:G,totalItems:ae,sortColumn:y,sortOrder:q,onSort:Ye,isSelectionEnabled:!0,selectedItemIds:d,onSelectItem:rt,onSelectAllItems:at}),_&&P&&e.jsx(Ee,{isOpen:_,title:"Delete Patch",message:`Delete "${P.patch_name}"?`,onConfirm:st,onCancel:_e,isConfirming:de,confirmButtonText:"Delete",confirmButtonVariant:"danger"}),Le&&e.jsx(Ee,{isOpen:Le,title:`Delete ${d.size} Patch(es)`,message:`Delete ${d.size} selected items?`,onConfirm:nt,onCancel:()=>we(!1),isConfirming:Ce,confirmButtonText:"Delete Selected",confirmButtonVariant:"danger"}),Me&&e.jsx(qt,{isOpen:Me,onClose:()=>fe(!1),title:`Move ${d.size} Patch(es)`,children:e.jsxs("div",{className:"p-4",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mb-2",children:"Select target Software and Version:"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"modalSoftwareMove",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Target Software"}),e.jsxs("select",{id:"modalSoftwareMove",value:ee??"",onChange:t=>{ve(t.target.value?parseInt(t.target.value):null),be(null)},className:"input-class w-full",disabled:T||Z.length===0,children:[e.jsx("option",{value:"",children:"Select Software..."}),Z.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),ee&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"modalVersionMove",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Target Version"}),e.jsxs("select",{id:"modalVersionMove",value:pe??"",onChange:t=>be(t.target.value?parseInt(t.target.value):null),className:"input-class w-full",disabled:T||je||ke.length===0,children:[e.jsx("option",{value:"",children:je?"Loading...":"Select Version..."}),ke.map(t=>e.jsx("option",{value:t.id,children:t.version_number},t.id))]}),ke.length===0&&!je&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:"No versions for selected software."})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[e.jsx("button",{type:"button",onClick:()=>fe(!1),className:"btn-secondary",disabled:T,children:"Cancel"}),e.jsx("button",{type:"button",onClick:it,className:"btn-primary",disabled:T||!ee||!pe,children:T?"Moving...":"Confirm Move"})]})]})}),m&&w&&e.jsxs("div",{ref:Se,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("h3",{className:"text-xl font-semibold text-gray-800 dark:text-white mb-4",children:["Comments for: ",e.jsx("span",{className:"font-bold text-blue-600 dark:text-blue-400",children:w.patch_name})]}),e.jsx(zt,{itemId:w.id,itemType:"patch"})]}),!m&&w&&e.jsx("div",{ref:Se,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 text-center",children:e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Please log in to view and manage comments."})})]})};export{es as default};
