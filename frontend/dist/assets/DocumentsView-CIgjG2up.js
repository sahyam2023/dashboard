import{r as s,u as Ke,f as Qe,s as x,j as e,L as _t,F as Me,X as Ct,a as It,e as Mt,b as M,c as At,d as Et,g as Pt,h as Ut,i as Tt,k as Lt,l as zt,D as Ce,m as $t,n as Xe,C as Je,o as Rt,R as Ie,E as Bt,S as Ot,M as Vt,p as qt,q as Gt,t as Ht,v as Wt,w as Xt}from"./index-CRY20gw9.js";import{C as Jt,D as Zt}from"./DataTable-DQWsU1Ng.js";import{y as Yt,F as Kt,E as Qt}from"./validationUtils-WU0SlS9E.js";import{E as es}from"./ErrorState-Bk4iuA34.js";import{u as ts,M as et,U as ss,o as rs,c as as,a as X,b as os,T as Ze,d as ls,F as ns,C as ds,P as is}from"./CommentSection-DzCzTiYL.js";import{F as cs}from"./fuse-Ch1WBRTM.js";import{M as us}from"./Modal-Dq8btZl1.js";import{P as ms}from"./plus-circle-B969A4oC.js";const fs=as().shape({selectedSoftwareId:X().required("Software selection is required."),docName:X().trim().min(1,"Document Name cannot be empty and must contain non-space characters.").max(255,"Document Name cannot exceed 255 characters."),docType:X().transform(l=>l===""?void 0:l).nullable().optional(),inputMode:X().oneOf(["url","upload"]).required("Input mode must be selected."),externalUrl:X().when("inputMode",(l,m)=>(Array.isArray(l)?l[0]:l)==="url"?Yt().required("External Download URL is required."):X().optional().nullable()),selectedFile:os().when(["inputMode","$isEditMode","$documentToEditIsExternal"],{is:(l,m,_)=>l!=="upload"?!1:!!(!m||m&&_),then:l=>l.required("Please select a file to upload.").test("filePresent","File is required.",m=>!!m),otherwise:l=>l.nullable()}),description:X().optional().max(1e3,"Description cannot exceed 1000 characters.")}),Ye=({documentToEdit:l,onDocumentAdded:m,onDocumentUpdated:_,onCancelEdit:h})=>{const g=!!l,{register:p,handleSubmit:J,formState:{errors:i},watch:O,setValue:A,reset:Z}=ts({resolver:rs(fs),context:{isEditMode:g,documentToEditIsExternal:(l==null?void 0:l.is_external_link)||!1},defaultValues:{selectedSoftwareId:"",docName:"",docType:"",description:"",inputMode:"url",externalUrl:"",selectedFile:null}}),[pe,R]=s.useState([]),[V,q]=s.useState(null),[b,E]=s.useState(!1),[C,te]=s.useState(!1),[se,N]=s.useState(0),[G,y]=s.useState(!1),F=s.useRef(null),{isAuthenticated:P,user:re}=Ke(),U=re==null?void 0:re.role,B=O("inputMode"),z=O("selectedFile");s.useEffect(()=>{const r=T=>{G&&(T.preventDefault(),T.returnValue="")};return window.addEventListener("beforeunload",r),()=>{window.removeEventListener("beforeunload",r)}},[G]),s.useEffect(()=>{const r=()=>{document.visibilityState==="hidden"&&G&&It("Changing tabs or minimizing the window might interrupt the upload process.")};return document.addEventListener("visibilitychange",r),()=>{document.removeEventListener("visibilitychange",r)}},[G]),s.useEffect(()=>{P&&(U==="admin"||U==="super_admin")&&(te(!0),Qe().then(R).catch(()=>x("Failed to load software list.")).finally(()=>te(!1)))},[P,U]),s.useEffect(()=>{var r;if(g&&l){const T={selectedSoftwareId:((r=l.software_id)==null?void 0:r.toString())||"",docName:l.doc_name,docType:l.doc_type||"",description:l.description||"",inputMode:l.is_external_link?"url":"upload",externalUrl:l.is_external_link?l.download_link:""};if(Z(T),l.is_external_link)q(null);else{const I=l.download_link.split("/");q(l.original_filename_ref||I[I.length-1])}A("selectedFile",null),F.current&&(F.current.value="")}else Y()},[l,g,Z,A]);const Y=(r=!1)=>{const T=r?O("selectedSoftwareId"):"";Z({selectedSoftwareId:T,docName:"",docType:"",description:"",inputMode:"url",externalUrl:"",selectedFile:null}),q(null),F.current&&(F.current.value="")},ae=r=>{r.target.files&&r.target.files[0]?(A("selectedFile",r.target.files[0],{shouldValidate:!0,shouldDirty:!0}),q(null)):A("selectedFile",null,{shouldValidate:!0,shouldDirty:!0})},be=()=>{if(A("selectedFile",null,{shouldValidate:!0,shouldDirty:!0}),F.current&&(F.current.value=""),g&&l&&!l.is_external_link){const r=l.download_link.split("/");q(l.original_filename_ref||r[r.length-1])}},K=async r=>{var T,I,L,we;E(!0),r.inputMode==="upload"&&r.selectedFile&&y(!0),N(0);try{let c;const w={software_id:r.selectedSoftwareId,doc_name:r.docName.trim(),description:((T=r.description)==null?void 0:T.trim())||"",doc_type:((I=r.docType)==null?void 0:I.trim())||""};if(r.inputMode==="url"){const k={software_id:parseInt(r.selectedSoftwareId),doc_name:w.doc_name,description:w.description,doc_type:w.doc_type,download_link:r.externalUrl.trim()};g&&l?(c=await Mt(l.id,k),M(`Document "${c.doc_name}" updated successfully!`),_&&_(c)):(c=await At(k),M(`Document "${c.doc_name}" added successfully!`),m&&m(c),g||Y(!0))}else{const k={software_id:parseInt(r.selectedSoftwareId),doc_name:w.doc_name,description:w.description,doc_type:w.doc_type};if(g&&l)if(!l.is_external_link||l.is_external_link&&r.selectedFile)console.log("AdminDocumentEntryForm: Editing existing document (file or switching to file). File selected:",r.selectedFile),c=await Et(l.id,k,r.selectedFile||null),M(`Document "${c.doc_name}" updated successfully!`),_&&_(c);else{x("If switching from a URL to an uploaded file, please select a file."),E(!1),y(!1);return}else if(r.selectedFile)console.log("AdminDocumentEntryForm: Adding new document with file. File selected:",r.selectedFile),c=await Pt(r.selectedFile,"document",w,ke=>N(ke)),M(`Document "${c.doc_name}" added successfully via chunked upload!`),m&&m(c),Y(!0);else{x("No file selected for upload. Please select a file."),E(!1),y(!1);return}}}catch(c){console.error("Error in AdminDocumentEntryForm onSubmit:",c);const w=((we=(L=c.response)==null?void 0:L.data)==null?void 0:we.msg)||c.message;let k=`Failed to ${g&&r.inputMode==="url"?"update":"add"} document.`;w&&typeof w=="string"&&w.includes("UNIQUE constraint failed")?g?k="A document with this name already exists for this software. Please use a different name or check for duplicates.":k="A document with this name already exists for this software. Please use a different name.":w&&(k=w),x(k),r.inputMode==="upload"&&y(!1)}finally{console.log("AdminDocumentEntryForm onSubmit finally block reached."),E(!1),r.inputMode==="upload"&&y(!1)}},H=r=>{console.error("Form validation errors (onFormError) in AdminDocumentEntryForm:",r),console.log("AdminDocumentEntryForm onFormError, active element:",document.activeElement),x("Please correct the errors highlighted in the form.")},ye=["Guide","Manual","API Reference","Datasheet","Whitepaper","Specification","Other"];return!P||!U||!["admin","super_admin"].includes(U)?null:e.jsxs("form",{onSubmit:J(K,H),className:"space-y-6 bg-white dark:bg-gray-800 dark:border-gray-700 p-6 rounded-lg shadow-md border border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-800 dark:text-gray-100",children:g?"Edit Document":"Add New Document"}),g&&h&&e.jsxs("button",{type:"button",onClick:h,disabled:b,className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",children:[e.jsx(et,{size:18,className:"mr-2"}),"Cancel Edit"]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedSoftwareId",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Software*"}),C?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading software..."}):e.jsxs("select",{id:"selectedSoftwareId",...p("selectedSoftwareId"),disabled:b||C,className:`mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${i.selectedSoftwareId?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",disabled:!0,children:"Select Software"}),pe.map(r=>e.jsx("option",{value:r.id.toString(),children:r.name},r.id))]}),i.selectedSoftwareId&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:i.selectedSoftwareId.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"docName",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Document Name*"}),e.jsx("input",{type:"text",id:"docName",...p("docName"),disabled:b,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${i.docName?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),i.docName&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.docName.message})]}),e.jsxs("div",{className:"my-4",children:[e.jsx("span",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Document Source:"}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",...p("inputMode"),value:"url",className:"form-radio h-4 w-4 text-blue-600",disabled:b}),e.jsxs("span",{className:"flex items-center dark:text-gray-300",children:[e.jsx(_t,{size:16,className:"mr-1 text-gray-600 dark:text-gray-400"}),"Provide External Link"]})]}),e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",...p("inputMode"),value:"upload",className:"form-radio h-4 w-4 text-blue-600",disabled:b}),e.jsxs("span",{className:"flex items-center dark:text-gray-300",children:[e.jsx(ss,{size:16,className:"mr-1 text-gray-600 dark:text-gray-400"}),"Upload File"]})]})]}),i.inputMode&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.inputMode.message})]}),B==="url"&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"externalUrl",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"External Download URL*"}),e.jsx("input",{type:"text",id:"externalUrl",...p("externalUrl"),placeholder:"https://example.com/document.pdf",disabled:b,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${i.externalUrl?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),i.externalUrl&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.externalUrl.message})]}),B==="upload"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:g&&V&&!z?"Replace File (Optional)":"Select File to Upload*"}),e.jsx("div",{className:"mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-blue-500 dark:border-gray-600 dark:hover:border-blue-400 transition-colors",children:e.jsxs("div",{className:"space-y-1 text-center",children:[e.jsx(Me,{className:"mx-auto h-12 w-12 text-gray-400 dark:text-gray-500"}),e.jsxs("div",{className:"flex text-sm text-gray-600 dark:text-gray-400",children:[e.jsxs("label",{htmlFor:"doc-file-upload-input",className:"relative cursor-pointer bg-white dark:bg-gray-800 rounded-md font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500",children:[e.jsx("span",{children:z?"Change file":"Upload a file"}),e.jsx("input",{id:"doc-file-upload-input",name:"doc-file-input",type:"file",className:"sr-only",onChange:ae,ref:F,disabled:b})]}),e.jsx("p",{className:"pl-1",children:"or drag and drop"})]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"PDF, DOCX, PNG, JPG, ZIP etc."})]})}),(z||V)&&e.jsxs("div",{className:"mt-3 flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md",children:[e.jsxs("div",{className:"flex items-center space-x-2 overflow-hidden",children:[e.jsx(Me,{size:18,className:"text-gray-500 dark:text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:z?z.name:V}),g&&V&&!z&&e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 ml-2",children:"(current)"})]}),z&&e.jsx("button",{type:"button",onClick:be,disabled:b,className:"p-1 rounded-full text-gray-400 hover:text-gray-600 hover:bg-gray-200 dark:text-gray-500 dark:hover:text-gray-300 dark:hover:bg-gray-600",children:e.jsx(Ct,{size:16})})]}),i.selectedFile&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.selectedFile.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"docType",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Document Type"}),e.jsxs("select",{id:"docType",...p("docType"),disabled:b,className:`mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${i.docType?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",children:"Select Type (Optional)"}),ye.map(r=>e.jsx("option",{value:r,children:r},r))]}),i.docType&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.docType.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Description"}),e.jsx("textarea",{id:"description",rows:3,...p("description"),disabled:b,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${i.description?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),i.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.description.message})]}),e.jsx("div",{className:"flex space-x-3",children:e.jsx("button",{type:"submit",disabled:b||C,className:"flex-1 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",children:b?g?"Updating...":"Adding...":g?"Update Document":"Add Document"})}),b&&B==="upload"&&se>0&&e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 my-3 relative",children:[e.jsx("div",{className:"bg-blue-600 h-4 rounded-full transition-all duration-150 ease-out",style:{width:`${se}%`}}),e.jsxs("p",{className:"absolute inset-0 text-center text-xs font-medium leading-4 text-white dark:text-gray-100",children:[Math.round(se),"%"]})]})]})},vs=()=>{const{searchTerm:m,setSearchTerm:_}=Ut(),{isAuthenticated:h,user:g}=Ke(),p=g==null?void 0:g.role,[J,i]=s.useState(!1),[O,A]=s.useState(null),[Z,pe]=s.useState(!1),[R,V]=s.useState(null),[q,b]=s.useState(!1),[E,C]=s.useState(new Map),[te,se]=s.useState(!1),[N,G]=s.useState(null),[y,F]=s.useState([]),[P,re]=s.useState([]),[U,B]=s.useState(!0),[z,Y]=s.useState(!1),[ae,be]=s.useState(null),[K,H]=s.useState(1),[ye,r]=s.useState(0),[T,I]=s.useState(!1),[L,we]=s.useState("doc_name"),[c,w]=s.useState("asc"),[k,ke]=s.useState(""),[oe,Ae]=s.useState(""),[le,Ee]=s.useState(""),[ne,Pe]=s.useState(""),[de,Ue]=s.useState(""),[ie,tt]=s.useState(""),[ce,st]=s.useState(""),[ue,rt]=s.useState(""),[me,at]=s.useState(""),[fe,ot]=s.useState(""),[j,Q]=s.useState(new Set),[Te,ve]=s.useState(!1),[je,Ne]=s.useState(null),[Le,Fe]=s.useState(!1),[ze,$e]=s.useState(!1),[lt,Re]=s.useState(!1),[ge,Be]=s.useState(!1),[S,xe]=s.useState(null),Se=s.useRef(null),Oe=Tt(),[he,Ve]=Lt(),[nt,u]=s.useState(null),De=s.useMemo(()=>N!==null||k!==""||oe!==""||le!==""||ne!==""||de!==""||m!=="",[N,k,oe,le,ne,de,m]),qe=s.useCallback(()=>{u(null),G(null),ke(""),Ae(""),Ee(""),Pe(""),Ue(""),_&&_("")},[_,u]),v=s.useCallback(async(t,a=!1)=>{var o,d;a?(B(!0),be(null)):Y(!0);try{const n=await zt(N===null?void 0:N,t,15,L,c,ie||void 0,ce||void 0,ue||void 0,me||void 0,fe||void 0,m),f=n.documents;F(ee=>{const D=a?f:[...ee,...f];return C(W=>{const $=new Map;if(h&&D)for(const We of D)$.set(We.id,{favoriteId:We.favorite_id});return $}),D}),r(n.total_documents),H(n.page),I(n.page<n.total_pages)}catch(n){console.error(`Failed to load documents (page ${t}):`,n);const f=((d=(o=n.response)==null?void 0:o.data)==null?void 0:d.msg)||n.message||"Failed to fetch documents.";a?(be(f),F([]),I(!1)):(x(f),I(!1))}finally{a?B(!1):Y(!1)}},[N,15,L,c,ie,ce,ue,me,fe,h,m]);s.useEffect(()=>{u(null);const t=setTimeout(()=>tt(k),500);return()=>clearTimeout(t)},[k,u]),s.useEffect(()=>{u(null);const t=setTimeout(()=>st(oe),500);return()=>clearTimeout(t)},[oe,u]),s.useEffect(()=>{u(null);const t=setTimeout(()=>rt(le),500);return()=>clearTimeout(t)},[le,u]),s.useEffect(()=>{u(null);const t=setTimeout(()=>at(ne),500);return()=>clearTimeout(t)},[ne,u]),s.useEffect(()=>{u(null);const t=setTimeout(()=>ot(de),500);return()=>clearTimeout(t)},[de,u]),s.useEffect(()=>{if(u(null),!h){F([]),C(new Map),H(1),I(!1),B(!1);return}v(1,!0)},[h,N,L,c,ie,ce,ue,me,fe,m,v,u]),s.useEffect(()=>{Q(new Set)},[N,L,c,ie,ce,ue,me,fe,m,K]),s.useEffect(()=>{h&&(async()=>{try{const a=await Qe();re(a)}catch(a){console.error("Failed to load software for filters",a),x("Failed to load software list for filtering.")}})()},[h]),s.useEffect(()=>{const t=new URLSearchParams(Oe.search),a=t.get("item_id"),o=t.get("comment_id");if(a&&o&&y.length>0){const d=parseInt(a,10);if(!isNaN(d)){const n=y.find(f=>f.id===d);n?((!S||S.id!==n.id)&&xe(n),setTimeout(()=>{var f;(f=Se.current)==null||f.scrollIntoView({behavior:"smooth",block:"center"})},100)):console.warn(`DocumentsView: Document with item_id ${d} not found in the current list.`)}}},[Oe.search,y]),s.useEffect(()=>{const t=he.get("page"),a=he.get("highlight");if(t){const o=parseInt(t,10);!isNaN(o)&&o>0&&o!==K&&(H(o),v(o,!0))}u(a||null)},[he,K,H,v]);const dt=t=>{u(null),G(t)};s.useEffect(()=>{if(u(null),!h){F([]),C(new Map),H(1),I(!1),B(!1);return}v(1,!0)},[h,N,L,c,ie,ce,ue,me,fe,m,v,u]);const it=t=>{u(null);const a=L===t&&c==="asc"?"desc":"asc";we(t),w(a)},ct=s.useCallback(t=>{u(null),v(t,!0),Q(new Set);const a=new URLSearchParams(he);a.set("page",t.toString()),a.delete("highlight"),Ve(a)},[v,u,he,Ve]),ut=t=>{i(!1),v(1,!0)},mt=t=>{A(null),v(1,!0)},ft=t=>{i(!1),A(t),window.scrollTo({top:0,behavior:"smooth"})},gt=()=>A(null),xt=t=>{V(t),pe(!0)},_e=()=>{V(null),pe(!1)},ht=async()=>{if(R){b(!0),S&&R.id===S.id&&xe(null);try{await qt(R.id),M(`Document "${R.doc_name}" deleted.`),_e(),v(1,!0)}catch(t){x(t.message||"Failed to delete document."),_e()}finally{b(!1)}}},Ge=s.useMemo(()=>m?new cs(y,{keys:["doc_name","description","software_name","uploaded_by_username","updated_by_username"],includeScore:!0,threshold:.4}).search(m).map(a=>a.item):y,[y,m]),pt=(t,a)=>{Q(o=>{const d=new Set(o);return a?d.add(t):d.delete(t),d})},bt=t=>{const a=new Set;t&&Ge.forEach(o=>a.add(o.id)),Q(a)},yt=()=>{if(j.size===0){x("No items selected.");return}Fe(!0)},wt=async()=>{Fe(!1),$e(!0);try{const t=await Gt(Array.from(j),"document");M(t.msg||`${t.deleted_count} item(s) deleted.`),Q(new Set),S&&j.has(S.id)&&xe(null),v(1,!0)}catch(t){x(t.message||"Bulk delete failed.")}finally{$e(!1)}},kt=async()=>{if(j.size===0){x("No items selected.");return}const t=y.filter(o=>j.has(o.id)&&!o.is_external_link&&o.is_downloadable!==!1);if(t.length===0){x("No downloadable files selected. External links or non-downloadable items cannot be bulk downloaded.");return}const a=t.map(o=>o.id);Re(!0);try{const o=await Rt(a,"document"),d=URL.createObjectURL(o),n=document.createElement("a");n.href=d;const f=new Date().toISOString().replace(/:/g,"-");n.download=`bulk_download_documents_${f}.zip`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(d),a.length===j.size?M("Download started for all selected downloadable documents."):M(`Starting download for ${a.length} file(s). External links or non-downloadable items were excluded.`)}catch(o){x(o.message||"Bulk download failed.")}finally{Re(!1)}},vt=()=>{if(j.size===0){x("No items selected.");return}if(P.length===0){x("Software list unavailable.");return}Ne(null),ve(!0)},jt=async()=>{if(!je){x("Select target software.");return}ve(!1),Be(!0);try{const t=await Ht(Array.from(j),"document",{target_software_id:je});M(t.msg||`${t.moved_count} item(s) moved.`),Q(new Set),v(1,!0)}catch(t){let a="Bulk move failed.";t.message&&typeof t.message=="string"&&t.message.includes("UNIQUE constraint failed")?a="A document with this name already exists in the target software category. Please check for duplicates.":t.message&&(a=t.message),x(a)}finally{Be(!1),Ne(null)}},St=[{key:"doc_name",header:"Name",sortable:!0},{key:"doc_type",header:"Type",sortable:!0},{key:"software_name",header:"Software",sortable:!0},{key:"description",header:"Description",render:(t,a)=>{const o=Ie.useRef(null),[d,n]=Ie.useState(!1),f=t.description||"-";return Ie.useEffect(()=>{o.current&&n(o.current.scrollHeight>o.current.clientHeight)},[t.description]),e.jsxs("div",{className:"flex items-center justify-between w-72",children:[e.jsx("span",{ref:o,className:"block line-clamp-3 text-sm w-full",title:t.description||"",children:f}),d&&e.jsx("button",{onClick:ee=>{ee.stopPropagation(),a.showModal(t.description||"-")},className:"ml-2 p-1 text-blue-600 hover:text-blue-800 flex-shrink-0",title:"Read More",children:e.jsx(Bt,{size:16})})]})}},{key:"download_link",header:"Download",render:t=>{var d;const a=t.is_external_link||t.is_downloadable;return!(t.is_external_link||t.is_downloadable!==!1)&&!t.is_external_link?e.jsxs("span",{className:"flex items-center text-gray-400 cursor-not-allowed",title:"Download not permitted",children:[e.jsx(Ce,{size:14,className:"mr-1"}),"Link"]}):e.jsxs("a",{href:t.download_link,target:t.is_external_link||!((d=t.download_link)!=null&&d.startsWith("/"))?"_blank":"_self",rel:"noopener noreferrer",className:`flex items-center ${a?"text-blue-600 hover:text-blue-800":"text-gray-400 cursor-not-allowed"}`,onClick:n=>{a||n.preventDefault(),n.stopPropagation()},title:a?t.is_external_link?"Open external link":"Download file":"Download not permitted",children:[t.is_external_link?e.jsx(Qt,{size:14,className:"mr-1"}):e.jsx(Ce,{size:14,className:"mr-1"}),"Link"]})}},{key:"uploaded_by_username",header:"Uploaded By",sortable:!0,render:t=>t.uploaded_by_username||"N/A"},{key:"updated_by_username",header:"Updated By",sortable:!1,render:t=>t.updated_by_username||"N/A"},{key:"created_at",header:"Created At",sortable:!0,render:t=>Xe(t.created_at??"")},{key:"updated_at",header:"Updated At",sortable:!0,render:t=>Xe(t.updated_at??"")},{key:"actions",header:"Actions",render:t=>{var a,o,d;return e.jsxs("div",{className:"flex space-x-1 items-center",children:[h&&e.jsx("button",{onClick:n=>{n.stopPropagation(),Dt(t,"document")},className:`p-1 rounded-md ${(a=E.get(t.id))!=null&&a.favoriteId?"text-yellow-500 hover:text-yellow-600":"text-gray-400 hover:text-yellow-500"}`,title:(o=E.get(t.id))!=null&&o.favoriteId?"Remove Favorite":"Add Favorite",children:e.jsx(Ot,{size:16,className:(d=E.get(t.id))!=null&&d.favoriteId?"fill-current":""})}),(p==="admin"||p==="super_admin")&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:n=>{n.stopPropagation(),ft(t)},className:"p-1 text-blue-600 hover:text-blue-800 rounded-md",title:"Edit",children:e.jsx(is,{size:16})}),e.jsx("button",{onClick:n=>{n.stopPropagation(),xt(t)},className:"p-1 text-red-600 hover:text-red-800 rounded-md",title:"Delete",children:e.jsx(Ze,{size:16})})]}),h&&e.jsxs("button",{onClick:n=>{n.stopPropagation(),S&&S.id===t.id?xe(null):(xe(t),setTimeout(()=>{var f;return(f=Se.current)==null?void 0:f.scrollIntoView({behavior:"smooth"})},0))},className:"p-1 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 rounded-md",title:S&&S.id===t.id?"Hide Comments":"View Comments",children:[e.jsx(Vt,{size:16}),e.jsxs("span",{className:"ml-1 text-xs",children:["(",t.comment_count??0,")"]})]})]})}}],Nt=Math.ceil(ye/15),He=s.useCallback(()=>{v(1,!0)},[v]),Ft=()=>O?e.jsx("div",{className:"my-6 p-4 bg-gray-50 rounded-lg shadow dark:bg-gray-700",children:e.jsx(Ye,{documentToEdit:O,onDocumentUpdated:mt,onCancelEdit:gt})}):J?e.jsx("div",{className:"my-6 p-4 bg-gray-50 rounded-lg shadow dark:bg-gray-700",children:e.jsx(Ye,{onDocumentAdded:ut,onCancelEdit:()=>i(!1)})}):null,Dt=async(t,a)=>{var f,ee;if(!h){x("Please log in to manage favorites.");return}const o=E.get(t.id),d=!!(o!=null&&o.favoriteId),n=new Map(E);d?n.set(t.id,{favoriteId:void 0}):n.set(t.id,{favoriteId:-1}),C(n);try{if(d&&typeof(o==null?void 0:o.favoriteId)=="number")await Wt(t.id,a),M(`"${t.doc_name}" removed from favorites.`),C(D=>{const W=new Map(D);return W.set(t.id,{favoriteId:void 0}),W});else{const D=await Xt(t.id,a);C(W=>{const $=new Map(W);return $.set(t.id,{favoriteId:D.id}),$}),M(`"${t.doc_name}" added to favorites.`)}}catch(D){x(((ee=(f=D==null?void 0:D.response)==null?void 0:f.data)==null?void 0:ee.msg)||D.message||"Failed to update favorite."),C(W=>{const $=new Map(W);return d?$.set(t.id,{favoriteId:o==null?void 0:o.favoriteId}):$.set(t.id,{favoriteId:void 0}),$})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-start sm:items-center mb-6 flex-col sm:flex-row",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800 dark:text-white",children:"Documents"}),e.jsx("p",{className:"text-gray-600 mt-1 dark:text-gray-300",children:"Browse and manage official documents and resources."})]}),h&&(p==="admin"||p==="super_admin")&&!O&&e.jsxs("button",{onClick:()=>{i(t=>!t),A(null)},className:`mt-4 sm:mt-0 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white ${J?"bg-red-600 hover:bg-red-700 focus:ring-red-500":"bg-blue-600 hover:bg-blue-700 focus:ring-blue-500"} focus:outline-none focus:ring-2 focus:ring-offset-2`,children:[J?e.jsx(et,{size:18,className:"mr-2"}):e.jsx(ms,{size:18,className:"mr-2"}),J?"Cancel":"Add New Document"]})]}),Ft(),j.size>0&&e.jsx("div",{className:"my-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:[j.size," item(s) selected"]}),(p==="admin"||p==="super_admin")&&e.jsxs("button",{onClick:yt,disabled:ze,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-800 focus:ring-red-500 disabled:opacity-50",children:[e.jsx(Ze,{size:14,className:"mr-1.5"}),"Delete"]}),h&&e.jsxs("button",{onClick:kt,disabled:lt,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-green-500 hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 focus:ring-green-500 disabled:opacity-50",children:[e.jsx(Ce,{size:14,className:"mr-1.5"}),"Download"]}),(p==="admin"||p==="super_admin")&&e.jsxs("button",{onClick:vt,disabled:ge,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 focus:ring-blue-500 disabled:opacity-50",children:[e.jsx(ls,{size:14,className:"mr-1.5"}),"Move"]})]})}),P.length>0&&e.jsx(Kt,{software:P,selectedSoftwareId:N,onSelectFilter:dt}),e.jsx("div",{className:"mb-4",children:e.jsxs("button",{onClick:()=>se(t=>!t),className:"flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-md text-sm font-medium",children:[te?e.jsxs(e.Fragment,{children:[e.jsx(Jt,{size:18,className:"mr-2"}),"Hide"]}):e.jsxs(e.Fragment,{children:[e.jsx(ns,{size:18,className:"mr-2"}),"Show"]})," Advanced Filters"]})}),te&&e.jsxs("div",{className:"my-4 p-4 border dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 space-y-4 md:space-y-0 md:flex md:flex-wrap md:items-end md:gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"docTypeFilterInput",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Doc Type"}),e.jsx("input",{id:"docTypeFilterInput",type:"text",value:k,onChange:t=>ke(t.target.value),placeholder:"e.g., Manual",className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Created"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"date",value:oe,onChange:t=>Ae(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"to"}),e.jsx("input",{type:"date",value:le,onChange:t=>Ee(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Updated"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"date",value:ne,onChange:t=>Pe(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"to"}),e.jsx("input",{type:"date",value:de,onChange:t=>Ue(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"})]})]}),e.jsx("div",{className:"flex items-end gap-2 pt-5",children:e.jsx("button",{onClick:qe,className:"text-sm px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"Clear"})})]}),U?e.jsx("div",{className:"py-10",children:e.jsx($t,{message:"Loading documents..."})}):ae&&y.length===0&&!U?e.jsx(es,{message:ae,onRetry:He}):!U&&!ae&&y.length===0?e.jsxs("div",{className:"text-center py-10 bg-white dark:bg-gray-800 rounded-lg shadow-sm my-6",children:[e.jsx(Me,{size:48,className:"mx-auto text-yellow-500 dark:text-yellow-400 mb-4"}),e.jsx("p",{className:"text-xl font-semibold text-gray-700 dark:text-gray-200 mb-3",children:De?"No Documents Found Matching Criteria":"No Documents Available"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 px-4",children:De?"Try adjusting or clearing your search/filter settings.":p==="admin"||p==="super_admin"?"Add new documents to get started.":"Please check back later."}),De&&e.jsx("button",{onClick:qe,className:"mt-6 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-sm font-medium",children:"Clear All Filters & Search"})]}):e.jsx(Zt,{columns:St,data:Ge,highlightedRowId:nt,rowClassName:"group",isLoading:U||z,currentPage:K,totalPages:Nt,onPageChange:ct,itemsPerPage:15,totalItems:ye,sortColumn:L,sortOrder:c,onSort:it,isSelectionEnabled:!0,selectedItemIds:j,onSelectItem:pt,onSelectAllItems:bt}),Z&&R&&e.jsx(Je,{isOpen:Z,title:"Delete Document",message:`Delete "${R.doc_name}"?`,onConfirm:ht,onCancel:_e,isConfirming:q,confirmButtonText:"Delete",confirmButtonVariant:"danger"}),Le&&e.jsx(Je,{isOpen:Le,title:`Delete ${j.size} Document(s)`,message:`Delete ${j.size} selected items?`,onConfirm:wt,onCancel:()=>Fe(!1),isConfirming:ze,confirmButtonText:"Delete Selected",confirmButtonVariant:"danger"}),Te&&e.jsx(us,{isOpen:Te,onClose:()=>ve(!1),title:`Move ${j.size} Document(s)`,children:e.jsxs("div",{className:"p-4",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mb-4",children:"Select target software:"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"targetSoftware",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Target Software"}),e.jsxs("select",{id:"targetSoftware",value:je??"",onChange:t=>Ne(t.target.value?parseInt(t.target.value):null),className:"input-class w-full dark:bg-gray-700 dark:text-white dark:border-gray-600",disabled:P.length===0||ge,children:[e.jsx("option",{value:"",children:"Select Software..."}),P.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),P.length===0&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:"Software list unavailable."})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[e.jsx("button",{type:"button",onClick:()=>ve(!1),className:"px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500",disabled:ge,children:"Cancel"}),e.jsx("button",{type:"button",onClick:jt,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",disabled:ge||!je,children:ge?"Moving...":"Confirm Move"})]})]})}),h&&S&&e.jsxs("div",{ref:Se,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("h3",{className:"text-xl font-semibold text-gray-800 dark:text-white mb-4",children:["Comments for: ",e.jsx("span",{className:"font-bold text-blue-600 dark:text-blue-400",children:S.doc_name})]}),e.jsx(ds,{itemId:S.id,itemType:"document",onCommentAction:He})]}),!h&&S&&e.jsx("div",{ref:Se,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 text-center",children:e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Please log in to view and manage comments."})})]})};export{vs as default};
