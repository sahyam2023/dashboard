import{r as s,u as Qe,f as et,s as u,q as we,j as e,L as tt,F as Ye,X as St,y as jt,a as M,z as Nt,c as It,d as Lt,g as Ft,A as _t,i as Ct,k as Vt,S as Mt,B as At,m as Dt,n as Ut,o as Pt,p as zt}from"./index-t2ASA2B1.js";import{u as $t,U as Et,o as Rt,c as Ot,a as G,b as Bt,P as Tt,T as Ge,D as Je,M as qt,F as Wt,C as Ht,e as Xt,d as Yt}from"./CommentSection-VEQiTIm6.js";import{C as Gt,D as Jt,a as Ke,M as Kt}from"./Modal-fg1J31IM.js";import{f as Ze}from"./dateUtils-C4q4Gbs_.js";import{F as Zt}from"./FilterTabs-BkU7b_jA.js";import{E as Qt}from"./ErrorState-CcKc3HNZ.js";const J="CREATE_NEW_VERSION_SENTINEL_VALUE",es=Ot().shape({selectedSoftwareId:G().required("Software Product must be selected."),title:G().required("Link Title is required.").max(255,"Title cannot exceed 255 characters."),selectedVersionId:G().required("Version must be selected or a new one entered."),typedVersionString:G().when("selectedVersionId",{is:J,then:r=>r.required('New Version String is required when "Enter New Version" is selected.').min(1,"New Version String cannot be empty."),otherwise:r=>r.transform(y=>y===""?void 0:y).optional().nullable()}),inputMode:G().oneOf(["url","upload"]).required("Input mode must be selected."),externalUrl:G().when("inputMode",{is:"url",then:r=>r.required("External URL is required for URL mode.").url("Please enter a valid URL (e.g., http://example.com)."),otherwise:r=>r.optional().nullable()}),selectedFile:Bt().when(["inputMode","isEditMode","existingFileName"],{is:(r,y,x)=>r==="upload"&&(!y||!x),then:r=>r.required("A file is required for new link uploads.").test("filePresent","A file is required for new link uploads.",y=>!!y),otherwise:r=>r.nullable()}),description:G().optional().max(1e3,"Description cannot exceed 1000 characters.")}),ts=({linkToEdit:r,onLinkAdded:y,onLinkUpdated:x,onCancelEdit:E})=>{const o=!!r,{register:g,handleSubmit:ne,control:K,formState:{errors:d},watch:R,setValue:f,reset:h}=$t({resolver:Rt(es),context:{isEditMode:o,existingFileName:(r==null?void 0:r.original_filename_ref)||(r&&!r.is_external_link?r.url.split("/").pop():null)},defaultValues:{selectedSoftwareId:"",title:"",selectedVersionId:"",typedVersionString:"",inputMode:"url",externalUrl:"",selectedFile:null,description:""}}),[Z,A]=s.useState([]),[D,N]=s.useState([]),[T,U]=s.useState(null),[b,F]=s.useState(!1),[O,P]=s.useState(!1),[ie,q]=s.useState(0),{isAuthenticated:oe,user:Q}=Qe(),v=Q==null?void 0:Q.role,I=s.useRef(null),L=R("selectedSoftwareId"),ve=R("selectedVersionId"),ee=R("inputMode"),z=R("selectedFile"),te=ve===J;s.useEffect(()=>{oe&&(v==="admin"||v==="super_admin")&&(P(!0),et().then(A).catch(()=>u("Failed to load software list.")).finally(()=>P(!1)))},[oe,v]),s.useEffect(()=>{L?(P(!0),N([]),f("selectedVersionId",""),f("typedVersionString",""),we(parseInt(L)).then(N).catch(()=>u("Failed to load versions for selected software.")).finally(()=>P(!1))):(N([]),f("selectedVersionId",""),f("typedVersionString",""))},[L,f]),s.useEffect(()=>{if(o&&r){const a={selectedSoftwareId:r.software_id.toString(),title:r.title,description:r.description||"",inputMode:r.is_external_link?"url":"upload",externalUrl:r.is_external_link?r.url:""};r.version_id&&r.software_id.toString()===L&&D.length>0?D.find(C=>C.id===r.version_id)?(a.selectedVersionId=r.version_id.toString(),a.typedVersionString=r.version_number):(a.selectedVersionId=J,a.typedVersionString=r.version_number):r.version_number&&(a.selectedVersionId=J,a.typedVersionString=r.version_number),h(a),r.is_external_link?U(null):U(r.original_filename_ref||r.url.split("/").pop()||"unknown_file"),f("selectedFile",null),I.current&&(I.current.value="")}else o||_(!!L)},[o,r,h,f,D,L]);const _=(a=!1)=>{const j=a?R("selectedSoftwareId"):"";h({selectedSoftwareId:j,title:"",selectedVersionId:"",typedVersionString:"",inputMode:"url",externalUrl:"",selectedFile:null,description:""}),U(null),I.current&&(I.current.value="")},Se=a=>{a.target.files&&a.target.files[0]?f("selectedFile",a.target.files[0],{shouldValidate:!0,shouldDirty:!0}):f("selectedFile",null,{shouldValidate:!0,shouldDirty:!0})},W=()=>{f("selectedFile",null,{shouldValidate:!0,shouldDirty:!0}),I.current&&(I.current.value="")},je=async a=>{var X,de,Y,ce;F(!0),q(0);let j,C;a.selectedVersionId===J&&a.typedVersionString?C=a.typedVersionString.trim():a.selectedVersionId&&a.selectedVersionId!==J&&(j=parseInt(a.selectedVersionId));const H={software_id:parseInt(a.selectedSoftwareId),title:a.title.trim(),description:((X=a.description)==null?void 0:X.trim())||void 0};j&&(H.version_id=j),C&&(H.typed_version_string=C);try{let k;if(a.inputMode==="url"){const S={...H,url:a.externalUrl.trim(),is_external_link:!0};o&&r?(k=await jt(r.id,S),M(`Link "${k.title}" updated successfully!`),x&&x(k)):(k=await Nt(S),M(`Link "${k.title}" added successfully!`),y&&y(k),o||(_(!0),f("selectedVersionId",""),f("typedVersionString","")))}else{if(!a.selectedFile){if(o&&r&&!r.is_external_link&&!a.selectedFile){u("To update metadata of an existing uploaded file link without re-uploading, use a different form/feature. To replace the file, select a new file."),F(!1);return}if(!a.selectedFile&&!o){u("No file selected for upload."),F(!1);return}}const S={software_id:a.selectedSoftwareId,...j&&{version_id:j.toString()},...C&&{typed_version_string:C},link_title:a.title.trim(),description:((de=a.description)==null?void 0:de.trim())||""};k=await It(a.selectedFile,"link_file",S,he=>q(he)),M(`Link file "${k.title}" added successfully via chunked upload!`),y&&y(k),_(!0),f("selectedVersionId",""),f("typedVersionString","")}}catch(k){const S=((ce=(Y=k.response)==null?void 0:Y.data)==null?void 0:ce.msg)||k.message||`Failed to ${o&&a.inputMode==="url"?"update":"add"} link.`;u(S)}finally{F(!1)}},se=a=>{console.error("Form validation errors:",a),u("Please correct the errors highlighted in the form.")};return!oe||!v||!["admin","super_admin"].includes(v)?null:e.jsxs("form",{onSubmit:ne(je,se),className:"space-y-6 bg-white dark:bg-gray-800 dark:border-gray-700 p-6 rounded-lg shadow-md border border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-xl font-semibold text-gray-800 dark:text-gray-100",children:[" ",o?"Edit Link":"Add New Link"," "]}),o&&E&&e.jsx("button",{type:"button",onClick:E,className:"text-sm text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200",children:" Cancel "})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedSoftwareId",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Software Product*"}),O&&!Z.length?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading software..."}):e.jsxs("select",{id:"selectedSoftwareId",...g("selectedSoftwareId"),disabled:b||O&&!Z.length,className:`mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${d.selectedSoftwareId?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",disabled:!0,children:"Select Software Product"}),Z.map(a=>e.jsx("option",{value:a.id.toString(),children:a.name},a.id))]}),d.selectedSoftwareId&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:d.selectedSoftwareId.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedVersionId",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Version*"}),e.jsx("div",{className:"mt-1",children:e.jsxs("select",{id:"selectedVersionId",...g("selectedVersionId"),disabled:b||O||!L,className:`block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${d.selectedVersionId?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",disabled:D.length>0&&!!L,children:O&&L?"Loading versions...":"Select Existing Version"}),D.map(a=>e.jsx("option",{value:a.id.toString(),children:a.version_number},a.id)),e.jsx("option",{value:J,children:"Enter New Version String..."})]})}),te&&e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{htmlFor:"typedVersionString",className:"block text-xs font-medium text-gray-600 dark:text-gray-400",children:"New Version String*:"}),e.jsx("input",{type:"text",id:"typedVersionString",...g("typedVersionString"),placeholder:"e.g., 1.2.4-final",className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.typedVersionString?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"This version will be created for the selected software if it doesn't exist."})]}),d.selectedVersionId&&!te&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.selectedVersionId.message}),d.typedVersionString&&te&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.typedVersionString.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"title",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Link Title*"}),e.jsx("input",{type:"text",id:"title",...g("title"),disabled:b,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.title?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),d.title&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.title.message})]}),e.jsxs("div",{className:"my-4",children:[e.jsx("span",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Link Source:"}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",...g("inputMode"),value:"url",className:"form-radio h-4 w-4 text-blue-600",disabled:b}),e.jsxs("span",{className:"flex items-center dark:text-gray-300",children:[e.jsx(tt,{size:16,className:"mr-1 text-gray-600 dark:text-gray-400"}),"Provide External URL"]})]}),e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",...g("inputMode"),value:"upload",className:"form-radio h-4 w-4 text-blue-600",disabled:b}),e.jsxs("span",{className:"flex items-center dark:text-gray-300",children:[e.jsx(Et,{size:16,className:"mr-1 text-gray-600 dark:text-gray-400"}),"Upload File for this Link"]})]})]}),d.inputMode&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.inputMode.message})]}),ee==="url"&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"externalUrl",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Link URL*"}),e.jsx("input",{type:"url",id:"externalUrl",...g("externalUrl"),placeholder:"https://example.com/resource",disabled:b,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.externalUrl?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),d.externalUrl&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.externalUrl.message})]}),ee==="upload"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:o&&T&&!z?"Replace File (Optional)":"Select File to Upload*"}),e.jsx("div",{className:"mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-blue-500 dark:border-gray-600 dark:hover:border-blue-400 transition-colors",children:e.jsxs("div",{className:"space-y-1 text-center",children:[e.jsx(Ye,{className:"mx-auto h-12 w-12 text-gray-400 dark:text-gray-500"}),e.jsxs("div",{className:"flex text-sm text-gray-600 dark:text-gray-400",children:[e.jsxs("label",{htmlFor:"link-file-upload-input",className:"relative cursor-pointer bg-white dark:bg-gray-800 rounded-md font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500",children:[e.jsx("span",{children:z?"Change file":"Upload a file"}),e.jsx("input",{id:"link-file-upload-input",name:"file-input-element",type:"file",className:"sr-only",onChange:Se,ref:I,disabled:b})]}),e.jsx("p",{className:"pl-1",children:"or drag and drop"})]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Any file type relevant for links."})]})}),(z||o&&T)&&e.jsxs("div",{className:"mt-3 flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md",children:[e.jsxs("div",{className:"flex items-center space-x-2 overflow-hidden",children:[e.jsx(Ye,{size:18,className:"text-gray-500 dark:text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:z?z.name:T}),o&&T&&!z&&e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 ml-2",children:"(current)"})]}),z&&e.jsx("button",{type:"button",onClick:W,disabled:b,className:"p-1 rounded-full text-gray-400 hover:text-gray-600 hover:bg-gray-200 dark:text-gray-500 dark:hover:text-gray-300 dark:hover:bg-gray-600",children:e.jsx(St,{size:16})})]}),d.selectedFile&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.selectedFile.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Description"}),e.jsx("textarea",{id:"description",rows:3,...g("description"),disabled:b,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.description?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),d.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.description.message})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{type:"submit",disabled:b||O,className:"flex-1 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",children:b?o?"Updating...":"Adding...":o?"Update Link":"Add Link"}),o&&E&&e.jsx("button",{type:"button",onClick:E,disabled:b,className:"flex-1 inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 dark:border-gray-500 dark:text-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600",children:"Cancel"})]}),b&&ee==="upload"&&ie>0&&e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 my-3 relative",children:[e.jsx("div",{className:"bg-blue-600 h-4 rounded-full transition-all duration-150 ease-out",style:{width:`${ie}%`}}),e.jsxs("p",{className:"absolute inset-0 text-center text-xs font-medium leading-4 text-white dark:text-gray-100",children:[Math.round(ie),"%"]})]})]})},os=()=>{const{searchTerm:r,setSearchTerm:y}=Lt(),{isAuthenticated:x,user:E}=Qe(),o=E==null?void 0:E.role,[g,ne]=s.useState([]),[K,d]=s.useState([]),[R,f]=s.useState([]),[h,Z]=s.useState(null),[A,D]=s.useState(null),[N,T]=s.useState(""),[U,b]=s.useState(""),[F,O]=s.useState(""),[P,ie]=s.useState(""),[q,oe]=s.useState(""),[Q,v]=s.useState(1),[I,L]=s.useState(15),[ve,ee]=s.useState(0),[z,te]=s.useState(0),[_,Se]=s.useState("title"),[W,je]=s.useState("asc"),[se,a]=s.useState(!0),[j,C]=s.useState(null),[H,X]=s.useState(!1),[de,Y]=s.useState(null),[ce,k]=s.useState(!1),[S,he]=s.useState(null),[Ce,Ve]=s.useState(!1),[ue,me]=s.useState(new Map),[Me,st]=s.useState(!1),[p,ge]=s.useState(new Set),[Ae,De]=s.useState(!1),[rt,Ue]=s.useState(!1),[re,Pe]=s.useState(!1),[ze,pe]=s.useState(!1),[$,Ne]=s.useState(null),[$e,Ee]=s.useState([]),[be,ye]=s.useState(void 0),[Re,Ie]=s.useState(!1),[Le,Oe]=s.useState(!1),[w,fe]=s.useState(null),ke=s.useRef(null),Be=Ft(),Fe=s.useMemo(()=>h!==null||A!==null||N!==""||U!==""||F!==""||r!=="",[h,A,N,U,F,r]),Te=s.useCallback(()=>{Z(null),D(null),T(""),b(""),O(""),y&&y(""),v(1)},[y]),V=s.useCallback(async(t,l=!1)=>{var i,c;l&&a(!0),C(null);try{const n=await _t(h||void 0,A||void 0,t,I,_,W,N||void 0,P||void 0,q||void 0);ne(n.links),ee(n.total_pages),te(n.total_links),v(n.page),L(n.per_page);const m=new Map;x&&n.links&&n.links.forEach(xe=>m.set(xe.id,{favoriteId:xe.favorite_id})),me(m)}catch(n){const m=((c=(i=n.response)==null?void 0:i.data)==null?void 0:c.msg)||n.message||"Failed to fetch links.";l?(C(m),ne([]),ee(0),te(0)):u(m)}finally{l&&a(!1)}},[h,A,I,_,W,N,P,q,x]);s.useEffect(()=>{const t=setTimeout(()=>ie(U),500);return()=>clearTimeout(t)},[U]),s.useEffect(()=>{const t=setTimeout(()=>oe(F),500);return()=>clearTimeout(t)},[F]),s.useEffect(()=>{x?et().then(d).catch(t=>u("Failed to load software list.")):d([])},[x]),s.useEffect(()=>{x?V(1,!0):(ne([]),a(!1))},[x,h,A,_,W,N,P,q,r,V]),s.useEffect(()=>{ge(new Set)},[h,A,_,W,N,P,q,r,Q]),s.useEffect(()=>{h?we(h).then(f).catch(()=>{u("Failed to load versions for filter."),f([])}):f([])},[h]),s.useEffect(()=>{const t=new URLSearchParams(Be.search),l=t.get("item_id"),i=t.get("comment_id");if(l&&i&&g.length>0){const c=parseInt(l,10);if(!isNaN(c)){const n=g.find(m=>m.id===c);n?((!w||w.id!==n.id)&&fe(n),setTimeout(()=>{var m;(m=ke.current)==null||m.scrollIntoView({behavior:"smooth",block:"center"})},100)):console.warn(`LinksView: Link with item_id ${c} not found in the current list.`)}}},[Be.search,g,w]),s.useEffect(()=>{$?(Oe(!0),we($).then(Ee).catch(()=>u("Failed to load versions for move.")).finally(()=>Oe(!1))):Ee([])},[$]);const at=t=>{Z(t),D(null),v(1)},lt=t=>{D(t.target.value?parseInt(t.target.value):null),v(1)},nt=t=>{v(t),V(t,!0)},it=t=>{Se(t),je(l=>_===t&&l==="asc"?"desc":"asc"),v(1)},ot=()=>{v(1),V(1,!0)},qe=async t=>{if(X(!1),Y(null),await V(1,!0),h)try{const l=await we(h);f(l)}catch(l){console.error("Error refreshing version list after operation:",l),u("Failed to refresh version list for the current software filter.")}},dt=()=>{Y(null),X(!0)},ct=t=>{Y(t),X(!0),window.scrollTo({top:0,behavior:"smooth"})},We=()=>{Y(null),X(!1)},ut=t=>{he(t),k(!0)},_e=()=>{he(null),k(!1)},mt=async()=>{if(S){Ve(!0),w&&w.id===S.id&&fe(null);try{await At(S.id),M(`Link "${S.title}" deleted.`),_e(),V(1,!0)}catch(t){u(t.message||"Delete failed."),_e()}finally{Ve(!1)}}},He=s.useMemo(()=>{if(!r)return g;const t=r.toLowerCase();return g.filter(l=>l.title.toLowerCase().includes(t)||(l.description||"").toLowerCase().includes(t)||(l.software_name||"").toLowerCase().includes(t)||(l.version_name||"").toLowerCase().includes(t))},[g,r]),gt=(t,l)=>ge(i=>{const c=new Set(i);return l?c.add(t):c.delete(t),c}),ft=t=>{const l=new Set;t&&He.forEach(i=>l.add(i.id)),ge(l)},xt=()=>{if(p.size===0){u("No items selected.");return}Ie(!0)},ht=async()=>{Ie(!1),De(!0),w&&p.has(w.id)&&fe(null);try{const t=await Dt(Array.from(p),"link");M(t.msg||`${t.deleted_count} link(s) deleted.`),ge(new Set),V(1,!0)}catch(t){u(t.message||"Bulk delete failed.")}finally{De(!1)}},Xe=s.useMemo(()=>g.filter(t=>p.has(t.id)&&!t.is_external_link&&t.stored_filename).length,[g,p]),pt=async()=>{if(p.size===0){u("No items selected.");return}const t=g.filter(i=>p.has(i.id)&&!i.is_external_link&&i.stored_filename);if(t.length===0){u("No downloadable files among selected links. External links or links without files cannot be bulk downloaded.");return}const l=t.map(i=>i.id);l.length<p.size&&M(`Starting download for ${l.length} file-based links. External links were excluded.`),Ue(!0);try{const i=await Vt(l,"link"),c=URL.createObjectURL(i),n=document.createElement("a");n.href=c;const m=new Date().toISOString().replace(/:/g,"-");n.download=`bulk_download_links_${m}.zip`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(c),l.length===p.size&&M("Download started.")}catch(i){u(i.message||"Bulk download failed.")}finally{Ue(!1)}},bt=()=>{if(p.size===0){u("No items selected.");return}if(K.length===0){u("Software list unavailable.");return}Ne(null),ye(void 0),pe(!0)},yt=async()=>{if(!$){u("Select target software.");return}pe(!1),Pe(!0);const t={target_software_id:$};be!==void 0&&(t.target_version_id=be);try{const l=await Ut(Array.from(p),"link",t);M(l.msg||`${l.moved_count} link(s) moved.`),ge(new Set),V(1,!0)}catch(l){u(l.message||"Bulk move failed.")}finally{Pe(!1),Ne(null),ye(void 0)}},kt=[{key:"title",header:"Title",sortable:!0},{key:"software_name",header:"Software",sortable:!0},{key:"version_name",header:"Version",sortable:!0,render:t=>t.version_name||"N/A"},{key:"description",header:"Description",render:t=>e.jsx("span",{className:"text-sm text-gray-600 block max-w-xs truncate",title:t.description||"",children:t.description||"-"})},{key:"url",header:"Link",render:t=>{var n;const l=t.is_external_link||t.is_downloadable!==!1,i="Link",c=Je;return!l&&!t.is_external_link?e.jsxs("span",{className:"flex items-center text-gray-400 cursor-not-allowed",title:"Download not permitted",children:[e.jsx(c,{size:14,className:"mr-1 flex-shrink-0"}),i]}):e.jsxs("a",{href:t.url,target:t.is_external_link||!((n=t.url)!=null&&n.startsWith("/"))?"_blank":"_self",rel:"noopener noreferrer",className:`flex items-center ${l?"text-blue-600 hover:text-blue-800":"text-gray-400 cursor-not-allowed"}`,onClick:m=>{l||m.preventDefault(),m.stopPropagation()},title:l?t.is_external_link?"Open external link":"Download file":"Download not permitted",children:[e.jsx(c,{size:14,className:"mr-1 flex-shrink-0"}),i]})}},{key:"uploaded_by_username",header:"Added By",sortable:!0,render:t=>t.uploaded_by_username||"N/A"},{key:"updated_by_username",header:"Updated By",sortable:!1,render:t=>t.updated_by_username||"N/A"},{key:"created_at",header:"Created",sortable:!0,render:t=>Ze(t.created_at??"")},{key:"updated_at",header:"Updated",sortable:!0,render:t=>Ze(t.updated_at??"")},{key:"actions",header:"Actions",render:t=>{var l,i,c;return e.jsxs("div",{className:"flex space-x-1 items-center",children:[x&&e.jsx("button",{onClick:n=>{n.stopPropagation(),vt(t,"link")},className:`p-1 rounded-md ${(l=ue.get(t.id))!=null&&l.favoriteId?"text-yellow-500 hover:text-yellow-600":"text-gray-400 hover:text-yellow-500"}`,title:(i=ue.get(t.id))!=null&&i.favoriteId?"Remove Favorite":"Add Favorite",children:e.jsx(Mt,{size:16,className:(c=ue.get(t.id))!=null&&c.favoriteId?"fill-current":""})}),x&&e.jsxs("button",{onClick:n=>{n.stopPropagation(),w&&w.id===t.id?fe(null):(fe(t),setTimeout(()=>{var m;return(m=ke.current)==null?void 0:m.scrollIntoView({behavior:"smooth"})},0))},className:"p-1 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 rounded-md",title:w&&w.id===t.id?"Hide Comments":"View Comments",children:[e.jsx(Xt,{size:16}),e.jsxs("span",{className:"ml-1 text-xs",children:["(",t.comment_count??0,")"]})]}),(o==="admin"||o==="super_admin")&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:n=>{n.stopPropagation(),ct(t)},className:"p-1 text-blue-600 hover:text-blue-800 rounded-md",title:"Edit",children:e.jsx(Yt,{size:16})}),e.jsx("button",{onClick:n=>{n.stopPropagation(),ut(t)},className:"p-1 text-red-600 hover:text-red-800 rounded-md",title:"Delete",children:e.jsx(Ge,{size:16})})]})]})}}],wt=s.useCallback(()=>{V(1,!0)},[V]),vt=async(t,l)=>{var m,xe;if(!x){u("Please log in to manage favorites.");return}const i=ue.get(t.id),c=!!(i!=null&&i.favoriteId),n=new Map(ue);c?n.set(t.id,{favoriteId:void 0}):n.set(t.id,{favoriteId:-1}),me(n);try{if(c&&typeof(i==null?void 0:i.favoriteId)=="number")await Pt(t.id,l),M(`"${t.title}" removed from favorites.`),me(B=>{const ae=new Map(B);return ae.set(t.id,{favoriteId:void 0}),ae});else{const B=await zt(t.id,l);me(ae=>{const le=new Map(ae);return le.set(t.id,{favoriteId:B.id}),le}),M(`"${t.title}" added to favorites.`)}}catch(B){u(((xe=(m=B==null?void 0:B.response)==null?void 0:m.data)==null?void 0:xe.msg)||B.message||"Failed to update favorite."),me(ae=>{const le=new Map(ae);return c?le.set(t.id,{favoriteId:i==null?void 0:i.favoriteId}):le.set(t.id,{favoriteId:void 0}),le})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-start sm:items-center mb-6 flex-col sm:flex-row",children:[e.jsxs("div",{children:[" ",e.jsx("h2",{className:"text-2xl font-bold text-gray-800 dark:text-white",children:"Links"})," ",e.jsx("p",{className:"text-gray-600 mt-1 dark:text-gray-300",children:"Manage and browse useful links and resources."})," "]}),x&&(o==="admin"||o==="super_admin")&&!de&&e.jsxs("button",{onClick:()=>{H?We():dt()},className:"mt-4 sm:mt-0 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx(Tt,{size:18,className:"mr-2"})," ",H?"Cancel":"Add New Link"]})]}),H&&e.jsx("div",{className:"my-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow",children:e.jsx(ts,{linkToEdit:de,onLinkAdded:()=>qe(),onLinkUpdated:()=>qe(),onCancelEdit:We})}),p.size>0&&e.jsx("div",{className:"my-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:[p.size," item(s) selected"]}),(o==="admin"||o==="super_admin")&&e.jsxs("button",{onClick:xt,disabled:Ae,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-800 focus:ring-red-500 disabled:opacity-50",children:[e.jsx(Ge,{size:14,className:"mr-1.5"}),"Delete"]}),x&&e.jsxs("button",{onClick:pt,disabled:rt||Xe===0,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-green-500 hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 focus:ring-green-500 disabled:opacity-50",children:[e.jsx(Je,{size:14,className:"mr-1.5"}),"Download (",Xe,")"]}),(o==="admin"||o==="super_admin")&&e.jsxs("button",{onClick:bt,disabled:re,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 focus:ring-blue-500 disabled:opacity-50",children:[e.jsx(qt,{size:14,className:"mr-1.5"}),"Move"]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:gap-4 -mt-20",children:[K.length>0&&e.jsx("div",{className:"w-fit flex-shrink-0",children:e.jsx(Zt,{software:K,selectedSoftwareId:h,onSelectFilter:at})}),h&&e.jsxs("div",{className:"flex items-center gap-2 min-w-[200px] mt-4 md:mt-0 flex-shrink-0",children:[e.jsx("label",{htmlFor:"versionFilterLinks",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Version"}),e.jsxs("select",{id:"versionFilterLinks",value:A||"",onChange:lt,className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200",disabled:R.length===0,children:[e.jsx("option",{value:"",children:"All Versions"}),R.map(t=>e.jsx("option",{value:t.id,children:t.version_number},t.id))]})]})]}),e.jsx("div",{className:"mb-4 mt-0",children:e.jsxs("button",{onClick:()=>st(t=>!t),className:"flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-md text-sm font-medium",children:[Me?e.jsx(Gt,{size:18,className:"mr-1.5"}):e.jsx(Wt,{size:18,className:"mr-1.5"})," Advanced Filters"]})}),Me&&e.jsxs("div",{className:"my-4 p-4 border dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 space-y-4 md:space-y-0 md:flex md:flex-wrap md:items-end md:gap-4",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{htmlFor:"linkTypeFilterSelect",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Link Type"}),e.jsxs("select",{id:"linkTypeFilterSelect",value:N,onChange:t=>T(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200",children:[e.jsx("option",{value:"",children:"All"})," ",e.jsx("option",{value:"external",children:"External URL"})," ",e.jsx("option",{value:"uploaded",children:"Uploaded File"})]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Created Between"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"date",value:U,onChange:t=>b(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"to"}),e.jsx("input",{type:"date",value:F,onChange:t=>O(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"})]})]}),e.jsxs("div",{className:"flex items-end gap-2 pt-5",children:[e.jsx("button",{onClick:ot,className:"text-sm px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"Apply"}),e.jsx("button",{onClick:Te,className:"text-sm px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500",children:"Clear All"})]})]}),se?e.jsx("div",{className:"py-10",children:e.jsx(Ct,{message:"Loading links..."})}):j&&g.length===0&&!se?e.jsx(Qt,{message:j,onRetry:wt}):!se&&!j&&g.length===0?e.jsxs("div",{className:"text-center py-10 bg-white dark:bg-gray-800 rounded-lg shadow-sm my-6",children:[e.jsx(tt,{size:48,className:"mx-auto text-yellow-500 dark:text-yellow-400 mb-4"}),e.jsx("p",{className:"text-xl font-semibold text-gray-700 dark:text-gray-200 mb-3",children:Fe?"No Links Found Matching Criteria":"No Links Available"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 px-4",children:Fe?"Try adjusting or clearing your search/filter settings.":o==="admin"||o==="super_admin"?"Add new links to get started.":"Please check back later."}),Fe&&e.jsx("button",{onClick:Te,className:"mt-6 btn-primary text-sm",children:"Clear All Filters & Search"})]}):e.jsx(Jt,{columns:kt,data:He,rowClassName:"group",isLoading:se||Ce,currentPage:Q,totalPages:ve,onPageChange:nt,itemsPerPage:I,totalItems:z,sortColumn:_,sortOrder:W,onSort:it,isSelectionEnabled:!0,selectedItemIds:p,onSelectItem:gt,onSelectAllItems:ft}),ce&&S&&e.jsx(Ke,{isOpen:ce,title:"Delete Link",message:`Delete "${S.title}"?`,onConfirm:mt,onCancel:_e,isConfirming:Ce,confirmButtonText:"Delete",confirmButtonVariant:"danger"}),Re&&e.jsx(Ke,{isOpen:Re,title:`Delete ${p.size} Link(s)`,message:`Delete ${p.size} selected items?`,onConfirm:ht,onCancel:()=>Ie(!1),isConfirming:Ae,confirmButtonText:"Delete Selected",confirmButtonVariant:"danger"}),ze&&e.jsx(Kt,{isOpen:ze,onClose:()=>pe(!1),title:`Move ${p.size} Link(s)`,children:e.jsxs("div",{className:"p-4",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mb-2",children:"Select target Software and optionally a Version:"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"modalSoftwareMoveLinks",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Target Software*"}),e.jsxs("select",{id:"modalSoftwareMoveLinks",value:$??"",onChange:t=>{Ne(t.target.value?parseInt(t.target.value):null),ye(void 0)},className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white",disabled:re||K.length===0,children:[e.jsx("option",{value:"",children:"Select Software..."}),K.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),$&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"modalVersionMoveLinks",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Target Version (Optional)"}),e.jsxs("select",{id:"modalVersionMoveLinks",value:be===null?"NULL_VERSION":be??"",onChange:t=>ye(t.target.value==="NULL_VERSION"?null:t.target.value?parseInt(t.target.value):void 0),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white",disabled:re||Le,children:[e.jsx("option",{value:"",children:Le?"Loading...":"Select Version (Optional)..."}),e.jsx("option",{value:"NULL_VERSION",children:"No Specific Version (Clear Association)"}),$e.map(t=>e.jsx("option",{value:t.id,children:t.version_number},t.id))]}),$e.length===0&&!Le&&$&&e.jsx("p",{className:"text-xs text-yellow-600 mt-1",children:"No versions for selected software. You can still move to the software without a specific version."})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[e.jsx("button",{type:"button",onClick:()=>pe(!1),className:"px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500",disabled:re,children:"Cancel"}),e.jsx("button",{type:"button",onClick:yt,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",disabled:re||!$,children:re?"Moving...":"Confirm Move"})]})]})}),x&&w&&e.jsxs("div",{ref:ke,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("h3",{className:"text-xl font-semibold text-gray-800 dark:text-white mb-4",children:["Comments for: ",e.jsx("span",{className:"font-bold text-blue-600 dark:text-blue-400",children:w.title})]}),e.jsx(Ht,{itemId:w.id,itemType:"link"})]}),!x&&w&&e.jsx("div",{ref:ke,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 text-center",children:e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Please log in to view and manage comments."})})]})};export{os as default};
