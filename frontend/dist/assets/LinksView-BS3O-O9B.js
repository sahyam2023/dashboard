import{r,u as et,f as tt,s as u,v as ve,j as e,L as st,F as Xe,X as wt,E as St,a as C,G as jt,H as Nt,d as Vt,g as It,h as _t,I as Lt,D as Ye,k as Ft,l as Ke,C as Qe,m as Ct,S as Mt,M as At,J as Dt,o as Ut,p as Pt,q as Ot,t as $t}from"./index-BZXbcIcx.js";import{u as Et,d as zt,U as Rt,o as Bt,c as Tt,e as qt,a as G,b as Wt,T as Ze,M as Ht,F as Jt,C as Gt,P as Xt}from"./CommentSection-DBIZEyD2.js";import{C as Yt,D as Kt}from"./DataTable-CNlbx_sS.js";import{F as Qt}from"./FilterTabs-Bop7mo3K.js";import{E as Zt}from"./ErrorState-ByHzLdsB.js";import{M as es}from"./Modal-xjbwiuon.js";import{P as ts}from"./plus-circle-BYKi9Z8A.js";const ie="CREATE_NEW_VERSION_SENTINEL_VALUE",ss=Tt().shape({selectedSoftwareId:G().required("Software Product must be selected."),title:G().required("Link Title is required.").max(255,"Title cannot exceed 255 characters."),selectedVersionId:G().required("Version must be selected or a new one entered."),typedVersionString:G().when("selectedVersionId",{is:ie,then:a=>a.required('New Version String is required when "Enter New Version" is selected.').min(1,"New Version String cannot be empty."),otherwise:a=>a.transform(v=>v===""?void 0:v).optional().nullable()}),inputMode:G().oneOf(["url","upload"]).required("Input mode must be selected."),externalUrl:G().when("inputMode",{is:"url",then:a=>a.required("External URL is required for URL mode.").url("Please enter a valid URL (e.g., http://example.com)."),otherwise:a=>a.optional().nullable()}),selectedFile:Wt().when(["inputMode","$isEditMode","$isOriginallyFileBased"],{is:(a,v,h)=>!!(a==="upload"&&!v||a==="upload"&&v&&!h),then:a=>a.required("A file is required for this operation.").test("filePresent","A file is required.",v=>!!v),otherwise:a=>a.nullable()}),description:G().optional().max(1e3,"Description cannot exceed 1000 characters."),compatibleVmsVersionIds:qt().of(G().required()).optional()}),rs=({linkToEdit:a,onLinkAdded:v,onLinkUpdated:h,onCancelEdit:q})=>{const c=!!a,{register:p,handleSubmit:xe,control:X,formState:{errors:m},watch:W,setValue:b,reset:y}=Et({resolver:Bt(ss),context:{isEditMode:c,isOriginallyFileBased:!!(c&&a&&!a.is_external_link)},defaultValues:{selectedSoftwareId:"",title:"",selectedVersionId:"",typedVersionString:"",inputMode:"url",externalUrl:"",selectedFile:null,description:"",compatibleVmsVersionIds:[]}}),[V,E]=r.useState([]),[z,_]=r.useState([]),[he,M]=r.useState([]),[Y,A]=r.useState(!1),[K,H]=r.useState(null),[w,R]=r.useState(!1),[Q,Z]=r.useState(!1),[D,le]=r.useState(!1),[pe,we]=r.useState(0),[be,ee]=r.useState(!1),{isAuthenticated:oe,user:U}=et(),te=U==null?void 0:U.role,I=r.useRef(null),j=W("selectedSoftwareId"),ne=W("selectedVersionId"),se=W("inputMode"),L=W("selectedFile"),de=ne===ie;r.useEffect(()=>{const s=d=>{be&&(d.preventDefault(),d.returnValue="")};return window.addEventListener("beforeunload",s),()=>{window.removeEventListener("beforeunload",s)}},[be]),r.useEffect(()=>{oe&&(te==="admin"||te==="super_admin")&&(Z(!0),tt().then(E).catch(()=>u("Failed to load software list.")).finally(()=>Z(!1)))},[oe,te]),r.useEffect(()=>{if(j&&V.length>0){Z(!0),_([]),b("selectedVersionId",""),b("typedVersionString","");const s=V.find(d=>d.id.toString()===j);if(s&&(s.name==="VMS"||s.name==="VA")){A(!0);const d=V.find(g=>g.name==="VMS");d?(le(!0),ve(d.id).then(M).catch(()=>u("Failed to load VMS versions for compatibility.")).finally(()=>le(!1))):M([])}else A(!1),M([]);ve(parseInt(j)).then(_).catch(()=>u("Failed to load versions for selected software.")).finally(()=>Z(!1))}else _([]),A(!1),M([]),b("selectedVersionId",""),b("typedVersionString","")},[j,b,V]),r.useEffect(()=>{if(c&&a&&V.length>0){const s=V.find(k=>k.id===a.software_id),d=!!s&&(s.name==="VMS"||s.name==="VA");A(d);const g={selectedSoftwareId:j&&j!==a.software_id.toString()?j:a.software_id.toString(),title:a.title,description:a.description||"",inputMode:a.is_external_link?"url":"upload",externalUrl:a.is_external_link?a.url:"",compatibleVmsVersionIds:d&&a.compatible_vms_versions?typeof a.compatible_vms_versions=="string"?a.compatible_vms_versions.split(",").map(k=>k.trim()).filter(k=>k):Array.isArray(a.compatible_vms_versions)?a.compatible_vms_versions.map(String):[]:[]};j===a.software_id.toString()&&(a.version_id&&z.length>0?z.find(P=>P.id===a.version_id)?g.selectedVersionId=a.version_id.toString():(g.selectedVersionId=ie,g.typedVersionString=a.version_name):a.version_name&&(g.selectedVersionId=ie,g.typedVersionString=a.version_name)),y(g),a.is_external_link?H(null):H(a.original_filename_ref||a.url.split("/").pop()||"unknown_file"),b("selectedFile",null),I.current&&(I.current.value="")}else c||re(!!j)},[c,a,y,b,z,j,V]);const re=(s=!1)=>{const d=s?W("selectedSoftwareId"):"";y({selectedSoftwareId:d,title:"",selectedVersionId:"",typedVersionString:"",inputMode:"url",externalUrl:"",selectedFile:null,description:"",compatibleVmsVersionIds:[]}),H(null),I.current&&(I.current.value="")},ce=s=>{s.target.files&&s.target.files[0]?b("selectedFile",s.target.files[0],{shouldValidate:!0,shouldDirty:!0}):b("selectedFile",null,{shouldValidate:!0,shouldDirty:!0})},Se=()=>{b("selectedFile",null,{shouldValidate:!0,shouldDirty:!0}),I.current&&(I.current.value="")},me=async s=>{var P,F,O,ae,Ne;R(!0),s.inputMode==="upload"&&s.selectedFile&&ee(!0),we(0);let d,g;s.selectedVersionId===ie&&s.typedVersionString?g=s.typedVersionString.trim():s.selectedVersionId&&s.selectedVersionId!==ie&&(d=parseInt(s.selectedVersionId));const k={software_id:parseInt(s.selectedSoftwareId),title:s.title.trim(),description:((P=s.description)==null?void 0:P.trim())||void 0};d&&(k.version_id=d),g&&(k.typed_version_string=g),Y&&s.compatibleVmsVersionIds&&s.compatibleVmsVersionIds.length>0&&(k.compatible_vms_version_ids=s.compatibleVmsVersionIds);try{let n;if(s.inputMode==="url"){const S={...k,url:s.externalUrl.trim(),is_external_link:!0};c&&a?(n=await St(a.id,S),C(`Link "${n.title}" updated successfully!`),h&&h(n)):(n=await jt(S),C(`Link "${n.title}" added successfully!`),v&&v(n),c||(re(!0),b("selectedVersionId",""),b("typedVersionString","")))}else{const S={software_id:parseInt(s.selectedSoftwareId),title:s.title.trim(),description:((F=s.description)==null?void 0:F.trim())||void 0,version_id:d,typed_version_string:g,compatible_vms_version_ids:Y&&s.compatibleVmsVersionIds&&s.compatibleVmsVersionIds.length>0?s.compatibleVmsVersionIds:void 0};if(c&&a)if(!a.is_external_link||a.is_external_link&&s.selectedFile)n=await Nt(a.id,S,s.selectedFile||null),C(`Link "${n.title}" updated successfully!`),h&&h(n);else{u("If switching from a URL to an uploaded file, please select a file."),R(!1),ee(!1);return}else if(s.selectedFile){const B={software_id:s.selectedSoftwareId,...d&&{version_id:d.toString()},...g&&{typed_version_string:g},title:s.title.trim(),description:((O=s.description)==null?void 0:O.trim())||"",...Y&&s.compatibleVmsVersionIds&&s.compatibleVmsVersionIds.length>0&&{compatible_vms_version_ids_json:JSON.stringify(s.compatibleVmsVersionIds)}};n=await Vt(s.selectedFile,"link_file",B,Ve=>we(Ve)),C(`Link file "${n.title}" added successfully via chunked upload!`),v&&v(n),re(!0),b("selectedVersionId",""),b("typedVersionString","")}else{u("No file selected for upload. Please select a file."),R(!1),ee(!1);return}}}catch(n){const S=((Ne=(ae=n.response)==null?void 0:ae.data)==null?void 0:Ne.msg)||n.message;let B=`Failed to ${c?"update":"add"} link.`;S&&typeof S=="string"&&S.includes("UNIQUE constraint failed")?c?B="A link with this title already exists for this software/version. Please use a different title or check for duplicates.":B="A link with this title already exists for this software/version. Please use a different title.":S&&(B=S),u(B),s.inputMode==="upload"&&ee(!1)}finally{R(!1),s.inputMode==="upload"&&ee(!1)}},je=s=>{console.error("Form validation errors:",s),u("Please correct the errors highlighted in the form.")};return!oe||!te||!["admin","super_admin"].includes(te)?null:e.jsxs("form",{onSubmit:xe(me,je),className:"space-y-6 bg-white dark:bg-gray-800 dark:border-gray-700 p-6 rounded-lg shadow-md border border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-xl font-semibold text-gray-800 dark:text-gray-100",children:[" ",c?"Edit Link":"Add New Link"," "]}),c&&q&&e.jsx("button",{type:"button",onClick:q,className:"text-sm text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200",children:" Cancel "})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedSoftwareId",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Software Product*"}),Q&&!V.length?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading software..."}):e.jsxs("select",{id:"selectedSoftwareId",...p("selectedSoftwareId"),disabled:w||Q&&!V.length,className:`mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${m.selectedSoftwareId?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",disabled:!0,children:"Select Software Product"}),V.map(s=>e.jsx("option",{value:s.id.toString(),children:s.name},s.id))]}),m.selectedSoftwareId&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:m.selectedSoftwareId.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedVersionId",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Version*"}),e.jsx("div",{className:"mt-1",children:e.jsxs("select",{id:"selectedVersionId",...p("selectedVersionId"),disabled:w||Q||!j,className:`block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${m.selectedVersionId?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",disabled:z.length>0&&!!j,children:Q&&j?"Loading versions...":"Select Existing Version"}),z.map(s=>e.jsx("option",{value:s.id.toString(),children:s.version_number},s.id)),e.jsx("option",{value:ie,children:"Enter New Version String..."})]})}),de&&e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{htmlFor:"typedVersionString",className:"block text-xs font-medium text-gray-600 dark:text-gray-400",children:"New Version String*:"}),e.jsx("input",{type:"text",id:"typedVersionString",...p("typedVersionString"),placeholder:"e.g., 1.2.4-final",className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${m.typedVersionString?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"This version will be created for the selected software if it doesn't exist."})]}),m.selectedVersionId&&!de&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:m.selectedVersionId.message}),m.typedVersionString&&de&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:m.typedVersionString.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"title",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Link Title*"}),e.jsx("input",{type:"text",id:"title",...p("title"),disabled:w,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${m.title?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),m.title&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:m.title.message})]}),Y&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"compatibleVmsVersionIds",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Compatible VMS Versions (for VMS/VA Links)"}),D?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading VMS versions..."}):e.jsx(zt,{name:"compatibleVmsVersionIds",control:X,defaultValue:[],render:({field:s})=>e.jsx("div",{className:"mt-1 block w-full max-h-40 overflow-y-auto p-2 border border-gray-300 rounded-md bg-white dark:bg-gray-700 dark:border-gray-600",children:he.length===0?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"No VMS versions available."}):he.map(d=>{var g;return e.jsxs("label",{className:"flex items-center space-x-2 p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded",children:[e.jsx("input",{type:"checkbox",className:"form-checkbox h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-900 dark:checked:bg-blue-500",value:d.id.toString(),checked:((g=s.value)==null?void 0:g.includes(d.id.toString()))||!1,onChange:k=>{const P=k.target.value,F=s.value||[],O=k.target.checked?[...F,P]:F.filter(ae=>ae!==P);s.onChange(O)},disabled:w||D}),e.jsx("span",{className:"text-sm font-medium text-gray-800 dark:text-gray-200",children:d.version_number})]},d.id)})})}),m.compatibleVmsVersionIds&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:m.compatibleVmsVersionIds.message}),e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"Select VMS versions this link is compatible with. Only applicable if the link is for 'VMS' or 'VA' software."})]}),e.jsxs("div",{className:"my-4",children:[e.jsx("span",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Link Source:"}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",...p("inputMode"),value:"url",className:"form-radio h-4 w-4 text-blue-600",disabled:w}),e.jsxs("span",{className:"flex items-center dark:text-gray-300",children:[e.jsx(st,{size:16,className:"mr-1 text-gray-600 dark:text-gray-400"}),"Provide External URL"]})]}),e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",...p("inputMode"),value:"upload",className:"form-radio h-4 w-4 text-blue-600",disabled:w}),e.jsxs("span",{className:"flex items-center dark:text-gray-300",children:[e.jsx(Rt,{size:16,className:"mr-1 text-gray-600 dark:text-gray-400"}),"Upload File for this Link"]})]})]}),m.inputMode&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:m.inputMode.message})]}),se==="url"&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"externalUrl",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Link URL*"}),e.jsx("input",{type:"url",id:"externalUrl",...p("externalUrl"),placeholder:"https://example.com/resource",disabled:w,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${m.externalUrl?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),m.externalUrl&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:m.externalUrl.message})]}),se==="upload"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:c&&K&&!L?"Replace File (Optional)":"Select File to Upload*"}),e.jsx("div",{className:"mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-blue-500 dark:border-gray-600 dark:hover:border-blue-400 transition-colors",children:e.jsxs("div",{className:"space-y-1 text-center",children:[e.jsx(Xe,{className:"mx-auto h-12 w-12 text-gray-400 dark:text-gray-500"}),e.jsxs("div",{className:"flex text-sm text-gray-600 dark:text-gray-400",children:[e.jsxs("label",{htmlFor:"link-file-upload-input",className:"relative cursor-pointer bg-white dark:bg-gray-800 rounded-md font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500",children:[e.jsx("span",{children:L?"Change file":"Upload a file"}),e.jsx("input",{id:"link-file-upload-input",name:"file-input-element",type:"file",className:"sr-only",onChange:ce,ref:I,disabled:w})]}),e.jsx("p",{className:"pl-1",children:"or drag and drop"})]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Any file type relevant for links."})]})}),(L||c&&K)&&e.jsxs("div",{className:"mt-3 flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md",children:[e.jsxs("div",{className:"flex items-center space-x-2 overflow-hidden",children:[e.jsx(Xe,{size:18,className:"text-gray-500 dark:text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:L?L.name:K}),c&&K&&!L&&e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 ml-2",children:"(current)"})]}),L&&e.jsx("button",{type:"button",onClick:Se,disabled:w,className:"p-1 rounded-full text-gray-400 hover:text-gray-600 hover:bg-gray-200 dark:text-gray-500 dark:hover:text-gray-300 dark:hover:bg-gray-600",children:e.jsx(wt,{size:16})})]}),m.selectedFile&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:m.selectedFile.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Description"}),e.jsx("textarea",{id:"description",rows:3,...p("description"),disabled:w,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${m.description?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),m.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:m.description.message})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{type:"submit",disabled:w||Q,className:"flex-1 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",children:w?c?"Updating...":"Adding...":c?"Update Link":"Add Link"}),c&&q&&e.jsx("button",{type:"button",onClick:q,disabled:w,className:"flex-1 inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 dark:border-gray-500 dark:text-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600",children:"Cancel"})]}),w&&se==="upload"&&pe>0&&e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 my-3 relative",children:[e.jsx("div",{className:"bg-blue-600 h-4 rounded-full transition-all duration-150 ease-out",style:{width:`${pe}%`}}),e.jsxs("p",{className:"absolute inset-0 text-center text-xs font-medium leading-4 text-white dark:text-gray-100",children:[Math.round(pe),"%"]})]})]})},ms=()=>{const{searchTerm:a,setSearchTerm:v}=It(),{isAuthenticated:h,user:q}=et(),c=q==null?void 0:q.role,[p,xe]=r.useState([]),[X,m]=r.useState([]),[W,b]=r.useState([]),[y,V]=r.useState(null),[E,z]=r.useState(null),[_,he]=r.useState(""),[M,Y]=r.useState(""),[A,K]=r.useState(""),[H,w]=r.useState(""),[R,Q]=r.useState(""),[Z,D]=r.useState(1),[le,pe]=r.useState(15),[we,be]=r.useState(0),[ee,oe]=r.useState(0),[U,te]=r.useState("title"),[I,j]=r.useState("asc"),[ne,se]=r.useState(!0),[L,de]=r.useState(null),[re,ce]=r.useState(!1),[Se,me]=r.useState(null),[je,s]=r.useState(!1),[d,g]=r.useState(null),[k,P]=r.useState(!1),[F,O]=r.useState(new Map),[ae,Ne]=r.useState(!1),[n,S]=r.useState(new Set),[B,Ve]=r.useState(!1),[rt,Pe]=r.useState(!1),[ue,Oe]=r.useState(!1),[$e,Ie]=r.useState(!1),[T,Ce]=r.useState(null),[Ee,ze]=r.useState([]),[_e,Le]=r.useState(void 0),[Re,Me]=r.useState(!1),[Ae,Be]=r.useState(!1),[N,ye]=r.useState(null),Fe=r.useRef(null),Te=_t(),De=r.useMemo(()=>y!==null||E!==null||_!==""||M!==""||A!==""||a!=="",[y,E,_,M,A,a]),qe=r.useCallback(()=>{V(null),z(null),he(""),Y(""),K(""),v&&v(""),D(1)},[v]),$=r.useCallback(async(t,i=!1)=>{var l,f;i&&se(!0),de(null);try{const o=await Lt(y||void 0,E||void 0,t,le,U,I,_||void 0,H||void 0,R||void 0,a);xe(o.links),be(o.total_pages),oe(o.total_links),D(o.page),pe(o.per_page);const x=new Map;h&&o.links&&o.links.forEach(ke=>x.set(ke.id,{favoriteId:ke.favorite_id})),O(x)}catch(o){const x=((f=(l=o.response)==null?void 0:l.data)==null?void 0:f.msg)||o.message||"Failed to fetch links.";i?(de(x),xe([]),be(0),oe(0)):u(x)}finally{i&&se(!1)}},[y,E,le,U,I,_,H,R,h,a]);r.useEffect(()=>{const t=setTimeout(()=>w(M),500);return()=>clearTimeout(t)},[M]),r.useEffect(()=>{const t=setTimeout(()=>Q(A),500);return()=>clearTimeout(t)},[A]),r.useEffect(()=>{h?tt().then(m).catch(t=>u("Failed to load software list.")):m([])},[h]),r.useEffect(()=>{h?$(1,!0):(xe([]),se(!1))},[h,y,E,U,I,_,H,R,a,$]),r.useEffect(()=>{S(new Set)},[y,E,U,I,_,H,R,a,Z]),r.useEffect(()=>{y?ve(y).then(b).catch(()=>{u("Failed to load versions for filter."),b([])}):b([])},[y]),r.useEffect(()=>{const t=new URLSearchParams(Te.search),i=t.get("item_id"),l=t.get("comment_id");if(i&&l&&p.length>0){const f=parseInt(i,10);if(!isNaN(f)){const o=p.find(x=>x.id===f);o?((!N||N.id!==o.id)&&ye(o),setTimeout(()=>{var x;(x=Fe.current)==null||x.scrollIntoView({behavior:"smooth",block:"center"})},100)):console.warn(`LinksView: Link with item_id ${f} not found in the current list.`)}}},[Te.search,p,N]),r.useEffect(()=>{T?(Be(!0),ve(T).then(ze).catch(()=>u("Failed to load versions for move.")).finally(()=>Be(!1))):ze([])},[T]);const at=t=>{V(t),z(null),D(1)},it=t=>{z(t.target.value?parseInt(t.target.value):null),D(1)},lt=t=>{D(t),$(t,!0)},ot=t=>{te(t),j(i=>U===t&&i==="asc"?"desc":"asc"),D(1)},nt=()=>{D(1),$(1,!0)},We=async t=>{if(ce(!1),me(null),await $(1,!0),y)try{const i=await ve(y);b(i)}catch(i){console.error("Error refreshing version list after operation:",i),u("Failed to refresh version list for the current software filter.")}},dt=()=>{me(null),ce(!0)},ct=t=>{me(t),ce(!0),window.scrollTo({top:0,behavior:"smooth"})},He=()=>{me(null),ce(!1)},mt=t=>{g(t),s(!0)},Ue=()=>{g(null),s(!1)},ut=async()=>{if(d){P(!0),N&&N.id===d.id&&ye(null);try{await Dt(d.id),C(`Link "${d.title}" deleted.`),Ue(),$(1,!0)}catch(t){u(t.message||"Delete failed."),Ue()}finally{P(!1)}}},ft=(t,i)=>S(l=>{const f=new Set(l);return i?f.add(t):f.delete(t),f}),gt=t=>{const i=new Set;t&&p.forEach(l=>i.add(l.id)),S(i)},xt=()=>{if(n.size===0){u("No items selected.");return}Me(!0)},ht=async()=>{Me(!1),Ve(!0),N&&n.has(N.id)&&ye(null);try{const t=await Ut(Array.from(n),"link");C(t.msg||`${t.deleted_count} link(s) deleted.`),S(new Set),$(1,!0)}catch(t){u(t.message||"Bulk delete failed.")}finally{Ve(!1)}},Je=r.useMemo(()=>p.filter(t=>n.has(t.id)&&!t.is_external_link&&t.stored_filename).length,[p,n]),pt=async()=>{if(n.size===0){u("No items selected.");return}const t=p.filter(l=>n.has(l.id)&&!l.is_external_link&&l.stored_filename);if(t.length===0){u("No downloadable files among selected links. External links or links without files cannot be bulk downloaded.");return}const i=t.map(l=>l.id);i.length<n.size&&C(`Starting download for ${i.length} file-based links. External links were excluded.`),Pe(!0);try{const l=await Ct(i,"link"),f=URL.createObjectURL(l),o=document.createElement("a");o.href=f;const x=new Date().toISOString().replace(/:/g,"-");o.download=`bulk_download_links_${x}.zip`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(f),i.length===n.size&&C("Download started.")}catch(l){u(l.message||"Bulk download failed.")}finally{Pe(!1)}},bt=()=>{if(n.size===0){u("No items selected.");return}if(X.length===0){u("Software list unavailable.");return}Ce(null),Le(void 0),Ie(!0)},yt=async()=>{if(!T){u("Select target software.");return}Ie(!1),Oe(!0);const t={target_software_id:T};_e!==void 0&&(t.target_version_id=_e);try{const i=await Pt(Array.from(n),"link",t);C(i.msg||`${i.moved_count} link(s) moved.`),S(new Set),$(1,!0)}catch(i){let l="Bulk move failed.";i.message&&typeof i.message=="string"&&i.message.includes("UNIQUE constraint failed")?l="A link with this title already exists for the target software/version. Please check for duplicates.":i.message&&(l=i.message),u(l)}finally{Oe(!1),Ce(null),Le(void 0)}},kt=[{key:"title",header:"Title",sortable:!0},{key:"software_name",header:"Software",sortable:!0},{key:"version_name",header:"Version",sortable:!0,render:t=>t.version_name||"N/A"},{key:"compatible_vms_versions",header:"VMS Compatibility",sortable:!0,render:t=>{const i=t.software_name==="VMS"||t.software_name==="VA";let l="-";return i&&(t.compatible_vms_versions&&t.compatible_vms_versions.length>0?Array.isArray(t.compatible_vms_versions)?l=t.compatible_vms_versions.join(", "):typeof t.compatible_vms_versions=="string"?l=t.compatible_vms_versions:l="N/A":l="N/A"),e.jsx("div",{className:"text-center",children:l})}},{key:"description",header:"Description",render:t=>e.jsx("span",{className:"text-sm text-gray-600 block max-w-xs truncate",title:t.description||"",children:t.description||"-"})},{key:"url",header:"Link",render:t=>{var o;const i=t.is_external_link||t.is_downloadable!==!1,l="Link",f=Ye;return!i&&!t.is_external_link?e.jsxs("span",{className:"flex items-center text-gray-400 cursor-not-allowed",title:"Download not permitted",children:[e.jsx(f,{size:14,className:"mr-1 flex-shrink-0"}),l]}):e.jsxs("a",{href:t.url,target:t.is_external_link||!((o=t.url)!=null&&o.startsWith("/"))?"_blank":"_self",rel:"noopener noreferrer",className:`flex items-center ${i?"text-blue-600 hover:text-blue-800":"text-gray-400 cursor-not-allowed"}`,onClick:x=>{i||x.preventDefault(),x.stopPropagation()},title:i?t.is_external_link?"Open external link":"Download file":"Download not permitted",children:[e.jsx(f,{size:14,className:"mr-1 flex-shrink-0"}),l]})}},{key:"uploaded_by_username",header:"Added By",sortable:!0,render:t=>t.uploaded_by_username||"N/A"},{key:"updated_by_username",header:"Updated By",sortable:!1,render:t=>t.updated_by_username||"N/A"},{key:"created_at",header:"Created",sortable:!0,render:t=>Ke(t.created_at??"")},{key:"updated_at",header:"Updated",sortable:!0,render:t=>Ke(t.updated_at??"")},{key:"actions",header:"Actions",render:t=>{var i,l,f;return e.jsxs("div",{className:"flex space-x-1 items-center",children:[h&&e.jsx("button",{onClick:o=>{o.stopPropagation(),vt(t,"link")},className:`p-1 rounded-md ${(i=F.get(t.id))!=null&&i.favoriteId?"text-yellow-500 hover:text-yellow-600":"text-gray-400 hover:text-yellow-500"}`,title:(l=F.get(t.id))!=null&&l.favoriteId?"Remove Favorite":"Add Favorite",children:e.jsx(Mt,{size:16,className:(f=F.get(t.id))!=null&&f.favoriteId?"fill-current":""})}),h&&e.jsxs("button",{onClick:o=>{o.stopPropagation(),N&&N.id===t.id?ye(null):(ye(t),setTimeout(()=>{var x;return(x=Fe.current)==null?void 0:x.scrollIntoView({behavior:"smooth"})},0))},className:"p-1 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 rounded-md",title:N&&N.id===t.id?"Hide Comments":"View Comments",children:[e.jsx(At,{size:16}),e.jsxs("span",{className:"ml-1 text-xs",children:["(",t.comment_count??0,")"]})]}),(c==="admin"||c==="super_admin")&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:o=>{o.stopPropagation(),ct(t)},className:"p-1 text-blue-600 hover:text-blue-800 rounded-md",title:"Edit",children:e.jsx(Xt,{size:16})}),e.jsx("button",{onClick:o=>{o.stopPropagation(),mt(t)},className:"p-1 text-red-600 hover:text-red-800 rounded-md",title:"Delete",children:e.jsx(Ze,{size:16})})]})]})}}],Ge=r.useCallback(()=>{$(1,!0)},[$]),vt=async(t,i)=>{var x,ke;if(!h){u("Please log in to manage favorites.");return}const l=F.get(t.id),f=!!(l!=null&&l.favoriteId),o=new Map(F);f?o.set(t.id,{favoriteId:void 0}):o.set(t.id,{favoriteId:-1}),O(o);try{if(f&&typeof(l==null?void 0:l.favoriteId)=="number")await Ot(t.id,i),C(`"${t.title}" removed from favorites.`),O(J=>{const fe=new Map(J);return fe.set(t.id,{favoriteId:void 0}),fe});else{const J=await $t(t.id,i);O(fe=>{const ge=new Map(fe);return ge.set(t.id,{favoriteId:J.id}),ge}),C(`"${t.title}" added to favorites.`)}}catch(J){u(((ke=(x=J==null?void 0:J.response)==null?void 0:x.data)==null?void 0:ke.msg)||J.message||"Failed to update favorite."),O(fe=>{const ge=new Map(fe);return f?ge.set(t.id,{favoriteId:l==null?void 0:l.favoriteId}):ge.set(t.id,{favoriteId:void 0}),ge})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-start sm:items-center mb-6 flex-col sm:flex-row",children:[e.jsxs("div",{children:[" ",e.jsx("h2",{className:"text-2xl font-bold text-gray-800 dark:text-white",children:"Links"})," ",e.jsx("p",{className:"text-gray-600 mt-1 dark:text-gray-300",children:"Manage and browse useful links and resources."})," "]}),h&&(c==="admin"||c==="super_admin")&&!Se&&e.jsxs("button",{onClick:()=>{re?He():dt()},className:"mt-4 sm:mt-0 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx(ts,{size:18,className:"mr-2"})," ",re?"Cancel":"Add New Link"]})]}),re&&e.jsx("div",{className:"my-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow",children:e.jsx(rs,{linkToEdit:Se,onLinkAdded:()=>We(),onLinkUpdated:()=>We(),onCancelEdit:He})}),n.size>0&&e.jsx("div",{className:"my-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:[n.size," item(s) selected"]}),(c==="admin"||c==="super_admin")&&e.jsxs("button",{onClick:xt,disabled:B,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-800 focus:ring-red-500 disabled:opacity-50",children:[e.jsx(Ze,{size:14,className:"mr-1.5"}),"Delete"]}),h&&e.jsxs("button",{onClick:pt,disabled:rt||Je===0,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-green-500 hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 focus:ring-green-500 disabled:opacity-50",children:[e.jsx(Ye,{size:14,className:"mr-1.5"}),"Download (",Je,")"]}),(c==="admin"||c==="super_admin")&&e.jsxs("button",{onClick:bt,disabled:ue,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 focus:ring-blue-500 disabled:opacity-50",children:[e.jsx(Ht,{size:14,className:"mr-1.5"}),"Move"]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:gap-4 -mt-20",children:[X.length>0&&e.jsx("div",{className:"w-fit flex-shrink-0",children:e.jsx(Qt,{software:X,selectedSoftwareId:y,onSelectFilter:at})}),y&&e.jsx("div",{className:"flex items-center gap-2 min-w-[200px] mt-4 md:mt-0 flex-shrink-0",children:e.jsxs("select",{id:"versionFilterLinks",value:E||"",onChange:it,className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200",disabled:W.length===0,children:[e.jsx("option",{value:"",children:"Version"}),W.map(t=>e.jsx("option",{value:t.id,children:t.version_number},t.id))]})})]}),e.jsx("div",{className:"mb-4 mt-0",children:e.jsxs("button",{onClick:()=>Ne(t=>!t),className:"flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-md text-sm font-medium",children:[ae?e.jsx(Yt,{size:18,className:"mr-1.5"}):e.jsx(Jt,{size:18,className:"mr-1.5"})," Advanced Filters"]})}),ae&&e.jsxs("div",{className:"my-4 p-4 border dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 space-y-4 md:space-y-0 md:flex md:flex-wrap md:items-end md:gap-4",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{htmlFor:"linkTypeFilterSelect",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Link Type"}),e.jsxs("select",{id:"linkTypeFilterSelect",value:_,onChange:t=>he(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200",children:[e.jsx("option",{value:"",children:"All"})," ",e.jsx("option",{value:"external",children:"External URL"})," ",e.jsx("option",{value:"uploaded",children:"Uploaded File"})]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Created Between"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"date",value:M,onChange:t=>Y(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"to"}),e.jsx("input",{type:"date",value:A,onChange:t=>K(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"})]})]}),e.jsxs("div",{className:"flex items-end gap-2 pt-5",children:[e.jsx("button",{onClick:nt,className:"text-sm px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"Apply"}),e.jsx("button",{onClick:qe,className:"text-sm px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500",children:"Clear All"})]})]}),ne?e.jsx("div",{className:"py-10",children:e.jsx(Ft,{message:"Loading links..."})}):L&&p.length===0&&!ne?e.jsx(Zt,{message:L,onRetry:Ge}):!ne&&!L&&p.length===0?e.jsxs("div",{className:"text-center py-10 bg-white dark:bg-gray-800 rounded-lg shadow-sm my-6",children:[e.jsx(st,{size:48,className:"mx-auto text-yellow-500 dark:text-yellow-400 mb-4"}),e.jsx("p",{className:"text-xl font-semibold text-gray-700 dark:text-gray-200 mb-3",children:De?"No Links Found Matching Criteria":"No Links Available"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 px-4",children:De?"Try adjusting or clearing your search/filter settings.":c==="admin"||c==="super_admin"?"Add new links to get started.":"Please check back later."}),De&&e.jsx("button",{onClick:qe,className:"mt-6 btn-primary text-sm",children:"Clear All Filters & Search"})]}):e.jsx(Kt,{columns:kt,data:p,rowClassName:"group",isLoading:ne||k,currentPage:Z,totalPages:we,onPageChange:lt,itemsPerPage:le,totalItems:ee,sortColumn:U,sortOrder:I,onSort:ot,isSelectionEnabled:!0,selectedItemIds:n,onSelectItem:ft,onSelectAllItems:gt}),je&&d&&e.jsx(Qe,{isOpen:je,title:"Delete Link",message:`Delete "${d.title}"?`,onConfirm:ut,onCancel:Ue,isConfirming:k,confirmButtonText:"Delete",confirmButtonVariant:"danger"}),Re&&e.jsx(Qe,{isOpen:Re,title:`Delete ${n.size} Link(s)`,message:`Delete ${n.size} selected items?`,onConfirm:ht,onCancel:()=>Me(!1),isConfirming:B,confirmButtonText:"Delete Selected",confirmButtonVariant:"danger"}),$e&&e.jsx(es,{isOpen:$e,onClose:()=>Ie(!1),title:`Move ${n.size} Link(s)`,children:e.jsxs("div",{className:"p-4",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mb-2",children:"Select target Software and optionally a Version:"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"modalSoftwareMoveLinks",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Target Software*"}),e.jsxs("select",{id:"modalSoftwareMoveLinks",value:T??"",onChange:t=>{Ce(t.target.value?parseInt(t.target.value):null),Le(void 0)},className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white",disabled:ue||X.length===0,children:[e.jsx("option",{value:"",children:"Select Software..."}),X.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),T&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"modalVersionMoveLinks",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Target Version (Optional)"}),e.jsxs("select",{id:"modalVersionMoveLinks",value:_e===null?"NULL_VERSION":_e??"",onChange:t=>Le(t.target.value==="NULL_VERSION"?null:t.target.value?parseInt(t.target.value):void 0),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white",disabled:ue||Ae,children:[e.jsx("option",{value:"",children:Ae?"Loading...":"Select Version (Optional)..."}),e.jsx("option",{value:"NULL_VERSION",children:"No Specific Version (Clear Association)"}),Ee.map(t=>e.jsx("option",{value:t.id,children:t.version_number},t.id))]}),Ee.length===0&&!Ae&&T&&e.jsx("p",{className:"text-xs text-yellow-600 mt-1",children:"No versions for selected software. You can still move to the software without a specific version."})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[e.jsx("button",{type:"button",onClick:()=>Ie(!1),className:"px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500",disabled:ue,children:"Cancel"}),e.jsx("button",{type:"button",onClick:yt,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",disabled:ue||!T,children:ue?"Moving...":"Confirm Move"})]})]})}),h&&N&&e.jsxs("div",{ref:Fe,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("h3",{className:"text-xl font-semibold text-gray-800 dark:text-white mb-4",children:["Comments for: ",e.jsx("span",{className:"font-bold text-blue-600 dark:text-blue-400",children:N.title})]}),e.jsx(Gt,{itemId:N.id,itemType:"link",onCommentAction:Ge})]}),!h&&N&&e.jsx("div",{ref:Fe,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 text-center",children:e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Please log in to view and manage comments."})})]})};export{ms as default};
