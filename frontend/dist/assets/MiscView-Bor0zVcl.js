import{r as s,u as je,C as Je,s as g,j as e,F as wt,X as jt,c as Ct,a as P,D as Ft,Q as fe,E as Nt,G as St,d as _t,g as Mt,H as Dt,i as It,k as At,S as zt,I as Pt,J as $t,m as Bt,n as Lt,o as Ut,p as Ot}from"./index-CV5n8zLA.js";import{u as Ke,U as Et,o as Xe,c as Ye,a as oe,b as Vt,P as Ge,T as He,D as ke,M as Rt,F as Tt,C as qt,e as Gt,d as Ht}from"./CommentSection-DiRbIzBO.js";import{C as Jt,D as Kt,a as we,M as Xt}from"./Modal-DZMAg2oO.js";import{E as Yt}from"./ErrorState-Co49wNHX.js";import{A as Wt}from"./archive-CZdNTzfR.js";const Zt=Ye().shape({selectedCategoryId:oe().required("Please select a misc category."),selectedFile:Vt().when("$isEditMode",{is:r=>!r,then:r=>r.required("Please select a file to upload.").test("filePresent","File is required for upload.",c=>!!c),otherwise:r=>r.nullable()}),title:oe().transform(r=>r===""?void 0:r).optional().max(255,"Title cannot exceed 255 characters.").nullable(),description:oe().transform(r=>r===""?void 0:r).optional().max(1e3,"Description cannot exceed 1000 characters.").nullable()}),Qt=({fileToEdit:r,preselectedCategoryId:c,onUploadSuccess:u,onFileUpdated:y,onCancelEdit:f})=>{const o=!!r,{register:C,handleSubmit:O,control:ne,formState:{errors:x},watch:$,setValue:F,reset:S}=Ke({resolver:Xe(Zt),context:{isEditMode:o},defaultValues:{selectedCategoryId:(c==null?void 0:c.toString())||"",title:"",description:"",selectedFile:null}}),[D,q]=s.useState([]),[B,v]=s.useState(null),[m,I]=s.useState(!1),[E,M]=s.useState(!1),[k,_]=s.useState(0),w=s.useRef(null),{isAuthenticated:L,user:V}=je(),A=V==null?void 0:V.role,j=$("selectedFile");s.useEffect(()=>{L&&(A==="admin"||A==="super_admin")&&(M(!0),Je().then(q).catch(()=>g("Failed to load misc categories.")).finally(()=>M(!1)))},[L,A]),s.useEffect(()=>{o&&r?(S({selectedCategoryId:r.misc_category_id.toString(),title:r.user_provided_title||"",description:r.user_provided_description||"",selectedFile:null}),v(r.original_filename),w.current&&(w.current.value="")):(S({selectedCategoryId:(c==null?void 0:c.toString())||"",title:"",description:"",selectedFile:null}),v(null),w.current&&(w.current.value=""))},[o,r,c,S]);const xe=d=>{d.target.files&&d.target.files[0]?(F("selectedFile",d.target.files[0],{shouldValidate:!0,shouldDirty:!0}),o&&v(null)):F("selectedFile",null,{shouldValidate:!0,shouldDirty:!0})},G=()=>{F("selectedFile",null,{shouldValidate:!0,shouldDirty:!0}),w.current&&(w.current.value=""),o&&r&&v(r.original_filename)},he=async d=>{var K,X,Y,H,W,Z;if(!L||!A||!["admin","super_admin"].includes(A)){g("Not authorized.");return}I(!0),_(0);try{let h;if(d.selectedFile){const z={misc_category_id:d.selectedCategoryId,user_provided_title:((K=d.title)==null?void 0:K.trim())||"",user_provided_description:((X=d.description)==null?void 0:X.trim())||""};h=await Ct(d.selectedFile,"misc_file",z,de=>_(de)),P(`File "${h.original_filename}" uploaded successfully!`),u&&u(h),S({selectedCategoryId:(c==null?void 0:c.toString())||d.selectedCategoryId,title:"",description:"",selectedFile:null}),w.current&&(w.current.value="")}else if(o&&r){const z=new FormData;z.append("misc_category_id",d.selectedCategoryId),z.append("user_provided_title",((Y=d.title)==null?void 0:Y.trim())||""),z.append("user_provided_description",((H=d.description)==null?void 0:H.trim())||""),h=await Ft(r.id,z),P(`File "${h.user_provided_title||h.original_filename}" metadata updated successfully!`),y&&y(h)}else{g("No file selected for new upload."),I(!1);return}}catch(h){const z=((Z=(W=h.response)==null?void 0:W.data)==null?void 0:Z.msg)||h.message||"File operation failed.";g(z)}finally{I(!1)}},Q=d=>{console.error("Form validation errors:",d),g("Please correct the errors highlighted in the form.")};return!L||!A||!["admin","super_admin"].includes(A)?null:e.jsxs("form",{onSubmit:O(he,Q),className:"space-y-6 bg-white dark:bg-gray-800 dark:border-gray-700 p-6 rounded-lg shadow-lg border border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-800 dark:text-gray-100",children:o?"Edit Miscellaneous File":"Upload File to Misc Category"}),o&&f&&e.jsx("button",{type:"button",onClick:f,className:"text-sm text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200",children:"Cancel Edit"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedCategoryId",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Misc Category*"}),E?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading categories..."}):e.jsxs("select",{id:"selectedCategoryId",...C("selectedCategoryId"),disabled:m||D.length===0,className:`mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${x.selectedCategoryId?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",disabled:!0,children:"Select a category"}),D.map(d=>e.jsx("option",{value:d.id.toString(),children:d.name},d.id))]}),x.selectedCategoryId&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:x.selectedCategoryId.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:o?"Replace File (Optional)":"Select File*"}),e.jsx("div",{className:"mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md dark:border-gray-600 hover:border-blue-500 dark:hover:border-blue-400",children:e.jsxs("div",{className:"space-y-1 text-center",children:[e.jsx(Et,{className:"mx-auto h-12 w-12 text-gray-400 dark:text-gray-500"}),e.jsxs("div",{className:"flex text-sm text-gray-600 dark:text-gray-400",children:[e.jsxs("label",{htmlFor:"selectedFile",className:"relative cursor-pointer bg-white dark:bg-gray-800 rounded-md font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300 focus-within:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx("span",{children:j?"Change file":"Upload a file"}),e.jsx("input",{id:"selectedFile",name:"selectedFile-input",type:"file",className:"sr-only",onChange:xe,ref:w,disabled:m})]}),e.jsx("p",{className:"pl-1",children:"or drag and drop"})]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Any allowed file type."})]})}),(j||o&&B)&&e.jsxs("div",{className:"mt-3 flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md",children:[e.jsxs("div",{className:"flex items-center space-x-2 overflow-hidden",children:[e.jsx(wt,{size:18,className:"text-gray-500 dark:text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:j?j.name:B}),o&&B&&!j&&e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 ml-2",children:"(current file)"})]}),j&&e.jsx("button",{type:"button",onClick:G,disabled:m,className:"p-1 rounded-full text-gray-400 hover:text-gray-600 hover:bg-gray-200 dark:text-gray-500 dark:hover:text-gray-300 dark:hover:bg-gray-600",children:e.jsx(jt,{size:16})})]}),x.selectedFile&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:x.selectedFile.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"title",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"File Title (Optional)"}),e.jsx("input",{type:"text",id:"title",...C("title"),placeholder:o&&r?r.original_filename:"Defaults to filename if blank",disabled:m,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${x.title?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),x.title&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:x.title.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"File Description (Optional)"}),e.jsx("textarea",{id:"description",rows:3,...C("description"),disabled:m,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${x.description?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),x.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:x.description.message})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{type:"submit",disabled:m||E||!o&&!j||!$("selectedCategoryId"),className:"flex-1 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",children:m?o?"Updating...":"Uploading...":o?"Update File Details":"Upload to Misc"}),o&&f&&e.jsx("button",{type:"button",onClick:f,disabled:m,className:"flex-1 inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 dark:border-gray-500 dark:text-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600",children:"Cancel"})]}),m&&j&&k>0&&e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 my-3 relative",children:[e.jsx("div",{className:"bg-blue-600 h-4 rounded-full transition-all duration-150 ease-out",style:{width:`${k}%`}}),e.jsxs("p",{className:"absolute inset-0 text-center text-xs font-medium leading-4 text-white dark:text-gray-100",children:[Math.round(k),"%"]})]})]})},es=Ye().shape({name:oe().required("Category name is required.").max(100,"Category name cannot exceed 100 characters."),description:oe().optional().max(500,"Description cannot exceed 500 characters.").nullable()}),ts=({categoryToEdit:r,onSuccess:c,onCancel:u})=>{const y=!!r,{register:f,handleSubmit:o,formState:{errors:C},reset:O,setValue:ne}=Ke({resolver:Xe(es),defaultValues:{name:"",description:""}}),[x,$]=s.useState(!1),{isAuthenticated:F,user:S}=je(),D=S==null?void 0:S.role;s.useEffect(()=>{O(y&&r?{name:r.name,description:r.description||""}:{name:"",description:""})},[r,y,O]);const q=async v=>{var m,I,E,M;$(!0);try{let k;if(y&&r){const _={};let w=!1;v.name.trim()!==r.name&&(_.name=v.name.trim(),w=!0);const L=r.description||"",V=((m=v.description)==null?void 0:m.trim())||"";if(V!==L&&(_.description=V||void 0,w=!0),!w){fe.info("No changes detected."),$(!1),c&&c(r);return}k=await Nt(r.id,_)}else{const _={name:v.name.trim(),description:((I=v.description)==null?void 0:I.trim())||void 0};k=await St(_)}fe.success(`Category "${k.name}" ${y?"updated":"added"} successfully!`),y||O({name:"",description:""}),c&&c(k)}catch(k){const _=((M=(E=k.response)==null?void 0:E.data)==null?void 0:M.msg)||k.message||`Failed to ${y?"update":"add"} category.`;fe.error(_)}finally{$(!1)}},B=v=>{console.error("Form validation errors:",v),fe.error("Please correct the errors in the form.")};return!F||!D||!["admin","super_admin"].includes(D)?e.jsx("p",{children:"You are not authorized to manage categories."}):e.jsxs("form",{onSubmit:o(q,B),className:"space-y-4 p-4 border border-gray-200 rounded-lg bg-white shadow-sm dark:bg-gray-800 dark:border-gray-700",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-800 dark:text-gray-100",children:y?"Edit Miscellaneous Category":"Add New Miscellaneous Category"}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"name",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Name*"}),e.jsx("input",{type:"text",id:"name",...f("name"),disabled:x,className:`mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${C.name?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),C.name&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:C.name.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Description"}),e.jsx("textarea",{id:"description",...f("description"),rows:3,disabled:x,className:`mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${C.description?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),C.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:C.description.message})]}),e.jsxs("div",{className:"flex items-center space-x-3 pt-2",children:[e.jsx("button",{type:"submit",disabled:x,className:"inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-60",children:x?y?"Updating...":"Adding...":y?"Save Changes":"Add Category"}),u&&e.jsx("button",{type:"button",onClick:u,disabled:x,className:"inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:border-gray-500 dark:text-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600",children:"Cancel"})]})]})},ss="http://localhost:7000/",ns=()=>{const{searchTerm:r,setSearchTerm:c}=_t(),{isAuthenticated:u,user:y}=je(),f=y==null?void 0:y.role,[o,C]=s.useState([]),[O,ne]=s.useState(!0),[x,$]=s.useState(null),[F,S]=s.useState([]),[D,q]=s.useState(!0),[B,v]=s.useState(null),[m,I]=s.useState(null),[E,M]=s.useState(1),[k,_]=s.useState(15),[w,L]=s.useState(0),[V,A]=s.useState(0),[j,xe]=s.useState("user_provided_title"),[G,he]=s.useState("asc"),[Q,d]=s.useState(!1),[K,X]=s.useState(null),[Y,H]=s.useState(!1),[W,Z]=s.useState(null),[h,z]=s.useState(null),[de,We]=s.useState(!1),[Ze,Ce]=s.useState(!1),[R,Fe]=s.useState(null),[Ne,Se]=s.useState(!1),[_e,Me]=s.useState(!1),[ee,te]=s.useState(new Map),[De,Qe]=s.useState(!0),[N,se]=s.useState(new Set),[Ie,Ae]=s.useState(!1),[et,ze]=s.useState(!1),[re,Pe]=s.useState(!1),[$e,ce]=s.useState(!1),[me,ye]=s.useState(null),[Be,be]=s.useState(!1),[b,ae]=s.useState(null),ue=s.useRef(null),Le=Mt(),pe=s.useMemo(()=>m!==null||r!=="",[m,r]),tt=s.useCallback(()=>{I(null),c&&c(""),M(1)},[c]),ge=s.useCallback(async()=>{var t,a;ne(!0),$(null);try{const l=await Je();C(l)}catch(l){C([]);const n=((a=(t=l.response)==null?void 0:t.data)==null?void 0:a.msg)||l.message||"Failed to load categories.";$(n),g(n)}finally{ne(!1)}},[]);s.useEffect(()=>{u?ge():C([])},[u,ge]),s.useEffect(()=>{const t=new URLSearchParams(Le.search),a=t.get("item_id"),l=t.get("comment_id");if(a&&l&&F.length>0){const n=parseInt(a,10);if(!isNaN(n)){const i=F.find(p=>p.id===n);i?((!b||b.id!==i.id)&&ae(i),setTimeout(()=>{var p;(p=ue.current)==null||p.scrollIntoView({behavior:"smooth",block:"center"})},100)):console.warn(`MiscView: MiscFile with item_id ${n} not found in the current list.`)}}},[Le.search,F,b]);const U=s.useCallback(async(t,a=!1)=>{var l,n;a&&q(!0),v(null);try{const i=await Dt(m||void 0,t,k,j,G);S(i.misc_files),L(i.total_pages),A(i.total_misc_files),M(i.page),_(i.per_page);const p=new Map;u&&i.misc_files&&i.misc_files.forEach(le=>p.set(le.id,{favoriteId:le.favorite_id})),te(p)}catch(i){const p=((n=(l=i.response)==null?void 0:l.data)==null?void 0:n.msg)||i.message||"Failed to fetch files.";a?(v(p),S([]),L(0),A(0)):g(p)}finally{a&&q(!1)}},[m,k,j,G,u]);s.useEffect(()=>{u?U(1,!0):(S([]),q(!1))},[u,m,j,G,U]),s.useEffect(()=>{se(new Set)},[m,j,G,r,E]);const st=t=>{I(t.target.value?parseInt(t.target.value):null),M(1)},rt=t=>{M(t),U(t,!0)},at=t=>{xe(t),he(a=>j===t&&a==="asc"?"desc":"asc"),M(1)},Ue=(t,a)=>{H(!1),Z(null),U(1,!0)},lt=t=>{d(!1),X(null),P(t),ge()},Oe=t=>{Z(t||null),H(!0),d(!1),t&&window.scrollTo({top:0,behavior:"smooth"})},Ee=()=>{Z(null),H(!1)},it=()=>{X(null),d(!0),H(!1)},Ve=()=>{X(null),d(!1)},Re=()=>{z(null),We(!1)},ot=t=>{Fe(t),Se(!0)},ve=()=>{Fe(null),Se(!1)},nt=async()=>{var t,a;if(h){Ce(!0);try{await Pt(h.id),P(`Category "${h.name}" deleted.`),Re(),ge(),m===h.id&&I(null)}catch(l){g(((a=(t=l.response)==null?void 0:t.data)==null?void 0:a.msg)||"Delete failed.")}finally{Ce(!1)}}},dt=async()=>{if(R){Me(!0),b&&b.id===R.id&&ae(null);try{await $t(R.id),P(`File "${R.user_provided_title||R.original_filename}" deleted.`),ve(),U(1,!0)}catch(t){g(t.message||"Delete failed."),ve()}finally{Me(!1)}}},Te=s.useMemo(()=>{if(!r)return F;const t=r.toLowerCase();return F.filter(a=>(a.user_provided_title||"").toLowerCase().includes(t)||a.original_filename.toLowerCase().includes(t)||(a.user_provided_description||"").toLowerCase().includes(t)||(a.category_name||"").toLowerCase().includes(t))},[F,r]),ct=(t,a)=>se(l=>{const n=new Set(l);return a?n.add(t):n.delete(t),n}),mt=t=>{const a=new Set;t&&Te.forEach(l=>a.add(l.id)),se(a)},ut=()=>{if(N.size===0){g("No items selected.");return}be(!0)},gt=async()=>{be(!1),Ae(!0),b&&N.has(b.id)&&ae(null);try{const t=await Bt(Array.from(N),"misc_file");P(t.msg||`${t.deleted_count} file(s) deleted.`),se(new Set),U(1,!0)}catch(t){g(t.message||"Bulk delete failed.")}finally{Ae(!1)}},ft=async()=>{if(N.size===0){g("No items selected.");return}ze(!0);try{const t=await At(Array.from(N),"misc_file"),a=URL.createObjectURL(t),l=document.createElement("a");l.href=a;const n=new Date().toISOString().replace(/:/g,"-");l.download=`bulk_download_misc_files_${n}.zip`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(a),P("Download started.")}catch(t){g(t.message||"Bulk download failed.")}finally{ze(!1)}},xt=()=>{if(N.size===0){g("No items selected.");return}if(o.length===0){g("Categories unavailable for move.");return}ye(null),ce(!0)},ht=async()=>{if(!me){g("Select target category.");return}ce(!1),Pe(!0);try{const t=await Lt(Array.from(N),"misc_file",{target_misc_category_id:me});P(t.msg||`${t.moved_count} file(s) moved.`),se(new Set),U(1,!0)}catch(t){g(t.message||"Bulk move failed.")}finally{Pe(!1),ye(null)}},yt=t=>t?new Date(t).toLocaleDateString("en-CA"):"-",bt=t=>{if(t==null)return"N/A";if(t===0)return"0 B";const a=1024,l=["B","KB","MB","GB","TB"],n=Math.floor(Math.log(t)/Math.log(a));return parseFloat((t/Math.pow(a,n)).toFixed(2))+" "+l[n]},pt=[{key:"user_provided_title",header:"Title",sortable:!0,render:t=>t.user_provided_title||e.jsx("span",{className:"italic text-gray-500 dark:text-gray-400",children:t.original_filename})},{key:"original_filename",header:"Original Filename",sortable:!0},{key:"category_name",header:"Category",sortable:!0},{key:"uploaded_by_username",header:"Uploaded By",sortable:!0,render:t=>t.uploaded_by_username||"N/A"},{key:"file_size",header:"Size",sortable:!0,render:t=>bt(t.file_size)},{key:"created_at",header:"Uploaded At",sortable:!0,render:t=>yt(t.created_at)},{key:"file_path",header:"Link",render:t=>t.is_downloadable!==!1?e.jsxs("a",{href:`${ss}${t.file_path}`,target:"_blank",rel:"noopener noreferrer",className:"flex items-center text-blue-600 hover:text-blue-800",onClick:l=>l.stopPropagation(),title:"Download file",children:[e.jsx(ke,{size:14,className:"mr-1"}),"Download"]}):e.jsxs("span",{className:"flex items-center text-gray-400 cursor-not-allowed",title:"Download not permitted",children:[e.jsx(ke,{size:14,className:"mr-1"}),"Download"]})},{key:"actions",header:"Actions",render:t=>{var a,l,n;return e.jsxs("div",{className:"flex space-x-1 items-center",children:[u&&e.jsx("button",{onClick:i=>{i.stopPropagation(),kt(t,"misc_file")},className:`p-1 rounded-md ${(a=ee.get(t.id))!=null&&a.favoriteId?"text-yellow-500 hover:text-yellow-600":"text-gray-400 hover:text-yellow-500"}`,title:(l=ee.get(t.id))!=null&&l.favoriteId?"Remove Favorite":"Add Favorite",children:e.jsx(zt,{size:16,className:(n=ee.get(t.id))!=null&&n.favoriteId?"fill-current":""})}),u&&e.jsxs("button",{onClick:i=>{i.stopPropagation(),b&&b.id===t.id?ae(null):(ae(t),setTimeout(()=>{var p;return(p=ue.current)==null?void 0:p.scrollIntoView({behavior:"smooth"})},0))},className:"p-1 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 rounded-md",title:b&&b.id===t.id?"Hide Comments":"View Comments",children:[e.jsx(Gt,{size:16}),e.jsxs("span",{className:"ml-1 text-xs",children:["(",t.comment_count??0,")"]})]}),(f==="admin"||f==="super_admin")&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:i=>{i.stopPropagation(),Oe(t)},className:"p-1 text-blue-600 hover:text-blue-800 rounded-md",title:"Edit",children:e.jsx(Ht,{size:16})}),e.jsx("button",{onClick:i=>{i.stopPropagation(),ot(t)},className:"p-1 text-red-600 hover:text-red-800 rounded-md",title:"Delete",children:e.jsx(He,{size:16})})]})]})}}],vt=s.useCallback(()=>{U(1,!0)},[U]),kt=async(t,a)=>{var p,le;if(!u){g("Log in to manage favorites.");return}const l=ee.get(t.id),n=!!(l!=null&&l.favoriteId),i=new Map(ee);n?i.set(t.id,{favoriteId:void 0}):i.set(t.id,{favoriteId:-1}),te(i);try{const J=t.user_provided_title||t.original_filename;if(n&&typeof(l==null?void 0:l.favoriteId)=="number")await Ut(t.id,a),P(`"${J}" removed from favorites.`),te(ie=>{const T=new Map(ie);return T.set(t.id,{favoriteId:void 0}),T});else{const ie=await Ot(t.id,a);te(T=>{const qe=new Map(T);return qe.set(t.id,{favoriteId:ie.id}),qe}),P(`"${J}" added to favorites.`)}}catch(J){g(((le=(p=J==null?void 0:J.response)==null?void 0:p.data)==null?void 0:le.msg)||J.message||"Failed to update favorite."),te(ie=>{const T=new Map(ie);return n?T.set(t.id,{favoriteId:l==null?void 0:l.favoriteId}):T.set(t.id,{favoriteId:void 0}),T})}};return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex justify-between items-start sm:items-center mb-6 flex-col sm:flex-row",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800 dark:text-white",children:"Miscellaneous Files"}),e.jsx("p",{className:"text-gray-600 mt-1 dark:text-gray-300",children:"Manage and browse categorized files."})]}),u&&(f==="admin"||f==="super_admin")&&e.jsxs("div",{className:"flex space-x-3 mt-4 sm:mt-0",children:[e.jsxs("button",{onClick:Q&&!K?Ve:it,className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx(Ge,{size:18,className:"mr-2"}),Q&&!K?"Cancel":"Add/Edit Category"]}),e.jsxs("button",{onClick:Y&&!W?Ee:()=>Oe(),className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx(Ge,{size:18,className:"mr-2"}),Y&&!W?"Cancel":"Upload New File"]})]})]}),Q&&e.jsx("div",{className:"my-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow",children:e.jsx(ts,{categoryToEdit:K,onSuccess:t=>lt(`Category "${t.name}" saved.`),onCancel:Ve})}),Y&&e.jsx("div",{className:"my-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow",children:e.jsx(Qt,{fileToEdit:W,onUploadSuccess:t=>Ue(),onFileUpdated:t=>Ue(),onCancelEdit:Ee})}),N.size>0&&e.jsx("div",{className:"my-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:[N.size," item(s) selected"]}),(f==="admin"||f==="super_admin")&&e.jsxs("button",{onClick:ut,disabled:Ie,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-800 focus:ring-red-500 disabled:opacity-50",children:[e.jsx(He,{size:14,className:"mr-1.5"}),"Delete"]}),u&&e.jsxs("button",{onClick:ft,disabled:et,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-green-500 hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 focus:ring-green-500 disabled:opacity-50",children:[e.jsx(ke,{size:14,className:"mr-1.5"}),"Download"]}),(f==="admin"||f==="super_admin")&&e.jsxs("button",{onClick:xt,disabled:re,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 focus:ring-blue-500 disabled:opacity-50",children:[e.jsx(Rt,{size:14,className:"mr-1.5"}),"Move"]})]})}),e.jsxs("div",{className:"my-4",children:[e.jsxs("button",{onClick:()=>Qe(t=>!t),className:"flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-md text-sm font-medium mb-2",children:[De?e.jsx(Jt,{size:18,className:"mr-2"}):e.jsx(Tt,{size:18,className:"mr-2"})," Category Filter"]}),De&&e.jsxs(e.Fragment,{children:[e.jsx("label",{htmlFor:"category-filter",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 sr-only",children:"Filter by Category"}),e.jsxs("select",{id:"category-filter",value:m??"",onChange:st,className:"block w-full sm:w-1/3 pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200",disabled:O||o.length===0,children:[e.jsx("option",{value:"",children:"All Categories"}),o.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]})]}),D?e.jsx("div",{className:"py-10",children:e.jsx(It,{message:"Loading files..."})}):B&&F.length===0&&!D?e.jsx(Yt,{message:B,onRetry:vt}):!D&&!B&&F.length===0?e.jsxs("div",{className:"text-center py-10 bg-white dark:bg-gray-800 rounded-lg shadow-sm my-6",children:[e.jsx(Wt,{size:48,className:"mx-auto text-yellow-500 dark:text-yellow-400 mb-4"}),e.jsx("p",{className:"text-xl font-semibold text-gray-700 dark:text-gray-200 mb-3",children:pe?"No Files Found Matching Criteria":"No Files Available"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 px-4",children:pe?"Try adjusting or clearing your search/filter settings.":f==="admin"||f==="super_admin"?"Upload new files to get started.":"Please check back later."}),pe&&e.jsx("button",{onClick:tt,className:"mt-6 btn-primary text-sm",children:"Clear All Filters & Search"})]}):e.jsx(Kt,{columns:pt,data:Te,rowClassName:"group",isLoading:D||_e,currentPage:E,totalPages:w,onPageChange:rt,itemsPerPage:k,totalItems:V,sortColumn:j,sortOrder:G,onSort:at,isSelectionEnabled:!0,selectedItemIds:N,onSelectItem:ct,onSelectAllItems:mt}),de&&h&&e.jsx(we,{isOpen:de,title:"Delete Category",message:`Delete category "${h.name}"? Files in it won't be deleted but will become uncategorized.`,onConfirm:nt,onCancel:Re,isConfirming:Ze,confirmButtonText:"Delete",confirmButtonVariant:"danger"}),Ne&&R&&e.jsx(we,{isOpen:Ne,title:"Delete File",message:`Delete "${R.user_provided_title||R.original_filename}"?`,onConfirm:dt,onCancel:ve,isConfirming:_e,confirmButtonText:"Delete",confirmButtonVariant:"danger"}),Be&&e.jsx(we,{isOpen:Be,title:`Delete ${N.size} File(s)`,message:`Delete ${N.size} selected items?`,onConfirm:gt,onCancel:()=>be(!1),isConfirming:Ie,confirmButtonText:"Delete Selected",confirmButtonVariant:"danger"}),$e&&e.jsx(Xt,{isOpen:$e,onClose:()=>ce(!1),title:`Move ${N.size} File(s)`,children:e.jsxs("div",{className:"p-4",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mb-2",children:"Select target category:"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"modalCategoryMove",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Target Category*"}),e.jsxs("select",{id:"modalCategoryMove",value:me??"",onChange:t=>ye(t.target.value?parseInt(t.target.value):null),className:"input-class w-full dark:bg-gray-700 dark:text-white dark:border-gray-600",disabled:re||o.length===0,children:[e.jsx("option",{value:"",children:"Select Category..."}),o.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),o.length===0&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:"Categories unavailable."})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[e.jsx("button",{type:"button",onClick:()=>ce(!1),className:"btn-secondary",disabled:re,children:"Cancel"}),e.jsx("button",{type:"button",onClick:ht,className:"btn-primary",disabled:re||!me,children:re?"Moving...":"Confirm Move"})]})]})}),u&&b&&e.jsxs("div",{ref:ue,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("h3",{className:"text-xl font-semibold text-gray-800 dark:text-white mb-4",children:["Comments for: ",e.jsx("span",{className:"font-bold text-blue-600 dark:text-blue-400",children:b.user_provided_title||b.original_filename})]}),e.jsx(qt,{itemId:b.id,itemType:"misc_file"})]}),!u&&b&&e.jsx("div",{ref:ue,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 text-center",children:e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Please log in to view and manage comments."})})]})};export{ns as default};
