import{r,u as Je,f as Ke,s as m,q as Qe,j as e,L as kt,F as He,X as vt,t as wt,a as P,v as St,c as jt,d as Nt,g as _t,w as It,i as Ft,P as Pt,k as Ct,S as Vt,x as Dt,m as Mt,n as Lt,o as At,p as $t}from"./index-Cx0gNuKI.js";import{u as Ut,U as Bt,o as Rt,c as zt,a as B,b as Et,P as Ot,T as Xe,D as De,M as qt,F as Tt,C as Wt,e as Ht,d as Xt}from"./CommentSection-obay-nDP.js";import{C as Yt,D as Zt,a as Ye,M as Gt}from"./Modal-DeMS46HP.js";import{a as Jt,f as Ze}from"./dateUtils-C4q4Gbs_.js";import{F as Kt}from"./FilterTabs-CvXtjvqA.js";import{E as Qt}from"./ErrorState-ByXhRj64.js";const Ge=()=>{const s=new Date,f=s.getFullYear(),u=String(s.getMonth()+1).padStart(2,"0"),_=String(s.getDate()).padStart(2,"0");return`${f}-${u}-${_}`},Z="CREATE_NEW_VERSION_SENTINEL_VALUE",es=zt().shape({selectedSoftwareId:B().required("Software Product must be selected."),selectedVersionId:B().required("Version selection is required."),typedVersionString:B().when("selectedVersionId",{is:Z,then:s=>s.required("New Version String is required when 'Enter New Version' is selected.").min(1),otherwise:s=>s.transform(f=>f===""?void 0:f).optional().nullable()}),patchName:B().required("Patch Name is required.").max(255,"Patch Name cannot exceed 255 characters."),releaseDate:B().transform(s=>s===""?void 0:s).optional().nullable(),inputMode:B().oneOf(["url","upload"]).required("Input mode must be selected."),externalUrl:B().when("inputMode",{is:"url",then:s=>s.required("External Download URL is required.").url("Please enter a valid URL."),otherwise:s=>s.optional().nullable()}),selectedFile:Et().when(["inputMode","$isEditMode","$patchToEditIsExternal"],{is:(s,f,u)=>s!=="upload"?!1:!!(!f||f&&u),then:s=>s.required("Please select a file to upload.").test("filePresent","File is required for upload.",f=>!!f),otherwise:s=>s.nullable()}),description:B().transform(s=>s===""?void 0:s).optional().max(2e3,"Description cannot exceed 2000 characters.").nullable(),patch_by_developer:B().transform(s=>s===""?void 0:s).optional().max(255,"Patch developer name cannot exceed 255 characters.").nullable()}),ts=({patchToEdit:s,onPatchAdded:f,onPatchUpdated:u,onCancelEdit:_})=>{const i=!!s,{register:g,handleSubmit:re,control:G,formState:{errors:d},watch:w,setValue:p,reset:C}=Ut({resolver:Rt(es),context:{isEditMode:i,patchToEditIsExternal:(s==null?void 0:s.is_external_link)||!1},defaultValues:{selectedSoftwareId:"",selectedVersionId:"",typedVersionString:"",patchName:"",releaseDate:Ge(),description:"",inputMode:"url",externalUrl:"",selectedFile:null,patch_by_developer:""}}),[T,W]=r.useState([]),[V,D]=r.useState([]),[R,I]=r.useState(null),[b,M]=r.useState(!1),[H,L]=r.useState(!1),[ae,le]=r.useState(0),[ye,X]=r.useState(!1),A=r.useRef(null),{isAuthenticated:oe,user:J}=Je(),Y=J==null?void 0:J.role,j=w("selectedSoftwareId"),z=w("selectedVersionId"),ne=w("inputMode"),S=w("selectedFile"),de=z===Z;r.useEffect(()=>{const a=k=>{ye&&(k.preventDefault(),k.returnValue="")};return window.addEventListener("beforeunload",a),()=>{window.removeEventListener("beforeunload",a)}},[ye]),r.useEffect(()=>{oe&&(Y==="admin"||Y==="super_admin")&&(L(!0),Ke().then(W).catch(()=>m("Failed to load software list.")).finally(()=>L(!1)))},[oe,Y]),r.useEffect(()=>{j?(L(!0),D([]),p("selectedVersionId",""),p("typedVersionString",""),Qe(parseInt(j)).then(D).catch(()=>m("Failed to load versions.")).finally(()=>L(!1))):(D([]),p("selectedVersionId",""),p("typedVersionString",""))},[j,p]),r.useEffect(()=>{if(i&&s){const a={selectedSoftwareId:s.software_id.toString(),patchName:s.patch_name,releaseDate:s.release_date?s.release_date.split("T")[0]:"",description:s.description||"",inputMode:s.is_external_link?"url":"upload",externalUrl:s.is_external_link?s.download_link:"",patch_by_developer:s.patch_by_developer||""};s.version_id&&s.software_id.toString()===j&&V.length>0?V.find(N=>N.id===s.version_id)?(a.selectedVersionId=s.version_id.toString(),a.typedVersionString=s.version_number):(a.selectedVersionId=Z,a.typedVersionString=s.version_number):s.version_number&&(a.selectedVersionId=Z,a.typedVersionString=s.version_number),C(a),s.is_external_link?I(null):I(s.original_filename_ref||s.download_link.split("/").pop()||"unknown_file"),p("selectedFile",null),A.current&&(A.current.value="")}else i||E(!!j)},[i,s,V,j,C,p]);const E=(a=!1)=>{const k=a?w("selectedSoftwareId"):"";C({selectedSoftwareId:k,selectedVersionId:"",typedVersionString:"",patchName:"",releaseDate:Ge(),description:"",inputMode:"url",externalUrl:"",selectedFile:null,patch_by_developer:""}),I(null),A.current&&(A.current.value="")},ie=a=>{a.target.files&&a.target.files[0]?(p("selectedFile",a.target.files[0],{shouldValidate:!0,shouldDirty:!0}),I(null)):p("selectedFile",null,{shouldValidate:!0,shouldDirty:!0})},ce=()=>{p("selectedFile",null,{shouldValidate:!0,shouldDirty:!0}),A.current&&(A.current.value=""),i&&s&&!s.is_external_link&&I(s.original_filename_ref||s.download_link.split("/").pop()||"unknown_file")},ke=async a=>{var ue,$,ge,fe,xe,O;M(!0),a.inputMode==="upload"&&a.selectedFile&&X(!0),le(0);let k,N;a.selectedVersionId===Z&&a.typedVersionString?N=a.typedVersionString.trim():a.selectedVersionId&&a.selectedVersionId!==Z&&(k=parseInt(a.selectedVersionId));const K={software_id:parseInt(a.selectedSoftwareId),patch_name:a.patchName.trim(),description:((ue=a.description)==null?void 0:ue.trim())||void 0,release_date:a.releaseDate||void 0,patch_by_developer:(($=a.patch_by_developer)==null?void 0:$.trim())||void 0};k&&(K.version_id=k),N&&(K.typed_version_string=N);try{let x;if(a.inputMode==="url"){const U={...K,download_link:a.externalUrl.trim(),is_external_link:!0};i&&s?(x=await wt(s.id,U),P(`Patch "${x.patch_name}" updated successfully!`),u&&u(x)):(x=await St(U),P(`Patch "${x.patch_name}" added successfully!`),f&&f(x),i||(E(!0),p("selectedVersionId",""),p("typedVersionString","")))}else{if(!a.selectedFile){if(i&&s&&!s.is_external_link&&!a.selectedFile){m("To update metadata of an existing uploaded patch without re-uploading, use a different form/feature. To replace the file, select a new file."),M(!1);return}if(!a.selectedFile&&!i){m("No file selected for upload."),M(!1);return}}const U={software_id:a.selectedSoftwareId,...k&&{version_id:k.toString()},...N&&{typed_version_string:N},patch_name:a.patchName.trim(),...a.releaseDate&&{release_date:a.releaseDate},description:((ge=a.description)==null?void 0:ge.trim())||"",patch_by_developer:((fe=a.patch_by_developer)==null?void 0:fe.trim())||""};x=await jt(a.selectedFile,"patch",U,Ne=>le(Ne)),P(`Patch "${x.patch_name}" added successfully via chunked upload!`),f&&f(x),E(!0),p("selectedVersionId",""),p("typedVersionString","")}}catch(x){const U=((O=(xe=x.response)==null?void 0:xe.data)==null?void 0:O.msg)||x.message||`Failed to ${i&&a.inputMode==="url"?"update":"add"} patch.`;m(U),a.inputMode==="upload"&&X(!1)}finally{M(!1),a.inputMode==="upload"&&X(!1)}},me=a=>{console.error("Form validation errors:",a),m("Please correct the errors highlighted in the form.")};return!oe||!Y||!["admin","super_admin"].includes(Y)?null:e.jsxs("form",{onSubmit:re(ke,me),className:"space-y-6 bg-white dark:bg-gray-800 dark:border-gray-700 p-6 rounded-lg shadow-md border border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-800 dark:text-gray-100",children:i?"Edit Patch":"Add New Patch"}),i&&_&&e.jsx("button",{type:"button",onClick:_,className:"text-sm text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200",children:"Cancel"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedSoftwareId",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Software Product*"}),H&&!T.length?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading software..."}):e.jsxs("select",{id:"selectedSoftwareId",...g("selectedSoftwareId"),disabled:b||H&&!T.length,className:`mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${d.selectedSoftwareId?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",disabled:!0,children:"Select Software Product"}),T.map(a=>e.jsx("option",{value:a.id.toString(),children:a.name},a.id))]}),d.selectedSoftwareId&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:d.selectedSoftwareId.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedVersionId",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Version*"}),e.jsx("div",{className:"mt-1",children:e.jsxs("select",{id:"selectedVersionId",...g("selectedVersionId"),disabled:b||H||!j,className:`block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${d.selectedVersionId?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",disabled:V.length>0&&!!j,children:H&&j?"Loading versions...":"Select Existing Version"}),V.map(a=>e.jsx("option",{value:a.id.toString(),children:a.version_number},a.id)),e.jsx("option",{value:Z,children:"Enter New Version String..."})]})}),de&&e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{htmlFor:"typedVersionString",className:"block text-xs font-medium text-gray-600 dark:text-gray-400",children:"New Version String*:"}),e.jsx("input",{type:"text",id:"typedVersionString",...g("typedVersionString"),placeholder:"e.g., 2.5.1-hotfix",className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.typedVersionString?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"This version will be created for the selected software if it doesn't exist."})]}),d.selectedVersionId&&!de&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.selectedVersionId.message}),d.typedVersionString&&de&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.typedVersionString.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"patchName",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Patch Name*"}),e.jsx("input",{type:"text",id:"patchName",...g("patchName"),disabled:b,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.patchName?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),d.patchName&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.patchName.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"releaseDate",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Release Date"}),e.jsx("input",{type:"date",id:"releaseDate",...g("releaseDate"),disabled:b,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.releaseDate?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`}),d.releaseDate&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.releaseDate.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"patch_by_developer",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Patch By Developer"}),e.jsx("input",{type:"text",id:"patch_by_developer",...g("patch_by_developer"),disabled:b,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.patch_by_developer?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),d.patch_by_developer&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.patch_by_developer.message})]}),e.jsxs("div",{className:"my-4",children:[e.jsx("span",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Patch Source:"}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",...g("inputMode"),value:"url",className:"form-radio h-4 w-4 text-blue-600",disabled:b}),e.jsxs("span",{className:"flex items-center dark:text-gray-300",children:[e.jsx(kt,{size:16,className:"mr-1 text-gray-600 dark:text-gray-400"}),"Provide External Link"]})]}),e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",...g("inputMode"),value:"upload",className:"form-radio h-4 w-4 text-blue-600",disabled:b}),e.jsxs("span",{className:"flex items-center dark:text-gray-300",children:[e.jsx(Bt,{size:16,className:"mr-1 text-gray-600 dark:text-gray-400"}),"Upload File"]})]})]}),d.inputMode&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.inputMode.message})]}),ne==="url"&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"externalUrl",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"External Download URL*"}),e.jsx("input",{type:"url",id:"externalUrl",...g("externalUrl"),placeholder:"https://example.com/patch.exe",disabled:b,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.externalUrl?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),d.externalUrl&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.externalUrl.message})]}),ne==="upload"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:i&&R&&!S?"Replace File (Optional)":"Select File to Upload*"}),e.jsx("div",{className:"mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-blue-500 dark:border-gray-600 dark:hover:border-blue-400 transition-colors",children:e.jsxs("div",{className:"space-y-1 text-center",children:[e.jsx(He,{className:"mx-auto h-12 w-12 text-gray-400 dark:text-gray-500"}),e.jsxs("div",{className:"flex text-sm text-gray-600 dark:text-gray-400",children:[e.jsxs("label",{htmlFor:"patch-file-upload-input",className:"relative cursor-pointer bg-white dark:bg-gray-800 rounded-md font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500",children:[e.jsx("span",{children:S?"Change file":"Upload a file"}),e.jsx("input",{id:"patch-file-upload-input",name:"patch-file-input",type:"file",className:"sr-only",onChange:ie,ref:A,disabled:b})]}),e.jsx("p",{className:"pl-1",children:"or drag and drop"})]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"EXE, MSI, ZIP, etc."})]})}),(S||i&&R)&&e.jsxs("div",{className:"mt-3 flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md",children:[e.jsxs("div",{className:"flex items-center space-x-2 overflow-hidden",children:[e.jsx(He,{size:18,className:"text-gray-500 dark:text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:S?S.name:R}),i&&R&&!S&&e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 ml-2",children:"(current)"})]}),S&&e.jsx("button",{type:"button",onClick:ce,disabled:b,className:"p-1 rounded-full text-gray-400 hover:text-gray-600 hover:bg-gray-200 dark:text-gray-500 dark:hover:text-gray-300 dark:hover:bg-gray-600",children:e.jsx(vt,{size:16})})]}),d.selectedFile&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.selectedFile.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Description"}),e.jsx("textarea",{id:"description",rows:3,...g("description"),disabled:b,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${d.description?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),d.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.description.message})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{type:"submit",disabled:b||H,className:"flex-1 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",children:b?i?"Updating...":"Adding...":i?"Update Patch":"Add Patch"}),i&&_&&e.jsx("button",{type:"button",onClick:_,disabled:b,className:"flex-1 inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 dark:border-gray-500 dark:text-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600",children:"Cancel"})]}),b&&ne==="upload"&&ae>0&&e.jsxs("div",{className:"w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 my-3 relative",children:[e.jsx("div",{className:"bg-blue-600 h-4 rounded-full transition-all duration-150 ease-out",style:{width:`${ae}%`}}),e.jsxs("p",{className:"absolute inset-0 text-center text-xs font-medium leading-4 text-white dark:text-gray-100",children:[Math.round(ae),"%"]})]})]})},ds=()=>{const{searchTerm:s,setSearchTerm:f}=Nt(),{isAuthenticated:u,user:_}=Je(),i=_==null?void 0:_.role,[g,re]=r.useState([]),[G,d]=r.useState([]),[w,p]=r.useState(null),[C,T]=r.useState(""),[W,V]=r.useState(""),[D,R]=r.useState(""),[I,b]=r.useState(""),[M,H]=r.useState(""),[L,ae]=r.useState(""),[le,ye]=r.useState(1),[X,A]=r.useState(15),[oe,J]=r.useState(0),[Y,j]=r.useState(0),[z,ne]=r.useState("patch_name"),[S,de]=r.useState("asc"),[E,ie]=r.useState(!0),[ce,ke]=r.useState(null),[me,a]=r.useState(!1),[k,N]=r.useState(null),[K,ue]=r.useState(!1),[$,ge]=r.useState(null),[fe,xe]=r.useState(!1),[O,x]=r.useState(new Map),[U,Ne]=r.useState(!1),[v,he]=r.useState(new Set),[Me,Le]=r.useState(!1),[et,Ae]=r.useState(!1),[Q,$e]=r.useState(!1),[Ue,ve]=r.useState(!1),[ee,_e]=r.useState(null),[Ie,Be]=r.useState([]),[we,Se]=r.useState(null),[Re,Fe]=r.useState(!1),[Pe,ze]=r.useState(!1),[y,pe]=r.useState(null),je=r.useRef(null),Ee=_t(),Ce=r.useMemo(()=>w!==null||C!==""||W!==""||D!==""||s!=="",[w,C,W,D,s]),tt=r.useCallback(()=>{p(null),T(""),V(""),R(""),f&&f("")},[f]),st=()=>{F(1,!0)},rt=()=>{T(""),V(""),R("")},F=r.useCallback(async(t,l=!1)=>{var o,c;l&&ie(!0),ke(null);try{const n=await It(w??void 0,t,X,z,S,I||void 0,M||void 0,L||void 0);re(n.patches),J(n.total_pages),j(n.total_patches),ye(n.page),A(n.per_page);const h=new Map;if(u&&n.patches)for(const be of n.patches)h.set(be.id,{favoriteId:be.favorite_id});x(h)}catch(n){const h=((c=(o=n.response)==null?void 0:o.data)==null?void 0:c.msg)||n.message||"Failed to fetch patches.";l?(ke(h),re([]),J(0),j(0)):m(h)}finally{l&&ie(!1)}},[w,X,z,S,I,M,L,u]);r.useEffect(()=>{const t=setTimeout(()=>b(C),500);return()=>clearTimeout(t)},[C]),r.useEffect(()=>{const t=setTimeout(()=>H(W),500);return()=>clearTimeout(t)},[W]),r.useEffect(()=>{const t=setTimeout(()=>ae(D),500);return()=>clearTimeout(t)},[D]),r.useEffect(()=>{u?F(1,!0):(re([]),ie(!1))},[u,w,z,S,I,M,L,s,F]),r.useEffect(()=>{const t=new URLSearchParams(Ee.search),l=t.get("item_id"),o=t.get("comment_id");if(l&&o&&g.length>0){const c=parseInt(l,10);if(!isNaN(c)){const n=g.find(h=>h.id===c);n?((!y||y.id!==n.id)&&pe(n),setTimeout(()=>{var h;(h=je.current)==null||h.scrollIntoView({behavior:"smooth",block:"center"})},100)):console.warn(`PatchesView: Patch with item_id ${c} not found in the current list.`)}}},[Ee.search,g,y]),r.useEffect(()=>{he(new Set)},[w,z,S,I,M,L,s,le]),r.useEffect(()=>{u&&Ke().then(d).catch(t=>m("Failed to load software list."))},[u]),r.useEffect(()=>{ee?(ze(!0),Qe(ee).then(Be).catch(()=>m("Failed to load versions for move target.")).finally(()=>ze(!1))):Be([])},[ee]);const at=t=>p(t),lt=t=>{ne(t),de(l=>z===t&&l==="asc"?"desc":"asc")},ot=t=>F(t,!0),Oe=t=>{a(!1),N(null),F(1,!0)},nt=()=>{N(null),a(!0)},dt=t=>{N(t),a(!0),window.scrollTo({top:0,behavior:"smooth"})},qe=()=>{N(null),a(!1)},it=t=>{ge(t),ue(!0)},Ve=()=>{ge(null),ue(!1)},ct=async()=>{if($){xe(!0),y&&y.id===$.id&&pe(null);try{await Dt($.id),P(`Patch "${$.patch_name}" deleted.`),Ve(),F(1,!0)}catch(t){m(t.message||"Delete failed."),Ve()}finally{xe(!1)}}},Te=r.useMemo(()=>{if(!s)return g;const t=s.toLowerCase();return g.filter(l=>l.patch_name.toLowerCase().includes(t)||(l.description||"").toLowerCase().includes(t)||(l.software_name||"").toLowerCase().includes(t)||(l.version_number||"").toLowerCase().includes(t))},[g,s]),mt=(t,l)=>he(o=>{const c=new Set(o);return l?c.add(t):c.delete(t),c}),ut=t=>{const l=new Set;t&&Te.forEach(o=>l.add(o.id)),he(l)},gt=()=>{if(v.size===0){m("No items selected.");return}Fe(!0)},ft=async()=>{Fe(!1),Le(!0),y&&v.has(y.id)&&pe(null);try{const t=await Mt(Array.from(v),"patch");P(t.msg||`${t.deleted_count} patch(es) deleted.`),he(new Set),F(1,!0)}catch(t){m(t.message||"Bulk delete failed.")}finally{Le(!1)}},xt=async()=>{if(v.size===0){m("No items selected.");return}const t=g.filter(o=>v.has(o.id)&&!o.is_external_link&&o.is_downloadable!==!1);if(t.length===0){m("No downloadable patch files selected. External links or non-downloadable items cannot be bulk downloaded.");return}const l=t.map(o=>o.id);Ae(!0);try{const o=await Ct(l,"patch"),c=URL.createObjectURL(o),n=document.createElement("a");n.href=c;const h=new Date().toISOString().replace(/:/g,"-");n.download=`bulk_download_patches_${h}.zip`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(c),l.length===v.size?P("Download started for all selected downloadable patches."):P(`Starting download for ${l.length} patch file(s). External links or non-downloadable items were excluded.`)}catch(o){m(o.message||"Bulk download failed.")}finally{Ae(!1)}},ht=()=>{if(v.size===0){m("No items selected.");return}if(G.length===0){m("Software list unavailable.");return}_e(null),Se(null),ve(!0)},pt=async()=>{if(!we){m("Select target version.");return}ve(!1),$e(!0);try{const t=await Lt(Array.from(v),"patch",{target_version_id:we});P(t.msg||`${t.moved_count} patch(es) moved.`),he(new Set),F(1,!0)}catch(t){if(t.response&&t.response.data&&t.response.data.conflicted_items&&Array.isArray(t.response.data.conflicted_items)&&t.response.data.conflicted_items.length>0&&(t.response.status===400||t.response.status===207)){let l="Bulk move could not be completed for some patches due to naming conflicts. ";const o=t.response.data.conflicted_items,c=o.slice(0,3).map(n=>`"${n.name}" (ID ${n.id})`).join(", ");l+=`Conflicting items: ${c}`,o.length>3&&(l+=` and ${o.length-3} more.`),l+=" Please rename the patches or check the target version.",m(l),t.response.data.msg}else t.message?m(t.message):m("Bulk move failed due to an unexpected error.")}finally{$e(!1),_e(null),Se(null)}},bt=[{key:"patch_name",header:"Patch Name",sortable:!0},{key:"software_name",header:"Software",sortable:!0},{key:"version_number",header:"Version",sortable:!0},{key:"patch_by_developer",header:"Developer",sortable:!0,render:t=>t.patch_by_developer||"-"},{key:"description",header:"Description",render:t=>e.jsx("span",{className:"text-sm text-gray-600 block max-w-xs truncate",title:t.description||"",children:t.description||"-"})},{key:"release_date",header:"Release Date",sortable:!0,render:t=>Jt(t.release_date)},{key:"download_link",header:"Link",render:t=>{var o;const l=t.is_external_link||t.is_downloadable!==!1;return!l&&!t.is_external_link?e.jsxs("span",{className:"flex items-center text-gray-400 cursor-not-allowed",title:"Download not permitted",children:[e.jsx(De,{size:14,className:"mr-1"}),"Link"]}):e.jsxs("a",{href:t.download_link,target:t.is_external_link||!((o=t.download_link)!=null&&o.startsWith("/"))?"_blank":"_self",rel:"noopener noreferrer",className:`flex items-center ${l?"text-blue-600 hover:text-blue-800":"text-gray-400 cursor-not-allowed"}`,onClick:c=>{l||c.preventDefault(),c.stopPropagation()},title:l?t.is_external_link?"Open external link":"Download patch":"Download not permitted",children:[e.jsx(De,{size:14,className:"mr-1"}),"Link"]})}},{key:"uploaded_by_username",header:"Uploaded By",sortable:!0,render:t=>t.uploaded_by_username||"N/A"},{key:"updated_by_username",header:"Updated By",sortable:!1,render:t=>t.updated_by_username||"N/A"},{key:"created_at",header:"Created At",sortable:!0,render:t=>Ze(t.created_at??"")},{key:"updated_at",header:"Updated At",sortable:!0,render:t=>Ze(t.updated_at??"")},{key:"actions",header:"Actions",render:t=>{var l,o,c;return e.jsxs("div",{className:"flex space-x-1 items-center",children:[u&&e.jsx("button",{onClick:n=>{n.stopPropagation(),yt(t,"patch")},className:`p-1 rounded-md ${(l=O.get(t.id))!=null&&l.favoriteId?"text-yellow-500 hover:text-yellow-600":"text-gray-400 hover:text-yellow-500"}`,title:(o=O.get(t.id))!=null&&o.favoriteId?"Remove Favorite":"Add Favorite",children:e.jsx(Vt,{size:16,className:(c=O.get(t.id))!=null&&c.favoriteId?"fill-current":""})}),u&&e.jsxs("button",{onClick:n=>{n.stopPropagation(),y&&y.id===t.id?pe(null):(pe(t),setTimeout(()=>{var h;return(h=je.current)==null?void 0:h.scrollIntoView({behavior:"smooth"})},0))},className:"p-1 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 rounded-md",title:y&&y.id===t.id?"Hide Comments":"View Comments",children:[e.jsx(Ht,{size:16}),e.jsxs("span",{className:"ml-1 text-xs",children:["(",t.comment_count??0,")"]})]}),(i==="admin"||i==="super_admin")&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:n=>{n.stopPropagation(),dt(t)},className:"p-1 text-blue-600 hover:text-blue-800 rounded-md",title:"Edit",children:e.jsx(Xt,{size:16})}),e.jsx("button",{onClick:n=>{n.stopPropagation(),it(t)},className:"p-1 text-red-600 hover:text-red-800 rounded-md",title:"Delete",children:e.jsx(Xe,{size:16})})]})]})}}],We=r.useCallback(()=>{F(1,!0)},[F]),yt=async(t,l)=>{var h,be;if(!u){m("Please log in to manage favorites.");return}const o=O.get(t.id),c=!!(o!=null&&o.favoriteId),n=new Map(O);c?n.set(t.id,{favoriteId:void 0}):n.set(t.id,{favoriteId:-1}),x(n);try{if(c&&typeof(o==null?void 0:o.favoriteId)=="number")await At(t.id,l),P(`"${t.patch_name}" removed from favorites.`),x(q=>{const te=new Map(q);return te.set(t.id,{favoriteId:void 0}),te});else{const q=await $t(t.id,l);x(te=>{const se=new Map(te);return se.set(t.id,{favoriteId:q.id}),se}),P(`"${t.patch_name}" added to favorites.`)}}catch(q){m(((be=(h=q==null?void 0:q.response)==null?void 0:h.data)==null?void 0:be.msg)||q.message||"Failed to update favorite."),x(te=>{const se=new Map(te);return c?se.set(t.id,{favoriteId:o==null?void 0:o.favoriteId}):se.set(t.id,{favoriteId:void 0}),se})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-start sm:items-center mb-6 flex-col sm:flex-row",children:[e.jsxs("div",{children:[" ",e.jsx("h2",{className:"text-2xl font-bold text-gray-800 dark:text-white",children:"Patches"})," ",e.jsx("p",{className:"text-gray-600 mt-1 dark:text-gray-300",children:"Browse and manage software patches."})," "]}),u&&(i==="admin"||i==="super_admin")&&!k&&e.jsxs("button",{onClick:me?qe:nt,className:"mt-4 sm:mt-0 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx(Ot,{size:18,className:"mr-2"})," ",me?"Cancel":"Add New Patch"]})]}),me&&e.jsxs("div",{className:"my-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow",children:[" ",e.jsx(ts,{patchToEdit:k,onPatchAdded:()=>Oe(),onPatchUpdated:()=>Oe(),onCancelEdit:qe})," "]}),v.size>0&&e.jsx("div",{className:"my-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:[v.size," item(s) selected"]}),(i==="admin"||i==="super_admin")&&e.jsxs("button",{onClick:gt,disabled:Me,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-800 focus:ring-red-500 disabled:opacity-50",children:[e.jsx(Xe,{size:14,className:"mr-1.5"}),"Delete"]}),u&&e.jsxs("button",{onClick:xt,disabled:et,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-green-500 hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 focus:ring-green-500 disabled:opacity-50",children:[e.jsx(De,{size:14,className:"mr-1.5"}),"Download"]}),(i==="admin"||i==="super_admin")&&e.jsxs("button",{onClick:ht,disabled:Q,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 focus:ring-blue-500 disabled:opacity-50",children:[e.jsx(qt,{size:14,className:"mr-1.5"}),"Move"]})]})}),G.length>0&&e.jsx(Kt,{software:G,selectedSoftwareId:w,onSelectFilter:at}),e.jsx("div",{className:"my-4",children:e.jsxs("button",{onClick:()=>Ne(t=>!t),className:"flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-md text-sm font-medium",children:[U?e.jsxs(e.Fragment,{children:[e.jsx(Yt,{size:18,className:"mr-2"}),"Hide"]}):e.jsxs(e.Fragment,{children:[e.jsx(Tt,{size:18,className:"mr-2"}),"Show"]})," Advanced Filters"]})}),U&&e.jsxs("div",{className:"my-4 p-4 border dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 space-y-4 md:space-y-0 md:flex md:flex-wrap md:items-end md:gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"patchedByDevFilter",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Developer"}),e.jsx("input",{id:"patchedByDevFilter",type:"text",value:D,onChange:t=>R(t.target.value),placeholder:"e.g., Main Dev",className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Released"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"date",value:C,onChange:t=>T(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"to"}),e.jsx("input",{type:"date",value:W,onChange:t=>V(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"})]})]}),e.jsxs("div",{className:"flex items-end gap-2 pt-5",children:[e.jsx("button",{onClick:st,className:"text-sm px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"Apply"}),e.jsx("button",{onClick:rt,className:"text-sm px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500",children:"Clear"})]})]}),E?e.jsx("div",{className:"py-10",children:e.jsx(Ft,{message:"Loading patches..."})}):ce&&g.length===0&&!E?e.jsx(Qt,{message:ce,onRetry:We}):!E&&!ce&&g.length===0?e.jsxs("div",{className:"text-center py-10 bg-white dark:bg-gray-800 rounded-lg shadow-sm my-6",children:[e.jsx(Pt,{size:48,className:"mx-auto text-yellow-500 dark:text-yellow-400 mb-4"}),e.jsx("p",{className:"text-xl font-semibold text-gray-700 dark:text-gray-200 mb-3",children:Ce?"No Patches Found Matching Criteria":"No Patches Available"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 px-4",children:Ce?"Try adjusting or clearing your search/filter settings.":i==="admin"||i==="super_admin"?"Add new patches to get started.":"Please check back later."}),Ce&&e.jsx("button",{onClick:tt,className:"mt-6 btn-primary text-sm",children:"Clear All Filters & Search"})]}):e.jsx(Zt,{columns:bt,data:Te,rowClassName:"group",isLoading:E||fe,currentPage:le,totalPages:oe,onPageChange:ot,itemsPerPage:X,totalItems:Y,sortColumn:z,sortOrder:S,onSort:lt,isSelectionEnabled:!0,selectedItemIds:v,onSelectItem:mt,onSelectAllItems:ut}),K&&$&&e.jsx(Ye,{isOpen:K,title:"Delete Patch",message:`Delete "${$.patch_name}"?`,onConfirm:ct,onCancel:Ve,isConfirming:fe,confirmButtonText:"Delete",confirmButtonVariant:"danger"}),Re&&e.jsx(Ye,{isOpen:Re,title:`Delete ${v.size} Patch(es)`,message:`Delete ${v.size} selected items?`,onConfirm:ft,onCancel:()=>Fe(!1),isConfirming:Me,confirmButtonText:"Delete Selected",confirmButtonVariant:"danger"}),Ue&&e.jsx(Gt,{isOpen:Ue,onClose:()=>ve(!1),title:`Move ${v.size} Patch(es)`,children:e.jsxs("div",{className:"p-4",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mb-2",children:"Select target Software and Version:"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"modalSoftwareMove",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Target Software"}),e.jsxs("select",{id:"modalSoftwareMove",value:ee??"",onChange:t=>{_e(t.target.value?parseInt(t.target.value):null),Se(null)},className:"input-class w-full dark:bg-gray-700 dark:text-white dark:border-gray-600",disabled:Q||G.length===0,children:[e.jsx("option",{value:"",children:"Select Software..."}),G.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),ee&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"modalVersionMove",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Target Version"}),e.jsxs("select",{id:"modalVersionMove",value:we??"",onChange:t=>Se(t.target.value?parseInt(t.target.value):null),className:"input-class w-full dark:bg-gray-700 dark:text-white dark:border-gray-600",disabled:Q||Pe||Ie.length===0,children:[e.jsx("option",{value:"",children:Pe?"Loading...":"Select Version..."}),Ie.map(t=>e.jsx("option",{value:t.id,children:t.version_number},t.id))]}),Ie.length===0&&!Pe&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:"No versions for selected software."})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[e.jsx("button",{type:"button",onClick:()=>ve(!1),className:"px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500",disabled:Q,children:"Cancel"}),e.jsx("button",{type:"button",onClick:pt,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",disabled:Q||!ee||!we,children:Q?"Moving...":"Confirm Move"})]})]})}),u&&y&&e.jsxs("div",{ref:je,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("h3",{className:"text-xl font-semibold text-gray-800 dark:text-white mb-4",children:["Comments for: ",e.jsx("span",{className:"font-bold text-blue-600 dark:text-blue-400",children:y.patch_name})]}),e.jsx(Wt,{itemId:y.id,itemType:"patch",onCommentAction:We})]}),!u&&y&&e.jsx("div",{ref:je,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 text-center",children:e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Please log in to view and manage comments."})})]})};export{ds as default};
