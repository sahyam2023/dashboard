import{r,u as Ge,f as Je,Q as fe,t as Ke,j as e,L as wt,F as He,X as vt,v as St,w as jt,x as Nt,y as _t,g as It,h as Ft,z as Pt,s as y,k as Ct,P as Dt,d as E,l as Vt,S as Mt,A as At,n as Lt,o as Ut,p as $t,q as Bt}from"./index-BSnU4HNS.js";import{u as Rt,U as zt,o as Et,c as Ot,a as B,b as qt,P as Tt,T as Xe,D as De,M as Wt,F as Ht,C as Xt,e as Yt,d as Zt}from"./CommentSection-OJZY9QkH.js";import{C as Gt,D as Jt,M as Kt}from"./Modal-DsBUiQmQ.js";import{F as Qt}from"./FilterTabs-D9AdcAje.js";import{E as es}from"./ErrorState--UO01ITl.js";import{C as Ye}from"./ConfirmationModal-DCUrN4Ud.js";const Ze=()=>{const s=new Date,h=s.getFullYear(),m=String(s.getMonth()+1).padStart(2,"0"),N=String(s.getDate()).padStart(2,"0");return`${h}-${m}-${N}`},G="CREATE_NEW_VERSION_SENTINEL_VALUE",ts=Ot().shape({selectedSoftwareId:B().required("Software Product must be selected."),selectedVersionId:B().required("Version selection is required."),typedVersionString:B().when("selectedVersionId",{is:G,then:s=>s.required("New Version String is required when 'Enter New Version' is selected.").min(1),otherwise:s=>s.transform(h=>h===""?void 0:h).optional().nullable()}),patchName:B().required("Patch Name is required.").max(255,"Patch Name cannot exceed 255 characters."),releaseDate:B().transform(s=>s===""?void 0:s).optional().nullable(),inputMode:B().oneOf(["url","upload"]).required("Input mode must be selected."),externalUrl:B().when("inputMode",{is:"url",then:s=>s.required("External Download URL is required.").url("Please enter a valid URL."),otherwise:s=>s.optional().nullable()}),selectedFile:qt().when(["inputMode","$isEditMode","$patchToEditIsExternal"],{is:(s,h,m)=>s!=="upload"?!1:!!(!h||h&&m),then:s=>s.required("Please select a file to upload.").test("filePresent","File is required for upload.",h=>!!h),otherwise:s=>s.nullable()}),description:B().transform(s=>s===""?void 0:s).optional().max(2e3,"Description cannot exceed 2000 characters.").nullable(),patch_by_developer:B().transform(s=>s===""?void 0:s).optional().max(255,"Patch developer name cannot exceed 255 characters.").nullable()}),ss=({patchToEdit:s,onPatchAdded:h,onPatchUpdated:m,onCancelEdit:N})=>{const d=!!s,{register:u,handleSubmit:le,control:J,formState:{errors:i},watch:w,setValue:p,reset:P}=Rt({resolver:Et(ts),context:{isEditMode:d,patchToEditIsExternal:(s==null?void 0:s.is_external_link)||!1},defaultValues:{selectedSoftwareId:"",selectedVersionId:"",typedVersionString:"",patchName:"",releaseDate:Ze(),description:"",inputMode:"url",externalUrl:"",selectedFile:null,patch_by_developer:""}}),[O,q]=r.useState([]),[C,D]=r.useState([]),[R,_]=r.useState(null),[f,T]=r.useState(!1),[W,V]=r.useState(!1),M=r.useRef(null),{isAuthenticated:K,user:oe}=Ge(),A=oe==null?void 0:oe.role,j=w("selectedSoftwareId"),we=w("selectedVersionId"),ne=w("inputMode"),L=w("selectedFile"),Q=we===G;r.useEffect(()=>{K&&(A==="admin"||A==="super_admin")&&(V(!0),Je().then(q).catch(()=>fe.error("Failed to load software list.")).finally(()=>V(!1)))},[K,A]),r.useEffect(()=>{j?(V(!0),D([]),p("selectedVersionId",""),p("typedVersionString",""),Ke(parseInt(j)).then(D).catch(()=>fe.error("Failed to load versions.")).finally(()=>V(!1))):(D([]),p("selectedVersionId",""),p("typedVersionString",""))},[j,p]),r.useEffect(()=>{if(d&&s){const a={selectedSoftwareId:s.software_id.toString(),patchName:s.patch_name,releaseDate:s.release_date?s.release_date.split("T")[0]:"",description:s.description||"",inputMode:s.is_external_link?"url":"upload",externalUrl:s.is_external_link?s.download_link:"",patch_by_developer:s.patch_by_developer||""};s.version_id&&s.software_id.toString()===j&&C.length>0?C.find(I=>I.id===s.version_id)?(a.selectedVersionId=s.version_id.toString(),a.typedVersionString=s.version_number):(a.selectedVersionId=G,a.typedVersionString=s.version_number):s.version_number&&(a.selectedVersionId=G,a.typedVersionString=s.version_number),P(a),s.is_external_link?_(null):_(s.original_filename_ref||s.download_link.split("/").pop()||"unknown_file"),p("selectedFile",null),M.current&&(M.current.value="")}else d||U(!!j)},[d,s,C,j,P,p]);const U=(a=!1)=>{const S=a?w("selectedSoftwareId"):"";P({selectedSoftwareId:S,selectedVersionId:"",typedVersionString:"",patchName:"",releaseDate:Ze(),description:"",inputMode:"url",externalUrl:"",selectedFile:null,patch_by_developer:""}),_(null),M.current&&(M.current.value="")},ve=a=>{a.target.files&&a.target.files[0]?(p("selectedFile",a.target.files[0],{shouldValidate:!0,shouldDirty:!0}),_(null)):p("selectedFile",null,{shouldValidate:!0,shouldDirty:!0})},H=()=>{p("selectedFile",null,{shouldValidate:!0,shouldDirty:!0}),M.current&&(M.current.value=""),d&&s&&!s.is_external_link&&_(s.original_filename_ref||s.download_link.split("/").pop()||"unknown_file")},Se=async a=>{var Y,de,Z,ie,ce,$;T(!0);let S,I;a.selectedVersionId===G&&a.typedVersionString?I=a.typedVersionString.trim():a.selectedVersionId&&a.selectedVersionId!==G&&(S=parseInt(a.selectedVersionId));const X={software_id:parseInt(a.selectedSoftwareId),patch_name:a.patchName.trim(),description:((Y=a.description)==null?void 0:Y.trim())||void 0,release_date:a.releaseDate||void 0,patch_by_developer:((de=a.patch_by_developer)==null?void 0:de.trim())||void 0};S&&(X.version_id=S),I&&(X.typed_version_string=I);try{let v;if(a.inputMode==="url"){const x={...X,download_link:a.externalUrl.trim(),is_external_link:!0};d&&s?v=await St(s.id,x):v=await jt(x)}else{const x=new FormData;x.append("software_id",a.selectedSoftwareId),S&&x.append("version_id",S.toString()),I&&x.append("typed_version_string",I),x.append("patch_name",a.patchName.trim()),a.releaseDate&&x.append("release_date",a.releaseDate),(Z=a.description)!=null&&Z.trim()&&x.append("description",a.description.trim()),(ie=a.patch_by_developer)!=null&&ie.trim()&&x.append("patch_by_developer",a.patch_by_developer.trim()),a.selectedFile&&x.append("file",a.selectedFile),d&&s?v=await Nt(s.id,x):v=await _t(x)}fe.success(`Patch "${v.patch_name}" ${d?"updated":"added"} successfully!`),d||(U(!0),p("selectedVersionId",""),p("typedVersionString","")),d&&m&&m(v),!d&&h&&h(v)}catch(v){const x=(($=(ce=v.response)==null?void 0:ce.data)==null?void 0:$.msg)||v.message||`Failed to ${d?"update":"add"} patch.`;fe.error(x)}finally{T(!1)}},ee=a=>{console.error("Form validation errors:",a),fe.error("Please correct the errors highlighted in the form.")};return!K||!A||!["admin","super_admin"].includes(A)?null:e.jsxs("form",{onSubmit:le(Se,ee),className:"space-y-6 bg-white dark:bg-gray-800 dark:border-gray-700 p-6 rounded-lg shadow-md border border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-800 dark:text-gray-100",children:d?"Edit Patch":"Add New Patch"}),d&&N&&e.jsx("button",{type:"button",onClick:N,className:"text-sm text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200",children:"Cancel"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedSoftwareId",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Software Product*"}),W&&!O.length?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading software..."}):e.jsxs("select",{id:"selectedSoftwareId",...u("selectedSoftwareId"),disabled:f||W&&!O.length,className:`mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${i.selectedSoftwareId?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",disabled:!0,children:"Select Software Product"}),O.map(a=>e.jsx("option",{value:a.id.toString(),children:a.name},a.id))]}),i.selectedSoftwareId&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:i.selectedSoftwareId.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedVersionId",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Version*"}),e.jsx("div",{className:"mt-1",children:e.jsxs("select",{id:"selectedVersionId",...u("selectedVersionId"),disabled:f||W||!j,className:`block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md ${i.selectedVersionId?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`,children:[e.jsx("option",{value:"",disabled:C.length>0&&!!j,children:W&&j?"Loading versions...":"Select Existing Version"}),C.map(a=>e.jsx("option",{value:a.id.toString(),children:a.version_number},a.id)),e.jsx("option",{value:G,children:"Enter New Version String..."})]})}),Q&&e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{htmlFor:"typedVersionString",className:"block text-xs font-medium text-gray-600 dark:text-gray-400",children:"New Version String*:"}),e.jsx("input",{type:"text",id:"typedVersionString",...u("typedVersionString"),placeholder:"e.g., 2.5.1-hotfix",className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${i.typedVersionString?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"This version will be created for the selected software if it doesn't exist."})]}),i.selectedVersionId&&!Q&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.selectedVersionId.message}),i.typedVersionString&&Q&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.typedVersionString.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"patchName",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Patch Name*"}),e.jsx("input",{type:"text",id:"patchName",...u("patchName"),disabled:f,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${i.patchName?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),i.patchName&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.patchName.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"releaseDate",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Release Date"}),e.jsx("input",{type:"date",id:"releaseDate",...u("releaseDate"),disabled:f,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${i.releaseDate?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600`}),i.releaseDate&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.releaseDate.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"patch_by_developer",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Patch By Developer"}),e.jsx("input",{type:"text",id:"patch_by_developer",...u("patch_by_developer"),disabled:f,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${i.patch_by_developer?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),i.patch_by_developer&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.patch_by_developer.message})]}),e.jsxs("div",{className:"my-4",children:[e.jsx("span",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Patch Source:"}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",...u("inputMode"),value:"url",className:"form-radio h-4 w-4 text-blue-600",disabled:f}),e.jsxs("span",{className:"flex items-center dark:text-gray-300",children:[e.jsx(wt,{size:16,className:"mr-1 text-gray-600 dark:text-gray-400"}),"Provide External Link"]})]}),e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"radio",...u("inputMode"),value:"upload",className:"form-radio h-4 w-4 text-blue-600",disabled:f}),e.jsxs("span",{className:"flex items-center dark:text-gray-300",children:[e.jsx(zt,{size:16,className:"mr-1 text-gray-600 dark:text-gray-400"}),"Upload File"]})]})]}),i.inputMode&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.inputMode.message})]}),ne==="url"&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"externalUrl",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"External Download URL*"}),e.jsx("input",{type:"url",id:"externalUrl",...u("externalUrl"),placeholder:"https://example.com/patch.exe",disabled:f,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${i.externalUrl?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),i.externalUrl&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.externalUrl.message})]}),ne==="upload"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:d&&R&&!L?"Replace File (Optional)":"Select File to Upload*"}),e.jsx("div",{className:"mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-blue-500 dark:border-gray-600 dark:hover:border-blue-400 transition-colors",children:e.jsxs("div",{className:"space-y-1 text-center",children:[e.jsx(He,{className:"mx-auto h-12 w-12 text-gray-400 dark:text-gray-500"}),e.jsxs("div",{className:"flex text-sm text-gray-600 dark:text-gray-400",children:[e.jsxs("label",{htmlFor:"patch-file-upload-input",className:"relative cursor-pointer bg-white dark:bg-gray-800 rounded-md font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500",children:[e.jsx("span",{children:L?"Change file":"Upload a file"}),e.jsx("input",{id:"patch-file-upload-input",name:"patch-file-input",type:"file",className:"sr-only",onChange:ve,ref:M,disabled:f})]}),e.jsx("p",{className:"pl-1",children:"or drag and drop"})]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"EXE, MSI, ZIP, etc."})]})}),(L||d&&R)&&e.jsxs("div",{className:"mt-3 flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md",children:[e.jsxs("div",{className:"flex items-center space-x-2 overflow-hidden",children:[e.jsx(He,{size:18,className:"text-gray-500 dark:text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:L?L.name:R}),d&&R&&!L&&e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 ml-2",children:"(current)"})]}),L&&e.jsx("button",{type:"button",onClick:H,disabled:f,className:"p-1 rounded-full text-gray-400 hover:text-gray-600 hover:bg-gray-200 dark:text-gray-500 dark:hover:text-gray-300 dark:hover:bg-gray-600",children:e.jsx(vt,{size:16})})]}),i.selectedFile&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.selectedFile.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Description"}),e.jsx("textarea",{id:"description",rows:3,...u("description"),disabled:f,className:`mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 ${i.description?"border-red-500":""} dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600 dark:placeholder-gray-400`}),i.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.description.message})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{type:"submit",disabled:f||W,className:"flex-1 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",children:f?d?"Updating...":"Adding...":d?"Update Patch":"Add Patch"}),d&&N&&e.jsx("button",{type:"button",onClick:N,disabled:f,className:"flex-1 inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 dark:border-gray-500 dark:text-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600",children:"Cancel"})]})]})},is=()=>{const{searchTerm:s,setSearchTerm:h}=It(),{isAuthenticated:m,user:N}=Ge(),d=N==null?void 0:N.role,[u,le]=r.useState([]),[J,i]=r.useState([]),[w,p]=r.useState(null),[P,O]=r.useState(""),[q,C]=r.useState(""),[D,R]=r.useState(""),[_,f]=r.useState(""),[T,W]=r.useState(""),[V,M]=r.useState(""),[K,oe]=r.useState(1),[A,j]=r.useState(15),[we,ne]=r.useState(0),[L,Q]=r.useState(0),[U,ve]=r.useState("patch_name"),[H,Se]=r.useState("asc"),[ee,a]=r.useState(!0),[S,I]=r.useState(null),[X,Y]=r.useState(!1),[de,Z]=r.useState(null),[ie,ce]=r.useState(!1),[$,v]=r.useState(null),[x,Ve]=r.useState(!1),[me,ue]=r.useState(new Map),[Me,Qe]=r.useState(!1),[k,xe]=r.useState(new Set),[Ae,Le]=r.useState(!1),[et,Ue]=r.useState(!1),[te,$e]=r.useState(!1),[Be,pe]=r.useState(!1),[se,je]=r.useState(null),[Ne,Re]=r.useState([]),[be,ye]=r.useState(null),[ze,_e]=r.useState(!1),[Ie,Ee]=r.useState(!1),[b,ge]=r.useState(null),ke=r.useRef(null),Oe=Ft(),Fe=r.useMemo(()=>w!==null||P!==""||q!==""||D!==""||s!=="",[w,P,q,D,s]),tt=r.useCallback(()=>{p(null),O(""),C(""),R(""),h&&h("")},[h]),st=()=>{F(1,!0)},rt=()=>{O(""),C(""),R("")},F=r.useCallback(async(t,o=!1)=>{var l,c;o&&a(!0),I(null);try{const n=await Pt(w??void 0,t,A,U,H,_||void 0,T||void 0,V||void 0);le(n.patches),ne(n.total_pages),Q(n.total_patches),oe(n.page),j(n.per_page);const g=new Map;if(m&&n.patches)for(const he of n.patches)g.set(he.id,{favoriteId:he.favorite_id});ue(g)}catch(n){const g=((c=(l=n.response)==null?void 0:l.data)==null?void 0:c.msg)||n.message||"Failed to fetch patches.";o?(I(g),le([]),ne(0),Q(0)):y(g)}finally{o&&a(!1)}},[w,A,U,H,_,T,V,m]);r.useEffect(()=>{const t=setTimeout(()=>f(P),500);return()=>clearTimeout(t)},[P]),r.useEffect(()=>{const t=setTimeout(()=>W(q),500);return()=>clearTimeout(t)},[q]),r.useEffect(()=>{const t=setTimeout(()=>M(D),500);return()=>clearTimeout(t)},[D]),r.useEffect(()=>{m?F(1,!0):(le([]),a(!1))},[m,w,U,H,_,T,V,s,F]),r.useEffect(()=>{const t=new URLSearchParams(Oe.search),o=t.get("item_id"),l=t.get("comment_id");if(o&&l&&u.length>0){const c=parseInt(o,10);if(!isNaN(c)){const n=u.find(g=>g.id===c);n?((!b||b.id!==n.id)&&ge(n),setTimeout(()=>{var g;(g=ke.current)==null||g.scrollIntoView({behavior:"smooth",block:"center"})},100)):console.warn(`PatchesView: Patch with item_id ${c} not found in the current list.`)}}},[Oe.search,u,b]),r.useEffect(()=>{xe(new Set)},[w,U,H,_,T,V,s,K]),r.useEffect(()=>{m&&Je().then(i).catch(t=>y("Failed to load software list."))},[m]),r.useEffect(()=>{se?(Ee(!0),Ke(se).then(Re).catch(()=>y("Failed to load versions for move target.")).finally(()=>Ee(!1))):Re([])},[se]);const at=t=>p(t),lt=t=>{ve(t),Se(o=>U===t&&o==="asc"?"desc":"asc")},ot=t=>F(t,!0),qe=t=>{Y(!1),Z(null),E(t),F(1,!0)},nt=()=>{Z(null),Y(!0)},dt=t=>{Z(t),Y(!0)},Te=()=>{Z(null),Y(!1)},it=t=>{v(t),ce(!0)},Pe=()=>{v(null),ce(!1)},ct=async()=>{if($){Ve(!0),b&&b.id===$.id&&ge(null);try{await At($.id),E(`Patch "${$.patch_name}" deleted.`),Pe(),F(1,!0)}catch(t){y(t.message||"Delete failed."),Pe()}finally{Ve(!1)}}},We=r.useMemo(()=>{if(!s)return u;const t=s.toLowerCase();return u.filter(o=>o.patch_name.toLowerCase().includes(t)||(o.description||"").toLowerCase().includes(t)||(o.software_name||"").toLowerCase().includes(t)||(o.version_number||"").toLowerCase().includes(t))},[u,s]),mt=(t,o)=>xe(l=>{const c=new Set(l);return o?c.add(t):c.delete(t),c}),ut=t=>{const o=new Set;t&&We.forEach(l=>o.add(l.id)),xe(o)},xt=()=>{if(k.size===0){y("No items selected.");return}_e(!0)},gt=async()=>{_e(!1),Le(!0),b&&k.has(b.id)&&ge(null);try{const t=await Lt(Array.from(k),"patch");E(t.msg||`${t.deleted_count} patch(es) deleted.`),xe(new Set),F(1,!0)}catch(t){y(t.message||"Bulk delete failed.")}finally{Le(!1)}},ht=async()=>{if(k.size===0){y("No items selected.");return}const t=u.filter(l=>k.has(l.id)&&!l.is_external_link&&l.is_downloadable!==!1);if(t.length===0){y("No downloadable patch files selected. External links or non-downloadable items cannot be bulk downloaded.");return}const o=t.map(l=>l.id);Ue(!0);try{const l=await Vt(o,"patch"),c=URL.createObjectURL(l),n=document.createElement("a");n.href=c;const g=new Date().toISOString().replace(/:/g,"-");n.download=`bulk_download_patches_${g}.zip`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(c),o.length===k.size?E("Download started for all selected downloadable patches."):E(`Starting download for ${o.length} patch file(s). External links or non-downloadable items were excluded.`)}catch(l){y(l.message||"Bulk download failed.")}finally{Ue(!1)}},ft=()=>{if(k.size===0){y("No items selected.");return}if(J.length===0){y("Software list unavailable.");return}je(null),ye(null),pe(!0)},pt=async()=>{if(!be){y("Select target version.");return}pe(!1),$e(!0);try{const t=await Ut(Array.from(k),"patch",{target_version_id:be});E(t.msg||`${t.moved_count} patch(es) moved.`),xe(new Set),F(1,!0)}catch(t){y(t.message||"Bulk move failed.")}finally{$e(!1),je(null),ye(null)}},Ce=t=>t?new Date(t).toLocaleDateString("en-CA"):"-",bt=[{key:"patch_name",header:"Patch Name",sortable:!0},{key:"software_name",header:"Software",sortable:!0},{key:"version_number",header:"Version",sortable:!0},{key:"patch_by_developer",header:"Developer",sortable:!0,render:t=>t.patch_by_developer||"-"},{key:"description",header:"Description",render:t=>e.jsx("span",{className:"text-sm text-gray-600 block max-w-xs truncate",title:t.description||"",children:t.description||"-"})},{key:"release_date",header:"Release Date",sortable:!0,render:t=>Ce(t.release_date)},{key:"download_link",header:"Link",render:t=>{var l;const o=t.is_external_link||t.is_downloadable!==!1;return!o&&!t.is_external_link?e.jsxs("span",{className:"flex items-center text-gray-400 cursor-not-allowed",title:"Download not permitted",children:[e.jsx(De,{size:14,className:"mr-1"}),"Link"]}):e.jsxs("a",{href:t.download_link,target:t.is_external_link||!((l=t.download_link)!=null&&l.startsWith("/"))?"_blank":"_self",rel:"noopener noreferrer",className:`flex items-center ${o?"text-blue-600 hover:text-blue-800":"text-gray-400 cursor-not-allowed"}`,onClick:c=>{o||c.preventDefault(),c.stopPropagation()},title:o?t.is_external_link?"Open external link":"Download patch":"Download not permitted",children:[e.jsx(De,{size:14,className:"mr-1"}),"Link"]})}},{key:"uploaded_by_username",header:"Uploaded By",sortable:!0,render:t=>t.uploaded_by_username||"N/A"},{key:"updated_by_username",header:"Updated By",sortable:!1,render:t=>t.updated_by_username||"N/A"},{key:"created_at",header:"Created At",sortable:!0,render:t=>Ce(t.created_at)},{key:"updated_at",header:"Updated At",sortable:!0,render:t=>Ce(t.updated_at)},{key:"actions",header:"Actions",render:t=>{var o,l,c;return e.jsxs("div",{className:"flex space-x-1 items-center",children:[m&&e.jsx("button",{onClick:n=>{n.stopPropagation(),kt(t,"patch")},className:`p-1 rounded-md ${(o=me.get(t.id))!=null&&o.favoriteId?"text-yellow-500 hover:text-yellow-600":"text-gray-400 hover:text-yellow-500"}`,title:(l=me.get(t.id))!=null&&l.favoriteId?"Remove Favorite":"Add Favorite",children:e.jsx(Mt,{size:16,className:(c=me.get(t.id))!=null&&c.favoriteId?"fill-current":""})}),m&&e.jsxs("button",{onClick:n=>{n.stopPropagation(),b&&b.id===t.id?ge(null):(ge(t),setTimeout(()=>{var g;return(g=ke.current)==null?void 0:g.scrollIntoView({behavior:"smooth"})},0))},className:"p-1 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 rounded-md",title:b&&b.id===t.id?"Hide Comments":"View Comments",children:[e.jsx(Yt,{size:16}),e.jsxs("span",{className:"ml-1 text-xs",children:["(",t.comment_count??0,")"]})]}),(d==="admin"||d==="super_admin")&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:n=>{n.stopPropagation(),dt(t)},className:"p-1 text-blue-600 hover:text-blue-800 rounded-md",title:"Edit",children:e.jsx(Zt,{size:16})}),e.jsx("button",{onClick:n=>{n.stopPropagation(),it(t)},className:"p-1 text-red-600 hover:text-red-800 rounded-md",title:"Delete",children:e.jsx(Xe,{size:16})})]})]})}}],yt=r.useCallback(()=>{F(1,!0)},[F]),kt=async(t,o)=>{var g,he;if(!m){y("Please log in to manage favorites.");return}const l=me.get(t.id),c=!!(l!=null&&l.favoriteId),n=new Map(me);c?n.set(t.id,{favoriteId:void 0}):n.set(t.id,{favoriteId:-1}),ue(n);try{if(c&&typeof(l==null?void 0:l.favoriteId)=="number")await $t(t.id,o),E(`"${t.patch_name}" removed from favorites.`),ue(z=>{const re=new Map(z);return re.set(t.id,{favoriteId:void 0}),re});else{const z=await Bt(t.id,o);ue(re=>{const ae=new Map(re);return ae.set(t.id,{favoriteId:z.id}),ae}),E(`"${t.patch_name}" added to favorites.`)}}catch(z){y(((he=(g=z==null?void 0:z.response)==null?void 0:g.data)==null?void 0:he.msg)||z.message||"Failed to update favorite."),ue(re=>{const ae=new Map(re);return c?ae.set(t.id,{favoriteId:l==null?void 0:l.favoriteId}):ae.set(t.id,{favoriteId:void 0}),ae})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-start sm:items-center mb-6 flex-col sm:flex-row",children:[e.jsxs("div",{children:[" ",e.jsx("h2",{className:"text-2xl font-bold text-gray-800 dark:text-white",children:"Patches"})," ",e.jsx("p",{className:"text-gray-600 mt-1 dark:text-gray-300",children:"Browse and manage software patches."})," "]}),m&&(d==="admin"||d==="super_admin")&&!de&&e.jsxs("button",{onClick:X?Te:nt,className:"mt-4 sm:mt-0 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx(Tt,{size:18,className:"mr-2"})," ",X?"Cancel":"Add New Patch"]})]}),X&&e.jsxs("div",{className:"my-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow",children:[" ",e.jsx(ss,{patchToEdit:de,onPatchAdded:()=>qe("Patch added."),onPatchUpdated:()=>qe("Patch updated."),onCancelEdit:Te})," "]}),k.size>0&&e.jsx("div",{className:"my-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:[k.size," item(s) selected"]}),(d==="admin"||d==="super_admin")&&e.jsxs("button",{onClick:xt,disabled:Ae,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-800 focus:ring-red-500 disabled:opacity-50",children:[e.jsx(Xe,{size:14,className:"mr-1.5"}),"Delete"]}),m&&e.jsxs("button",{onClick:ht,disabled:et,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-green-500 hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 focus:ring-green-500 disabled:opacity-50",children:[e.jsx(De,{size:14,className:"mr-1.5"}),"Download"]}),(d==="admin"||d==="super_admin")&&e.jsxs("button",{onClick:ft,disabled:te,className:"px-3 py-1.5 text-xs font-medium rounded-md shadow-sm flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-white bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 focus:ring-blue-500 disabled:opacity-50",children:[e.jsx(Wt,{size:14,className:"mr-1.5"}),"Move"]})]})}),J.length>0&&e.jsx(Qt,{software:J,selectedSoftwareId:w,onSelectFilter:at}),e.jsx("div",{className:"my-4",children:e.jsxs("button",{onClick:()=>Qe(t=>!t),className:"flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-md text-sm font-medium",children:[Me?e.jsxs(e.Fragment,{children:[e.jsx(Gt,{size:18,className:"mr-2"}),"Hide"]}):e.jsxs(e.Fragment,{children:[e.jsx(Ht,{size:18,className:"mr-2"}),"Show"]})," Advanced Filters"]})}),Me&&e.jsxs("div",{className:"my-4 p-4 border dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 space-y-4 md:space-y-0 md:flex md:flex-wrap md:items-end md:gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"patchedByDevFilter",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Developer"}),e.jsx("input",{id:"patchedByDevFilter",type:"text",value:D,onChange:t=>R(t.target.value),placeholder:"e.g., Main Dev",className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Released"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"date",value:P,onChange:t=>O(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"to"}),e.jsx("input",{type:"date",value:q,onChange:t=>C(t.target.value),className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"})]})]}),e.jsxs("div",{className:"flex items-end gap-2 pt-5",children:[e.jsx("button",{onClick:st,className:"text-sm px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"Apply"}),e.jsx("button",{onClick:rt,className:"text-sm px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500",children:"Clear"})]})]}),ee?e.jsx("div",{className:"py-10",children:e.jsx(Ct,{message:"Loading patches..."})}):S&&u.length===0&&!ee?e.jsx(es,{message:S,onRetry:yt}):!ee&&!S&&u.length===0?e.jsxs("div",{className:"text-center py-10 bg-white dark:bg-gray-800 rounded-lg shadow-sm my-6",children:[e.jsx(Dt,{size:48,className:"mx-auto text-yellow-500 dark:text-yellow-400 mb-4"}),e.jsx("p",{className:"text-xl font-semibold text-gray-700 dark:text-gray-200 mb-3",children:Fe?"No Patches Found Matching Criteria":"No Patches Available"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 px-4",children:Fe?"Try adjusting or clearing your search/filter settings.":d==="admin"||d==="super_admin"?"Add new patches to get started.":"Please check back later."}),Fe&&e.jsx("button",{onClick:tt,className:"mt-6 btn-primary text-sm",children:"Clear All Filters & Search"})]}):e.jsx(Jt,{columns:bt,data:We,rowClassName:"group",isLoading:ee||x,currentPage:K,totalPages:we,onPageChange:ot,itemsPerPage:A,totalItems:L,sortColumn:U,sortOrder:H,onSort:lt,isSelectionEnabled:!0,selectedItemIds:k,onSelectItem:mt,onSelectAllItems:ut}),ie&&$&&e.jsx(Ye,{isOpen:ie,title:"Delete Patch",message:`Delete "${$.patch_name}"?`,onConfirm:ct,onCancel:Pe,isConfirming:x,confirmButtonText:"Delete",confirmButtonVariant:"danger"}),ze&&e.jsx(Ye,{isOpen:ze,title:`Delete ${k.size} Patch(es)`,message:`Delete ${k.size} selected items?`,onConfirm:gt,onCancel:()=>_e(!1),isConfirming:Ae,confirmButtonText:"Delete Selected",confirmButtonVariant:"danger"}),Be&&e.jsx(Kt,{isOpen:Be,onClose:()=>pe(!1),title:`Move ${k.size} Patch(es)`,children:e.jsxs("div",{className:"p-4",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mb-2",children:"Select target Software and Version:"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"modalSoftwareMove",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Target Software"}),e.jsxs("select",{id:"modalSoftwareMove",value:se??"",onChange:t=>{je(t.target.value?parseInt(t.target.value):null),ye(null)},className:"input-class w-full dark:bg-gray-700 dark:text-white dark:border-gray-600",disabled:te||J.length===0,children:[e.jsx("option",{value:"",children:"Select Software..."}),J.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),se&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"modalVersionMove",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Target Version"}),e.jsxs("select",{id:"modalVersionMove",value:be??"",onChange:t=>ye(t.target.value?parseInt(t.target.value):null),className:"input-class w-full dark:bg-gray-700 dark:text-white dark:border-gray-600",disabled:te||Ie||Ne.length===0,children:[e.jsx("option",{value:"",children:Ie?"Loading...":"Select Version..."}),Ne.map(t=>e.jsx("option",{value:t.id,children:t.version_number},t.id))]}),Ne.length===0&&!Ie&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:"No versions for selected software."})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[e.jsx("button",{type:"button",onClick:()=>pe(!1),className:"btn-secondary",disabled:te,children:"Cancel"}),e.jsx("button",{type:"button",onClick:pt,className:"btn-primary",disabled:te||!se||!be,children:te?"Moving...":"Confirm Move"})]})]})}),m&&b&&e.jsxs("div",{ref:ke,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("h3",{className:"text-xl font-semibold text-gray-800 dark:text-white mb-4",children:["Comments for: ",e.jsx("span",{className:"font-bold text-blue-600 dark:text-blue-400",children:b.patch_name})]}),e.jsx(Xt,{itemId:b.id,itemType:"patch"})]}),!m&&b&&e.jsx("div",{ref:ke,className:"mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 text-center",children:e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Please log in to view and manage comments."})})]})};export{is as default};
